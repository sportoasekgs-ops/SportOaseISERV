{"file_contents":{"README.md":{"content":"# SportOase - IServ Module\n\nA Symfony-based IServ module for booking school sports facilities with capacity management and admin controls.\n\n## Overview\n\nSportOase is a complete IServ-compatible module built with Symfony 6.4+ that integrates with IServ's authentication system to provide a booking management system for school sports facilities.\n\n## Features\n\n- **IServ SSO Integration** - Automatic user synchronization with IServ accounts\n- **Role-based Access Control** - Teachers can book, admins can manage\n- **Weekly Schedule Management** - View and manage bookings across time periods\n- **Capacity Management** - Automatic enforcement of student limits (default: 5 per slot)\n- **Double-booking Prevention** - Student conflict detection across bookings\n- **Admin Panel** - Comprehensive booking and user management\n- **Email Notifications** - SMTP-based alerts for new bookings\n- **Google Calendar Integration** (Optional) - Automatic calendar event creation\n- **Multi-language Support** - German/English localization ready\n\n## Requirements\n\n- **IServ** 3.0 or higher\n- **PHP** 8.0 or higher\n- **PostgreSQL** database\n- **Symfony** 6.4 or 7.0\n\n## Installation\n\n### 1. Package Installation\n\nAs an IServ module, SportOase should be packaged as a Debian package and installed via the IServ package manager:\n\n```bash\n# On the IServ server\naptitude install iserv3-sportoase\n```\n\n### 2. Database Migration\n\nRun the Doctrine migrations to create the database schema:\n\n```bash\nphp bin/console doctrine:migrations:migrate --no-interaction\n```\n\n### 3. Enable Module\n\nEnable the module in the IServ admin panel under **System → Modules**.\n\n## Module Structure\n\n```\nsportoase/\n├── composer.json              # PHP dependencies\n├── manifest.xml               # IServ module manifest\n├── src/\n│   ├── SportOaseBundle.php    # Main bundle class\n│   ├── Controller/            # Symfony controllers\n│   │   ├── DashboardController.php\n│   │   ├── BookingController.php\n│   │   └── AdminController.php\n│   ├── Entity/                # Doctrine entities\n│   │   ├── User.php\n│   │   ├── Booking.php\n│   │   ├── SlotName.php\n│   │   ├── BlockedSlot.php\n│   │   └── Notification.php\n│   └── Service/               # Business logic\n│       ├── BookingService.php\n│       └── EmailService.php\n├── migrations/                # Doctrine migrations\n│   └── Version001CreateInitialSchema.php\n├── templates/                 # Twig templates\n│   └── sportoase/\n├── config/\n│   ├── routes.yaml           # Route configuration\n│   └── services.yaml         # Service definitions\n└── README.md\n```\n\n## Configuration\n\n### Module Settings\n\nConfigure the module via **IServ Admin → Modules → SportOase**:\n\n- **Max Students per Period** - Maximum students allowed per time slot (default: 5)\n- **Booking Advance Minutes** - Minimum time before slot start for bookings (default: 60)\n- **Enable Email Notifications** - Turn on/off email alerts (default: true)\n- **SMTP Server** - Email server for notifications\n- **SMTP Port** - Email server port (default: 587)\n\n### Time Periods\n\nThe module uses 6 fixed time periods per day (customizable in `BookingService.php`):\n\n1. 07:50 - 08:35\n2. 08:35 - 09:20\n3. 09:40 - 10:25\n4. 10:30 - 11:15\n5. 11:20 - 12:05\n6. 12:10 - 12:55\n\n## Usage\n\n### For Teachers\n\n1. Navigate to **SportOase** in the IServ main menu\n2. View the weekly schedule with available and booked slots\n3. Click on an available slot to create a booking\n4. Enter student names and classes\n5. Submit the booking\n\n### For Administrators\n\n1. Navigate to **SportOase Admin** in the admin menu\n2. View all bookings and users\n3. Edit or delete any booking\n4. Block specific time slots\n5. Manage custom slot names\n\n## Development\n\n### Local Development\n\n```bash\n# Install dependencies\ncomposer install\n\n# Run migrations\nphp bin/console doctrine:migrations:migrate\n\n# Start development server\nsymfony serve\n```\n\n## License\n\nMIT License\n\n## Credits\n\n**Developed by**: SportOase Team  \n**Email**: sportoase.kg@gmail.com  \n**Version**: 1.0.0  \n**Last Updated**: November 22, 2025\n","size_bytes":4250},"models.py":{"content":"# Datenbankmodelle für die SportOase-Anwendung mit Flask-SQLAlchemy\n# Diese Datei definiert die Struktur der Datenbank-Tabellen für PostgreSQL\n\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom datetime import datetime\nimport json\nfrom database import db\n\nclass User(db.Model):\n    \"\"\"Benutzer-Modell für Lehrkräfte und Admins\"\"\"\n    __tablename__ = 'users'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    username = db.Column(db.String(64), unique=True, nullable=False, index=True)\n    email = db.Column(db.String(120))\n    password_hash = db.Column(db.String(256), nullable=False)\n    role = db.Column(db.String(20), nullable=False)\n    \n    bookings = db.relationship('Booking', backref='teacher', lazy=True)\n    \n    def set_password(self, password):\n        \"\"\"Setzt das Passwort (gehasht)\"\"\"\n        self.password_hash = generate_password_hash(password)\n    \n    def check_password(self, password):\n        \"\"\"Überprüft das Passwort\"\"\"\n        return check_password_hash(self.password_hash, password)\n    \n    def to_dict(self):\n        \"\"\"Konvertiert User zu Dictionary für Kompatibilität\"\"\"\n        return {\n            'id': self.id,\n            'username': self.username,\n            'email': self.email,\n            'password_hash': self.password_hash,\n            'role': self.role\n        }\n\nclass Booking(db.Model):\n    \"\"\"Buchungs-Modell\"\"\"\n    __tablename__ = 'bookings'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    date = db.Column(db.String(10), nullable=False, index=True)\n    weekday = db.Column(db.String(3), nullable=False)\n    period = db.Column(db.Integer, nullable=False)\n    teacher_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    teacher_name = db.Column(db.String(100))\n    teacher_class = db.Column(db.String(50))\n    students_json = db.Column(db.Text, nullable=False)\n    offer_type = db.Column(db.String(10), nullable=False)\n    offer_label = db.Column(db.String(100), nullable=False)\n    created_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)\n    \n    notifications = db.relationship('Notification', back_populates='booking', cascade='all, delete-orphan', passive_deletes=True)\n    \n    def to_dict(self):\n        \"\"\"Konvertiert Booking zu Dictionary für Kompatibilität\"\"\"\n        return {\n            'id': self.id,\n            'date': self.date,\n            'weekday': self.weekday,\n            'period': self.period,\n            'teacher_id': self.teacher_id,\n            'teacher_name': self.teacher_name,\n            'teacher_class': self.teacher_class,\n            'students_json': self.students_json,\n            'offer_type': self.offer_type,\n            'offer_label': self.offer_label,\n            'created_at': self.created_at.isoformat() if isinstance(self.created_at, datetime) else self.created_at,\n            'teacher_email': self.teacher.email if self.teacher else None\n        }\n\nclass SlotName(db.Model):\n    \"\"\"Modell für anpassbare Slot-Namen\"\"\"\n    __tablename__ = 'slot_names'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    weekday = db.Column(db.String(3), nullable=False)\n    period = db.Column(db.Integer, nullable=False)\n    label = db.Column(db.String(200), nullable=False)\n    \n    __table_args__ = (\n        db.UniqueConstraint('weekday', 'period', name='unique_weekday_period'),\n    )\n    \n    def to_dict(self):\n        \"\"\"Konvertiert SlotName zu Dictionary\"\"\"\n        return {\n            'id': self.id,\n            'weekday': self.weekday,\n            'period': self.period,\n            'label': self.label\n        }\n\nclass BlockedSlot(db.Model):\n    \"\"\"Modell für von Admins blockierte Slots (z.B. für Beratungsgespräche)\"\"\"\n    __tablename__ = 'blocked_slots'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    date = db.Column(db.String(10), nullable=False, index=True)\n    weekday = db.Column(db.String(3), nullable=False)\n    period = db.Column(db.Integer, nullable=False)\n    reason = db.Column(db.String(200), default='Beratung')\n    blocked_by = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    created_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)\n    \n    __table_args__ = (\n        db.UniqueConstraint('date', 'period', name='unique_date_period_block'),\n    )\n    \n    def to_dict(self):\n        \"\"\"Konvertiert BlockedSlot zu Dictionary\"\"\"\n        return {\n            'id': self.id,\n            'date': self.date,\n            'weekday': self.weekday,\n            'period': self.period,\n            'reason': self.reason,\n            'blocked_by': self.blocked_by,\n            'created_at': self.created_at.isoformat() if isinstance(self.created_at, datetime) else self.created_at\n        }\n\nclass Notification(db.Model):\n    \"\"\"Modell für Benachrichtigungen an Admins\"\"\"\n    __tablename__ = 'notifications'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    booking_id = db.Column(db.Integer, db.ForeignKey('bookings.id', ondelete='CASCADE'), nullable=False, index=True)\n    recipient_role = db.Column(db.String(20), nullable=False, default='admin')\n    notification_type = db.Column(db.String(50), nullable=False, default='new_booking')\n    message = db.Column(db.String(500), nullable=False)\n    is_read = db.Column(db.Boolean, default=False, nullable=False, index=True)\n    read_at = db.Column(db.DateTime, nullable=True)\n    created_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow, index=True)\n    metadata_json = db.Column(db.Text, nullable=True)\n    \n    booking = db.relationship('Booking', back_populates='notifications')\n    \n    def to_dict(self):\n        \"\"\"Konvertiert Notification zu Dictionary\"\"\"\n        metadata = None\n        if self.metadata_json:\n            try:\n                metadata = json.loads(self.metadata_json)\n            except:\n                metadata = None\n        \n        return {\n            'id': self.id,\n            'booking_id': self.booking_id,\n            'recipient_role': self.recipient_role,\n            'notification_type': self.notification_type,\n            'message': self.message,\n            'is_read': self.is_read,\n            'read_at': self.read_at.isoformat() if isinstance(self.read_at, datetime) else self.read_at,\n            'created_at': self.created_at.isoformat() if isinstance(self.created_at, datetime) else self.created_at,\n            'metadata': metadata,\n            'booking': self.booking.to_dict() if self.booking else None\n        }\n\n# Hilfsfunktionen für Kompatibilität mit dem alten Code\n\ndef create_user(username, password, role, email=None):\n    \"\"\"Erstellt einen neuen Benutzer in der Datenbank\"\"\"\n    try:\n        user = User(username=username, email=email, role=role)\n        user.set_password(password)\n        db.session.add(user)\n        db.session.commit()\n        return user.id\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Erstellen des Benutzers: {e}\")\n        return None\n\ndef get_user_by_username(username):\n    \"\"\"Sucht einen Benutzer anhand des Benutzernamens\"\"\"\n    user = User.query.filter_by(username=username).first()\n    return user.to_dict() if user else None\n\ndef get_user_by_email(email):\n    \"\"\"Sucht einen Benutzer anhand der E-Mail-Adresse\"\"\"\n    user = User.query.filter_by(email=email).first()\n    return user.to_dict() if user else None\n\ndef get_user_by_id(user_id):\n    \"\"\"Sucht einen Benutzer anhand der ID\"\"\"\n    user = User.query.get(user_id)\n    return user.to_dict() if user else None\n\ndef verify_password(user_dict, password):\n    \"\"\"Überprüft, ob das eingegebene Passwort korrekt ist\"\"\"\n    user = User.query.get(user_dict['id'])\n    return user.check_password(password) if user else False\n\ndef get_all_users():\n    \"\"\"Gibt alle Benutzer zurück (für Admin-Ansicht)\"\"\"\n    users = User.query.order_by(User.role, User.username).all()\n    return [u.to_dict() for u in users]\n\ndef create_booking(date, weekday, period, teacher_id, students, offer_type, offer_label, teacher_name=None, teacher_class=None):\n    \"\"\"Erstellt eine neue Buchung in der Datenbank\"\"\"\n    try:\n        students_json = json.dumps(students, ensure_ascii=False)\n        booking = Booking(\n            date=date,\n            weekday=weekday,\n            period=period,\n            teacher_id=teacher_id,\n            teacher_name=teacher_name,\n            teacher_class=teacher_class,\n            students_json=students_json,\n            offer_type=offer_type,\n            offer_label=offer_label,\n            created_at=datetime.now()\n        )\n        db.session.add(booking)\n        db.session.commit()\n        return booking.id\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Erstellen der Buchung: {e}\")\n        return None\n\ndef get_bookings_for_date_period(date, period):\n    \"\"\"Gibt alle Buchungen für ein bestimmtes Datum und Stunde zurück\"\"\"\n    bookings = Booking.query.filter_by(date=date, period=period).order_by(Booking.created_at).all()\n    return [b.to_dict() for b in bookings]\n\ndef count_students_for_period(date, period):\n    \"\"\"Zählt die Gesamtzahl der Schüler für eine bestimmte Stunde\"\"\"\n    bookings = get_bookings_for_date_period(date, period)\n    total = 0\n    for booking in bookings:\n        students = json.loads(booking['students_json'])\n        total += len(students)\n    return total\n\ndef check_student_double_booking(student_name, student_class, date, period, exclude_booking_id=None):\n    \"\"\"\n    Prüft, ob ein Schüler bereits für dieses Datum und diese Stunde gebucht ist.\n    \n    Args:\n        student_name: Name des Schülers\n        student_class: Klasse des Schülers\n        date: Datum (YYYY-MM-DD)\n        period: Stunde (1-6)\n        exclude_booking_id: Optional - Buchungs-ID die ausgeschlossen werden soll (für Updates)\n    \n    Returns:\n        Dict mit 'is_booked' (bool) und 'booking_info' (str) oder None\n    \"\"\"\n    bookings = get_bookings_for_date_period(date, period)\n    \n    for booking in bookings:\n        # Überspringe die Buchung, die ausgeschlossen werden soll\n        if exclude_booking_id and booking['id'] == exclude_booking_id:\n            continue\n            \n        students = json.loads(booking['students_json'])\n        \n        # Prüfe ob der Schüler in dieser Buchung ist\n        for student in students:\n            if (student.get('name', '').strip().lower() == student_name.strip().lower() and \n                student.get('klasse', '').strip().lower() == student_class.strip().lower()):\n                \n                return {\n                    'is_booked': True,\n                    'booking_info': f\"{student_name} ({student_class}) ist bereits in '{booking['offer_label']}' bei {booking['teacher_name']} gebucht.\"\n                }\n    \n    return {'is_booked': False, 'booking_info': None}\n\ndef get_all_bookings():\n    \"\"\"Gibt alle Buchungen zurück (für Admin-Ansicht)\"\"\"\n    bookings = Booking.query.order_by(Booking.date.desc(), Booking.period).all()\n    return [b.to_dict() for b in bookings]\n\ndef get_bookings_by_date(date):\n    \"\"\"Gibt alle Buchungen für ein bestimmtes Datum zurück\"\"\"\n    bookings = Booking.query.filter_by(date=date).order_by(Booking.period).all()\n    return [b.to_dict() for b in bookings]\n\ndef get_bookings_for_week(start_date, end_date):\n    \"\"\"Gibt alle Buchungen für eine Woche zurück\"\"\"\n    bookings = Booking.query.filter(Booking.date >= start_date, Booking.date <= end_date).order_by(Booking.date, Booking.period).all()\n    return [b.to_dict() for b in bookings]\n\ndef get_booking_by_id(booking_id):\n    \"\"\"Gibt eine einzelne Buchung anhand der ID zurück\"\"\"\n    booking = Booking.query.get(booking_id)\n    return booking.to_dict() if booking else None\n\ndef update_booking(booking_id, date, weekday, period, teacher_id, students, offer_type, offer_label, teacher_name=None, teacher_class=None):\n    \"\"\"Aktualisiert eine bestehende Buchung in der Datenbank\"\"\"\n    try:\n        booking = Booking.query.get(booking_id)\n        if not booking:\n            return False\n        \n        booking.date = date\n        booking.weekday = weekday\n        booking.period = period\n        booking.teacher_id = teacher_id\n        booking.teacher_name = teacher_name\n        booking.teacher_class = teacher_class\n        booking.students_json = json.dumps(students, ensure_ascii=False)\n        booking.offer_type = offer_type\n        booking.offer_label = offer_label\n        \n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Aktualisieren der Buchung: {e}\")\n        return False\n\ndef delete_booking(booking_id):\n    \"\"\"Löscht eine Buchung aus der Datenbank\"\"\"\n    try:\n        booking = Booking.query.get(booking_id)\n        if not booking:\n            return False\n        \n        db.session.delete(booking)\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Löschen der Buchung: {e}\")\n        return False\n\ndef get_custom_slot_name(weekday, period):\n    \"\"\"Gibt den angepassten Slot-Namen aus der Datenbank zurück\"\"\"\n    slot = SlotName.query.filter_by(weekday=weekday, period=period).first()\n    return slot.label if slot else None\n\ndef update_slot_name(weekday, period, label):\n    \"\"\"Aktualisiert oder erstellt einen angepassten Slot-Namen\"\"\"\n    try:\n        slot = SlotName.query.filter_by(weekday=weekday, period=period).first()\n        if slot:\n            slot.label = label\n        else:\n            slot = SlotName(weekday=weekday, period=period, label=label)\n            db.session.add(slot)\n        \n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Aktualisieren des Slot-Namens: {e}\")\n        return False\n\ndef get_all_custom_slot_names():\n    \"\"\"Gibt alle angepassten Slot-Namen zurück\"\"\"\n    slots = SlotName.query.all()\n    return [s.to_dict() for s in slots]\n\ndef is_slot_blocked(date, period):\n    \"\"\"Prüft, ob ein Slot für ein bestimmtes Datum und Stunde blockiert ist\"\"\"\n    blocked = BlockedSlot.query.filter_by(date=date, period=period).first()\n    return blocked is not None\n\ndef get_blocked_slot(date, period):\n    \"\"\"Gibt den blockierten Slot zurück, falls vorhanden\"\"\"\n    blocked = BlockedSlot.query.filter_by(date=date, period=period).first()\n    return blocked.to_dict() if blocked else None\n\ndef block_slot(date, weekday, period, admin_id, reason='Beratung'):\n    \"\"\"Blockiert einen Slot für Beratungsgespräche (nur Admin)\"\"\"\n    try:\n        if is_slot_blocked(date, period):\n            return False\n        \n        blocked = BlockedSlot(\n            date=date,\n            weekday=weekday,\n            period=period,\n            reason=reason,\n            blocked_by=admin_id,\n            created_at=datetime.now()\n        )\n        db.session.add(blocked)\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Blockieren des Slots: {e}\")\n        return False\n\ndef unblock_slot(date, period):\n    \"\"\"Gibt einen blockierten Slot wieder frei\"\"\"\n    try:\n        blocked = BlockedSlot.query.filter_by(date=date, period=period).first()\n        if not blocked:\n            return False\n        \n        db.session.delete(blocked)\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Freigeben des Slots: {e}\")\n        return False\n\ndef get_blocked_slots_for_date(date):\n    \"\"\"Gibt alle blockierten Slots für ein bestimmtes Datum zurück\"\"\"\n    blocked_slots = BlockedSlot.query.filter_by(date=date).all()\n    return [b.to_dict() for b in blocked_slots]\n\ndef get_blocked_slots_for_week(start_date, end_date):\n    \"\"\"Gibt alle blockierten Slots für eine Woche zurück\"\"\"\n    blocked_slots = BlockedSlot.query.filter(BlockedSlot.date >= start_date, BlockedSlot.date <= end_date).all()\n    return [b.to_dict() for b in blocked_slots]\n\ndef get_all_blocked_slots():\n    \"\"\"Gibt alle blockierten Slots zurück (für Admin-Ansicht)\"\"\"\n    blocked_slots = BlockedSlot.query.order_by(BlockedSlot.date.desc(), BlockedSlot.period).all()\n    return [b.to_dict() for b in blocked_slots]\n\ndef create_notification(booking_id, message, notification_type='new_booking', recipient_role='admin', metadata=None):\n    \"\"\"Erstellt eine neue Benachrichtigung\"\"\"\n    try:\n        metadata_json = json.dumps(metadata, ensure_ascii=False) if metadata else None\n        notification = Notification(\n            booking_id=booking_id,\n            recipient_role=recipient_role,\n            notification_type=notification_type,\n            message=message,\n            metadata_json=metadata_json,\n            is_read=False,\n            created_at=datetime.now()\n        )\n        db.session.add(notification)\n        db.session.commit()\n        return notification.id\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Erstellen der Benachrichtigung: {e}\")\n        return None\n\ndef get_unread_notifications(recipient_role='admin'):\n    \"\"\"Gibt alle ungelesenen Benachrichtigungen zurück\"\"\"\n    notifications = Notification.query.filter_by(recipient_role=recipient_role, is_read=False).order_by(Notification.created_at.desc()).all()\n    return [n.to_dict() for n in notifications]\n\ndef get_recent_notifications(recipient_role='admin', limit=10):\n    \"\"\"Gibt die neuesten Benachrichtigungen zurück (gelesen und ungelesen)\"\"\"\n    notifications = Notification.query.filter_by(recipient_role=recipient_role).order_by(Notification.created_at.desc()).limit(limit).all()\n    return [n.to_dict() for n in notifications]\n\ndef mark_notification_as_read(notification_id):\n    \"\"\"Markiert eine Benachrichtigung als gelesen\"\"\"\n    try:\n        notification = Notification.query.get(notification_id)\n        if not notification:\n            return False\n        notification.is_read = True\n        notification.read_at = datetime.now()\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Markieren der Benachrichtigung: {e}\")\n        return False\n\ndef mark_all_notifications_as_read(recipient_role='admin'):\n    \"\"\"Markiert alle Benachrichtigungen als gelesen\"\"\"\n    try:\n        notifications = Notification.query.filter_by(recipient_role=recipient_role, is_read=False).all()\n        for notification in notifications:\n            notification.is_read = True\n            notification.read_at = datetime.now()\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Markieren aller Benachrichtigungen: {e}\")\n        return False\n\ndef get_unread_notification_count(recipient_role='admin'):\n    \"\"\"Gibt die Anzahl der ungelesenen Benachrichtigungen zurück\"\"\"\n    return Notification.query.filter_by(recipient_role=recipient_role, is_read=False).count()\n\ndef delete_notification(notification_id):\n    \"\"\"Löscht eine Benachrichtigung\"\"\"\n    try:\n        notification = Notification.query.get(notification_id)\n        if not notification:\n            return False\n        db.session.delete(notification)\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Löschen der Benachrichtigung: {e}\")\n        return False\n","size_bytes":19458},"app.py":{"content":"# Haupt-Anwendungsdatei für die SportOase-Buchungssystem\n# Diese Datei enthält alle Routen (URLs) und die Logik der Webanwendung\n\nfrom flask import Flask, render_template, request, redirect, url_for, session, flash, Response, jsonify\nfrom datetime import datetime, timedelta, date\nfrom werkzeug.middleware.proxy_fix import ProxyFix\nimport pytz\nimport json\nimport os\nimport queue\nimport threading\n\n# Flask-App erstellen\napp = Flask(__name__)\napp.secret_key = os.environ.get('SESSION_SECRET', 'dev-secret-key-change-in-production')\napp.wsgi_app = ProxyFix(app.wsgi_app, x_proto=1, x_host=1)\n\n# SSE Broadcaster für Echtzeit-Benachrichtigungen\nnotification_subscribers = []\nsubscribers_lock = threading.Lock()\n\ndef broadcast_notification(notification_data):\n    \"\"\"Sendet eine Benachrichtigung an alle verbundenen SSE-Clients\"\"\"\n    with subscribers_lock:\n        dead_queues = []\n        for q in notification_subscribers:\n            try:\n                q.put_nowait(notification_data)\n            except queue.Full:\n                dead_queues.append(q)\n        \n        for q in dead_queues:\n            notification_subscribers.remove(q)\n\n# CSRF-Token Generierung und Validierung\nimport secrets\n\ndef generate_csrf_token():\n    \"\"\"Generiert ein CSRF-Token und speichert es in der Session\"\"\"\n    if 'csrf_token' not in session:\n        session['csrf_token'] = secrets.token_hex(32)\n    return session['csrf_token']\n\ndef validate_csrf_token(token):\n    \"\"\"Validiert das CSRF-Token\"\"\"\n    return token == session.get('csrf_token')\n\n@app.context_processor\ndef inject_csrf_token():\n    \"\"\"Macht csrf_token in allen Templates verfügbar\"\"\"\n    return dict(csrf_token=generate_csrf_token())\n\n# Datenbank-Konfiguration\ndb_uri = os.environ.get(\"DATABASE_URL\") or os.environ.get(\"SQLALCHEMY_DATABASE_URI\")\n\nprint(\"DEBUG DATABASE_URL:\", os.environ.get(\"DATABASE_URL\"))\nprint(\"DEBUG SQLALCHEMY_DATABASE_URI env:\", os.environ.get(\"SQLALCHEMY_DATABASE_URI\"))\nprint(\"DEBUG final DB URI:\", db_uri)\n\nif not db_uri:\n    raise RuntimeError(\n        \"Keine DB-URL gefunden. Bitte in Render DATABASE_URL \"\n        \"oder SQLALCHEMY_DATABASE_URI setzen.\"\n    )\n\napp.config[\"SQLALCHEMY_DATABASE_URI\"] = db_uri\napp.config[\"SQLALCHEMY_ENGINE_OPTIONS\"] = {\n    \"pool_recycle\": 300,\n    \"pool_pre_ping\": True,\n}\napp.config[\"SQLALCHEMY_TRACK_MODIFICATIONS\"] = False\n\n# Importiere zentrale Datenbank-Instanz\nfrom database import db\n\n# Initialisiere SQLAlchemy mit der App\ndb.init_app(app)\n\n# Importiere Modelle und Hilfsfunktionen\nfrom models import (\n    create_user, get_user_by_username, get_user_by_email, \n    get_user_by_id, verify_password, get_all_users, create_booking,\n    get_bookings_for_date_period, count_students_for_period, get_all_bookings,\n    get_bookings_by_date, get_bookings_for_week, get_booking_by_id,\n    update_booking, delete_booking, User, Booking,\n    create_notification, get_unread_notifications, get_recent_notifications,\n    mark_notification_as_read, mark_all_notifications_as_read,\n    get_unread_notification_count, get_booking_by_id, check_student_double_booking\n)\nfrom config import *\nfrom email_service import send_booking_notification\n\n# Schema-Erstellung erfolgt explizit über db_setup.py\n# Nicht automatisch bei jedem Import!\n\n# Hilfsfunktion: Zeitzone Europe/Berlin\ndef get_berlin_tz():\n    \"\"\"Gibt die Zeitzone Europe/Berlin zurück\"\"\"\n    return pytz.timezone('Europe/Berlin')\n\n# Hilfsfunktion: Prüft, ob Benutzer eingeloggt ist\ndef login_required(f):\n    \"\"\"Decorator-Funktion: Schützt Routen, sodass nur eingeloggte Benutzer darauf zugreifen können\"\"\"\n    from functools import wraps\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if 'user_id' not in session:\n            flash('Bitte melden Sie sich an.', 'error')\n            return redirect(url_for('login'))\n        return f(*args, **kwargs)\n    return decorated_function\n\n# Hilfsfunktion: Prüft, ob Benutzer Admin ist\ndef admin_required(f):\n    \"\"\"Decorator-Funktion: Schützt Routen, sodass nur Admins darauf zugreifen können\"\"\"\n    from functools import wraps\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if 'user_id' not in session:\n            flash('Bitte melden Sie sich an.', 'error')\n            return redirect(url_for('login'))\n        user = get_user_by_id(session['user_id'])\n        if not user or user['role'] != 'admin':\n            flash('Zugriff verweigert. Nur Admins haben Zugriff.', 'error')\n            return redirect(url_for('dashboard'))\n        return f(*args, **kwargs)\n    return decorated_function\n\n# Hilfsfunktion: Gibt Informationen über eine Stunde zurück\ndef get_period_info(weekday, period):\n    \"\"\"\n    Gibt Informationen über eine Stunde zurück (fest/frei, Bezeichnung)\n    weekday: z.B. \"Mon\", \"Tue\", ...\n    period: 1-6\n    \"\"\"\n    from models import get_custom_slot_name\n    \n    if weekday in FIXED_OFFERS and period in FIXED_OFFERS[weekday]:\n        custom_label = get_custom_slot_name(weekday, period)\n        label = custom_label if custom_label else FIXED_OFFERS[weekday][period]\n        return {\n            'type': 'fest',\n            'label': label\n        }\n    else:\n        return {\n            'type': 'frei',\n            'label': 'Freie Wahl'\n        }\n\n# Hilfsfunktion: Prüft, ob ein Datum in der Vergangenheit liegt\ndef is_past_date(check_date, period=None):\n    \"\"\"\n    Prüft, ob ein Datum (und optional eine Stunde) in der Vergangenheit liegt\n    \"\"\"\n    berlin_tz = get_berlin_tz()\n    now = datetime.now(berlin_tz)\n    \n    if period is not None:\n        # Prüfe mit spezifischer Stunde\n        period_start_time = PERIOD_TIMES[period]['start']\n        hour, minute = map(int, period_start_time.split(':'))\n        period_datetime = berlin_tz.localize(\n            datetime.combine(check_date, datetime.min.time()).replace(hour=hour, minute=minute)\n        )\n        return period_datetime < now\n    else:\n        # Prüfe nur Datum\n        today = now.date()\n        return check_date < today\n\n# Hilfsfunktion: Prüft, ob eine Buchung zeitlich möglich ist\ndef check_booking_time(booking_date, period):\n    \"\"\"\n    Prüft, ob die Buchung mindestens 60 Minuten in der Zukunft liegt\n    Gibt (True, None) zurück wenn OK, sonst (False, Fehlermeldung)\n    \"\"\"\n    berlin_tz = get_berlin_tz()\n    now = datetime.now(berlin_tz)\n    \n    # Erstelle Datetime-Objekt für den Stundenbeginn\n    period_start_time = PERIOD_TIMES[period]['start']\n    hour, minute = map(int, period_start_time.split(':'))\n    \n    # Kombiniere Datum und Zeit\n    period_datetime = berlin_tz.localize(\n        datetime.combine(booking_date, datetime.min.time()).replace(hour=hour, minute=minute)\n    )\n    \n    # Berechne Zeitdifferenz\n    time_diff = period_datetime - now\n    \n    if time_diff.total_seconds() < BOOKING_ADVANCE_MINUTES * 60:\n        return False, f\"Buchungen sind nur bis {BOOKING_ADVANCE_MINUTES} Minuten vor Stundenbeginn möglich.\"\n    \n    return True, None\n\n# Route: Startseite (leitet zum Dashboard weiter)\n@app.route('/')\ndef index():\n    \"\"\"Startseite - leitet zum Dashboard oder Login weiter\"\"\"\n    if 'user_id' in session:\n        return redirect(url_for('dashboard'))\n    return redirect(url_for('login'))\n\n# Route: Login-Seite\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    \"\"\"Login-Seite für Lehrkräfte und Admins\"\"\"\n    if request.method == 'POST':\n        username = request.form.get('username', '').strip()\n        password = request.form.get('password', '')\n        \n        # Suche Benutzer in Datenbank\n        user = get_user_by_username(username)\n        \n        if user and verify_password(user, password):\n            # Login erfolgreich - speichere in Session\n            session['user_id'] = user['id']\n            session['user_username'] = user['username']\n            session['user_email'] = user['email'] if user['email'] else ''\n            session['user_role'] = user['role']\n            flash(f'Willkommen, {username}!', 'success')\n            return redirect(url_for('dashboard'))\n        else:\n            flash('Ungültiger Benutzername oder Passwort.', 'error')\n    \n    return render_template('login.html')\n\n# Route: Logout\n@app.route('/logout')\ndef logout():\n    \"\"\"Meldet den Benutzer ab\"\"\"\n    session.clear()\n    flash('Sie wurden abgemeldet.', 'info')\n    return redirect(url_for('login'))\n\n# Route: Dashboard\n@app.route('/dashboard')\n@login_required\ndef dashboard():\n    \"\"\"Hauptseite - zeigt Wochenplan und Buchungsmöglichkeiten\"\"\"\n    # Hole aktuelles Datum oder gewähltes Datum\n    selected_date_str = request.args.get('date', datetime.now(get_berlin_tz()).strftime('%Y-%m-%d'))\n    \n    try:\n        selected_date = datetime.strptime(selected_date_str, '%Y-%m-%d').date()\n    except:\n        selected_date = datetime.now(get_berlin_tz()).date()\n    \n    # Wochentag ermitteln (Mon, Tue, ...)\n    weekday = selected_date.strftime('%a')\n    weekday_name = selected_date.strftime('%A')  # Ausgeschriebener Name\n    \n    # Deutsche Wochentagsnamen\n    weekday_names_de = {\n        'Monday': 'Montag',\n        'Tuesday': 'Dienstag',\n        'Wednesday': 'Mittwoch',\n        'Thursday': 'Donnerstag',\n        'Friday': 'Freitag',\n        'Saturday': 'Samstag',\n        'Sunday': 'Sonntag'\n    }\n    weekday_name_de = weekday_names_de.get(weekday_name, weekday_name)\n    \n    # Erstelle Stundenplan für den Tag\n    from models import is_slot_blocked, get_blocked_slot\n    schedule = []\n    for period in range(1, 7):\n        period_info = get_period_info(weekday, period)\n        student_count = count_students_for_period(selected_date_str, period)\n        available = MAX_STUDENTS_PER_PERIOD - student_count\n        \n        # Prüfe, ob Slot blockiert ist\n        blocked_slot = get_blocked_slot(selected_date_str, period)\n        is_blocked = blocked_slot is not None\n        \n        # Prüfe, ob Termin in der Vergangenheit liegt\n        is_past = is_past_date(selected_date, period)\n        \n        # Prüfe, ob es ein Wochenende ist\n        is_weekend = selected_date.weekday() in [5, 6]\n        \n        # Prüfe, ob Buchung zeitlich möglich ist\n        can_book, time_message = check_booking_time(selected_date, period)\n        \n        # can_book muss False sein für vergangene Termine oder Wochenenden\n        if is_past:\n            can_book = False\n            if not time_message:\n                time_message = \"Dieser Termin liegt in der Vergangenheit.\"\n        elif is_weekend:\n            can_book = False\n            if not time_message:\n                time_message = \"Buchungen sind am Wochenende nicht möglich.\"\n        \n        schedule.append({\n            'period': period,\n            'time': f\"{PERIOD_TIMES[period]['start']} - {PERIOD_TIMES[period]['end']}\",\n            'type': period_info['type'],\n            'label': period_info['label'],\n            'booked': student_count,\n            'available': available,\n            'can_book': can_book and available > 0 and not is_blocked and not is_past and not is_weekend,\n            'time_message': time_message,\n            'blocked': blocked_slot,\n            'blocked_reason': blocked_slot.get('reason', 'Beratung') if blocked_slot else None,\n            'is_past': is_past,\n            'is_weekend': is_weekend\n        })\n    \n    # Erstelle Wochenübersicht (Montag-Freitag) mit Buchungsdaten\n    from models import get_bookings_for_week, get_blocked_slots_for_week, is_slot_blocked\n    \n    # Berechne Montag und Freitag der aktuellen Woche\n    days_since_monday = selected_date.weekday()\n    monday = selected_date - timedelta(days=days_since_monday)\n    friday = monday + timedelta(days=4)\n    \n    # Berechne Kalenderwoche\n    calendar_week = monday.isocalendar()[1]\n    calendar_year = monday.isocalendar()[0]\n    \n    # Berechne vorherige und nächste Woche für Navigation\n    prev_week_monday = monday - timedelta(days=7)\n    next_week_monday = monday + timedelta(days=7)\n    \n    # Hole alle Buchungen für diese Woche\n    week_bookings = get_bookings_for_week(monday.strftime('%Y-%m-%d'), friday.strftime('%Y-%m-%d'))\n    \n    # Hole alle blockierten Slots für diese Woche\n    blocked_slots = get_blocked_slots_for_week(monday.strftime('%Y-%m-%d'), friday.strftime('%Y-%m-%d'))\n    \n    # Organisiere blockierte Slots nach Datum und Stunde\n    blocked_by_date_period = {}\n    for blocked in blocked_slots:\n        key = f\"{blocked['date']}_{blocked['period']}\"\n        blocked_by_date_period[key] = blocked\n    \n    # Organisiere Buchungen nach Datum und Stunde\n    bookings_by_date_period = {}\n    for booking in week_bookings:\n        booking_dict = dict(booking)\n        key = f\"{booking_dict['date']}_{booking_dict['period']}\"\n        if key not in bookings_by_date_period:\n            bookings_by_date_period[key] = []\n        \n        students = json.loads(booking_dict['students_json']) if booking_dict.get('students_json') else []\n        bookings_by_date_period[key].append({\n            'teacher_name': booking_dict.get('teacher_name', 'N/A'),\n            'teacher_class': booking_dict.get('teacher_class', 'N/A'),\n            'student_count': len(students),\n            'students': students,\n            'offer_label': booking_dict.get('offer_label', 'N/A')\n        })\n    \n    week_overview = []\n    weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri']\n    weekday_names = ['Mo', 'Di', 'Mi', 'Do', 'Fr']\n    \n    for i, wd in enumerate(weekdays):\n        day_date = monday + timedelta(days=i)\n        day_date_str = day_date.strftime('%Y-%m-%d')\n        \n        day_schedule = []\n        for period in range(1, 7):\n            info = get_period_info(wd, period)\n            key = f\"{day_date_str}_{period}\"\n            period_bookings = bookings_by_date_period.get(key, [])\n            blocked_slot = blocked_by_date_period.get(key)\n            \n            total_students = sum(b['student_count'] for b in period_bookings)\n            available = MAX_STUDENTS_PER_PERIOD - total_students\n            \n            # Prüfe, ob Termin in der Vergangenheit liegt\n            is_past = is_past_date(day_date, period)\n            \n            # Prüfe, ob es ein Wochenende ist\n            is_weekend = day_date.weekday() in [5, 6]\n            \n            # Prüfe, ob Buchung für diesen Slot möglich ist\n            can_book, _ = check_booking_time(day_date, period)\n            can_book = can_book and available > 0 and not blocked_slot and not is_past and not is_weekend\n            \n            day_schedule.append({\n                'period': period,\n                'type': info['type'],\n                'label': info['label'],\n                'bookings': period_bookings,\n                'total_students': total_students,\n                'available': available,\n                'can_book': can_book,\n                'blocked': blocked_slot,\n                'blocked_reason': blocked_slot.get('reason', 'Beratung') if blocked_slot else None,\n                'is_past': is_past,\n                'is_weekend': is_weekend\n            })\n        week_overview.append({\n            'weekday': wd,\n            'name': weekday_names[i],\n            'date': day_date_str,\n            'date_formatted': day_date.strftime('%d.%m.'),\n            'schedule': day_schedule\n        })\n    \n    return render_template('dashboard.html',\n                         selected_date=selected_date,\n                         weekday=weekday_name_de,\n                         schedule=schedule,\n                         week_overview=week_overview,\n                         user_role=session.get('user_role'),\n                         calendar_week=calendar_week,\n                         calendar_year=calendar_year,\n                         prev_week_date=prev_week_monday.strftime('%Y-%m-%d'),\n                         next_week_date=next_week_monday.strftime('%Y-%m-%d'),\n                         monday_date=monday.strftime('%d.%m.%Y'),\n                         friday_date=friday.strftime('%d.%m.%Y'))\n\n# Route: Buchungsseite\n@app.route('/book/<date_str>/<int:period>', methods=['GET', 'POST'])\n@login_required\ndef book(date_str, period):\n    \"\"\"Seite zum Erstellen einer neuen Buchung\"\"\"\n    \n    # Validiere Datum und Stunde\n    try:\n        booking_date = datetime.strptime(date_str, '%Y-%m-%d').date()\n    except:\n        flash('Ungültiges Datum.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    if period < 1 or period > 6:\n        flash('Ungültige Stunde.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    # Prüfe, ob Termin in der Vergangenheit liegt\n    if is_past_date(booking_date, period):\n        flash('Dieser Termin liegt in der Vergangenheit und kann nicht gebucht werden.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    # Prüfe, ob es ein Wochenende ist (Samstag=5, Sonntag=6)\n    if booking_date.weekday() in [5, 6]:\n        flash('Buchungen sind am Wochenende nicht möglich.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    # Ermittle Wochentag und Stundeninfo\n    weekday = booking_date.strftime('%a')\n    period_info = get_period_info(weekday, period)\n    \n    # Prüfe verfügbare Plätze\n    current_students = count_students_for_period(date_str, period)\n    available_spots = MAX_STUDENTS_PER_PERIOD - current_students\n    \n    if available_spots <= 0:\n        flash('Diese Stunde ist bereits voll belegt.', 'error')\n        return redirect(url_for('dashboard', date=date_str))\n    \n    # Prüfe, ob Slot für Beratung blockiert ist (nur Admins können blockierte Slots sehen)\n    from models import is_slot_blocked, get_blocked_slot\n    if is_slot_blocked(date_str, period):\n        blocked_info = get_blocked_slot(date_str, period)\n        reason = blocked_info.get('reason', 'Beratung') if blocked_info else 'Beratung'\n        flash(f'Dieser Slot ist für {reason} blockiert und kann nicht gebucht werden.', 'error')\n        return redirect(url_for('dashboard', date=date_str))\n    \n    # Prüfe Zeitfenster\n    can_book, time_message = check_booking_time(booking_date, period)\n    if not can_book:\n        flash(time_message or 'Buchung nicht möglich.', 'error')\n        return redirect(url_for('dashboard', date=date_str))\n    \n    if request.method == 'POST':\n        # Hole Lehrkraft-Informationen\n        teacher_name = request.form.get('teacher_name', '').strip()\n        teacher_class = request.form.get('teacher_class', '').strip()\n        \n        if not teacher_name or not teacher_class:\n            flash('Bitte geben Sie Ihren Namen und Ihre Klasse ein.', 'error')\n            return render_template('book.html', \n                                 date_str=date_str,\n                                 period=period,\n                                 period_info=period_info,\n                                 period_time=PERIOD_TIMES[period],\n                                 available_spots=available_spots,\n                                 free_modules=FREE_MODULES)\n        \n        # Hole Anzahl der Schüler\n        num_students = int(request.form.get('num_students', 1))\n        \n        if num_students < 1 or num_students > 5:\n            flash('Bitte wählen Sie zwischen 1 und 5 Schülern.', 'error')\n            return render_template('book.html', \n                                 date_str=date_str,\n                                 period=period,\n                                 period_info=period_info,\n                                 period_time=PERIOD_TIMES[period],\n                                 available_spots=available_spots,\n                                 free_modules=FREE_MODULES)\n        \n        # Prüfe erneut verfügbare Plätze\n        if num_students > available_spots:\n            flash(f'Nicht genug Plätze verfügbar. Nur noch {available_spots} Plätze frei.', 'error')\n            return redirect(url_for('dashboard', date=date_str))\n        \n        # Sammle Schülerdaten und prüfe Doppelbuchungen\n        students = []\n        for i in range(num_students):\n            name = request.form.get(f'student_name_{i}', '').strip()\n            klasse = request.form.get(f'student_class_{i}', '').strip()\n            \n            if not name or not klasse:\n                flash('Bitte füllen Sie alle Schülerfelder aus.', 'error')\n                return render_template('book.html', \n                                     date_str=date_str,\n                                     period=period,\n                                     period_info=period_info,\n                                     period_time=PERIOD_TIMES[period],\n                                     available_spots=available_spots,\n                                     free_modules=FREE_MODULES)\n            \n            # Prüfe auf Doppelbuchung\n            double_booking = check_student_double_booking(name, klasse, date_str, period)\n            if double_booking['is_booked']:\n                flash(f'⚠️ Doppelbuchung verhindert: {double_booking[\"booking_info\"]}', 'error')\n                return render_template('book.html', \n                                     date_str=date_str,\n                                     period=period,\n                                     period_info=period_info,\n                                     period_time=PERIOD_TIMES[period],\n                                     available_spots=available_spots,\n                                     free_modules=FREE_MODULES)\n            \n            students.append({'name': name, 'klasse': klasse})\n        \n        # Hole Modul-Wahl (nur bei freien Stunden)\n        if period_info['type'] == 'frei':\n            selected_module = request.form.get('module', '')\n            if selected_module not in FREE_MODULES:\n                flash('Bitte wählen Sie ein Modul.', 'error')\n                return render_template('book.html', \n                                     date_str=date_str,\n                                     period=period,\n                                     period_info=period_info,\n                                     period_time=PERIOD_TIMES[period],\n                                     available_spots=available_spots,\n                                     free_modules=FREE_MODULES)\n            offer_label = selected_module\n        else:\n            offer_label = period_info['label']\n        \n        # Erstelle Buchung in Datenbank\n        booking_id = create_booking(\n            date=date_str,\n            weekday=weekday,\n            period=period,\n            teacher_id=session['user_id'],\n            students=students,\n            offer_type=period_info['type'],\n            offer_label=offer_label,\n            teacher_name=teacher_name,\n            teacher_class=teacher_class\n        )\n        \n        if booking_id:\n            # Sende E-Mail-Benachrichtigung\n            booking_data = {\n                'date': date_str,\n                'weekday': weekday,\n                'period': period,\n                'students': students,\n                'offer_type': period_info['type'],\n                'offer_label': offer_label,\n                'teacher_name': teacher_name,\n                'teacher_class': teacher_class,\n                'students_json': json.dumps(students, ensure_ascii=False)\n            }\n            # Erstelle Notification in der Datenbank\n            notification_message = f\"Neue Buchung: {teacher_name} hat {len(students)} Schüler für {offer_label} am {date_str} (Stunde {period}) angemeldet.\"\n            notification_id = create_notification(\n                booking_id=booking_id,\n                message=notification_message,\n                notification_type='new_booking',\n                recipient_role='admin',\n                metadata={\n                    'teacher_name': teacher_name,\n                    'teacher_class': teacher_class,\n                    'date': date_str,\n                    'period': period,\n                    'offer_label': offer_label,\n                    'students_count': len(students)\n                }\n            )\n            \n            # Sende E-Mail-Benachrichtigung an Admin (SMTP)\n            try:\n                send_booking_notification(booking_data)\n            except Exception as e:\n                print(f\"E-Mail-Benachrichtigung fehlgeschlagen: {e}\")\n            \n            # Broadcast an SSE-Clients\n            if notification_id:\n                unread_count = get_unread_notification_count(recipient_role='admin')\n                broadcast_notification({\n                    'type': 'new_booking',\n                    'notification_id': notification_id,\n                    'message': notification_message,\n                    'booking_data': {\n                        'date': date_str,\n                        'period': period,\n                        'teacher_name': teacher_name,\n                        'offer_label': offer_label,\n                        'students_count': len(students)\n                    },\n                    'unread_count': unread_count\n                })\n            \n            flash(f'Buchung erfolgreich! {len(students)} Schüler für {offer_label} angemeldet.', 'success')\n            return redirect(url_for('dashboard', date=date_str))\n        else:\n            flash('Fehler beim Erstellen der Buchung.', 'error')\n    \n    return render_template('book.html',\n                         date_str=date_str,\n                         period=period,\n                         period_info=period_info,\n                         period_time=PERIOD_TIMES[period],\n                         available_spots=available_spots,\n                         free_modules=FREE_MODULES)\n\n# Route: Admin-Bereich\n@app.route('/admin', methods=['GET', 'POST'])\n@admin_required\ndef admin():\n    \"\"\"Admin-Seite für Benutzerverwaltung und Buchungsübersicht\"\"\"\n    \n    if request.method == 'POST':\n        # Neue Lehrkraft anlegen\n        username = request.form.get('username', '').strip()\n        password = request.form.get('password', '')\n        email = request.form.get('email', '').strip()\n        \n        if not username or not password:\n            flash('Bitte füllen Sie alle Felder aus.', 'error')\n        else:\n            user_id = create_user(username, password, 'teacher', email if email else None)\n            if user_id:\n                flash(f'Lehrkraft {username} erfolgreich angelegt.', 'success')\n            else:\n                flash('Benutzername existiert bereits.', 'error')\n    \n    # Hole alle Benutzer\n    users = get_all_users()\n    \n    # Hole alle Buchungen\n    filter_date = request.args.get('filter_date', '')\n    if filter_date:\n        bookings = get_bookings_by_date(filter_date)\n    else:\n        bookings = get_all_bookings()\n    \n    # Konvertiere Buchungen für Anzeige\n    bookings_display = []\n    for booking in bookings:\n        booking_dict = dict(booking)\n        students = json.loads(booking_dict['students_json']) if booking_dict.get('students_json') else []\n        bookings_display.append({\n            'id': booking_dict['id'],\n            'date': booking_dict['date'],\n            'weekday': booking_dict['weekday'],\n            'period': booking_dict['period'],\n            'teacher_email': booking_dict['teacher_email'],\n            'teacher_name': booking_dict.get('teacher_name', 'N/A'),\n            'teacher_class': booking_dict.get('teacher_class', 'N/A'),\n            'offer_label': booking_dict['offer_label'],\n            'offer_type': booking_dict['offer_type'],\n            'students': students,\n            'student_count': len(students)\n        })\n    \n    return render_template('admin.html',\n                         users=users,\n                         bookings=bookings_display,\n                         filter_date=filter_date)\n\n# Route: Buchung erstellen (nur Admin)\n@app.route('/admin/create_booking', methods=['GET', 'POST'])\n@admin_required\ndef admin_create_booking():\n    \"\"\"Admin kann Buchungen für beliebige Lehrkräfte erstellen\"\"\"\n    from models import get_booking_by_id\n    \n    if request.method == 'POST':\n        date_str = request.form.get('date', '').strip()\n        \n        try:\n            period = int(request.form.get('period', 1))\n            teacher_id = int(request.form.get('teacher_id', 0))\n            num_students = int(request.form.get('num_students', 1))\n        except (ValueError, TypeError):\n            flash('Ungültige Eingabe für Stunde, Lehrkraft oder Schüleranzahl.', 'error')\n            users = get_all_users()\n            return render_template('admin_edit_booking.html',\n                                 booking=None,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        teacher_name = request.form.get('teacher_name', '').strip()\n        teacher_class = request.form.get('teacher_class', '').strip()\n        \n        if not date_str or not teacher_id or not teacher_name or not teacher_class or num_students < 1 or num_students > 5:\n            flash('Bitte füllen Sie alle Pflichtfelder aus und wählen Sie 1-5 Schüler.', 'error')\n            users = get_all_users()\n            return render_template('admin_edit_booking.html',\n                                 booking=None,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        try:\n            booking_date = datetime.strptime(date_str, '%Y-%m-%d').date()\n        except:\n            flash('Ungültiges Datum.', 'error')\n            users = get_all_users()\n            return render_template('admin_edit_booking.html',\n                                 booking=None,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        weekday = booking_date.strftime('%a')\n        period_info = get_period_info(weekday, period)\n        \n        # Prüfe Kapazität vor dem Erstellen der Buchung\n        current_students = count_students_for_period(date_str, period)\n        available_spots = MAX_STUDENTS_PER_PERIOD - current_students\n        \n        if num_students > available_spots:\n            flash(f'Nicht genug Plätze verfügbar. Nur noch {available_spots} Plätze frei.', 'error')\n            users = get_all_users()\n            return render_template('admin_edit_booking.html',\n                                 booking=None,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        students = []\n        for i in range(num_students):\n            name = request.form.get(f'student_name_{i}', '').strip()\n            klasse = request.form.get(f'student_class_{i}', '').strip()\n            \n            if not name or not klasse:\n                flash('Bitte füllen Sie alle Schülerfelder aus.', 'error')\n                users = get_all_users()\n                return render_template('admin_edit_booking.html',\n                                     booking=None,\n                                     users=users,\n                                     free_modules=FREE_MODULES,\n                                     period_times=PERIOD_TIMES)\n            \n            students.append({'name': name, 'klasse': klasse})\n        \n        if period_info['type'] == 'frei':\n            selected_module = request.form.get('module', '')\n            if selected_module not in FREE_MODULES:\n                flash('Bitte wählen Sie ein Modul.', 'error')\n                users = get_all_users()\n                return render_template('admin_edit_booking.html',\n                                     booking=None,\n                                     users=users,\n                                     free_modules=FREE_MODULES,\n                                     period_times=PERIOD_TIMES)\n            offer_label = selected_module\n        else:\n            offer_label = period_info['label']\n        \n        booking_id = create_booking(\n            date=date_str,\n            weekday=weekday,\n            period=period,\n            teacher_id=teacher_id,\n            students=students,\n            offer_type=period_info['type'],\n            offer_label=offer_label,\n            teacher_name=teacher_name,\n            teacher_class=teacher_class\n        )\n        \n        if booking_id:\n            flash(f'Buchung erfolgreich erstellt! {len(students)} Schüler für {offer_label} angemeldet.', 'success')\n            return redirect(url_for('admin'))\n        else:\n            flash('Fehler beim Erstellen der Buchung.', 'error')\n    \n    users = get_all_users()\n    return render_template('admin_edit_booking.html',\n                         booking=None,\n                         users=users,\n                         free_modules=FREE_MODULES,\n                         period_times=PERIOD_TIMES)\n\n# Route: Buchung bearbeiten (nur Admin)\n@app.route('/admin/edit_booking/<int:booking_id>', methods=['GET', 'POST'])\n@admin_required\ndef admin_edit_booking(booking_id):\n    \"\"\"Admin kann bestehende Buchungen bearbeiten\"\"\"\n    from models import get_booking_by_id, update_booking\n    \n    booking_row = get_booking_by_id(booking_id)\n    if not booking_row:\n        flash('Buchung nicht gefunden.', 'error')\n        return redirect(url_for('admin'))\n    \n    booking = dict(booking_row)\n    \n    if request.method == 'POST':\n        date_str = request.form.get('date', '').strip()\n        \n        try:\n            period = int(request.form.get('period', 1))\n            teacher_id = int(request.form.get('teacher_id', 0))\n            num_students = int(request.form.get('num_students', 1))\n        except (ValueError, TypeError):\n            flash('Ungültige Eingabe für Stunde, Lehrkraft oder Schüleranzahl.', 'error')\n            users = get_all_users()\n            students = json.loads(booking['students_json']) if booking.get('students_json') else []\n            booking_display = dict(booking)\n            booking_display['students'] = students\n            return render_template('admin_edit_booking.html',\n                                 booking=booking_display,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        teacher_name = request.form.get('teacher_name', '').strip()\n        teacher_class = request.form.get('teacher_class', '').strip()\n        \n        if not date_str or not teacher_id or not teacher_name or not teacher_class or num_students < 1 or num_students > 5:\n            flash('Bitte füllen Sie alle Pflichtfelder aus und wählen Sie 1-5 Schüler.', 'error')\n            users = get_all_users()\n            students = json.loads(booking['students_json']) if booking.get('students_json') else []\n            booking_display = dict(booking)\n            booking_display['students'] = students\n            return render_template('admin_edit_booking.html',\n                                 booking=booking_display,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        try:\n            booking_date = datetime.strptime(date_str, '%Y-%m-%d').date()\n        except:\n            flash('Ungültiges Datum.', 'error')\n            users = get_all_users()\n            students = json.loads(booking['students_json']) if booking.get('students_json') else []\n            booking_display = dict(booking)\n            booking_display['students'] = students\n            return render_template('admin_edit_booking.html',\n                                 booking=booking_display,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        weekday = booking_date.strftime('%a')\n        period_info = get_period_info(weekday, period)\n        \n        # Prüfe Kapazität: Berechne verfügbare Plätze ohne die aktuelle Buchung\n        current_students = count_students_for_period(date_str, period)\n        old_booking_students = len(json.loads(booking['students_json']) if booking.get('students_json') else [])\n        available_spots = MAX_STUDENTS_PER_PERIOD - (current_students - old_booking_students)\n        \n        if num_students > available_spots:\n            flash(f'Nicht genug Plätze verfügbar. Nur noch {available_spots} Plätze frei.', 'error')\n            users = get_all_users()\n            students = json.loads(booking['students_json']) if booking.get('students_json') else []\n            booking_display = dict(booking)\n            booking_display['students'] = students\n            return render_template('admin_edit_booking.html',\n                                 booking=booking_display,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        students = []\n        for i in range(num_students):\n            name = request.form.get(f'student_name_{i}', '').strip()\n            klasse = request.form.get(f'student_class_{i}', '').strip()\n            \n            if not name or not klasse:\n                flash('Bitte füllen Sie alle Schülerfelder aus.', 'error')\n                users = get_all_users()\n                students = json.loads(booking['students_json']) if booking.get('students_json') else []\n                booking_display = dict(booking)\n                booking_display['students'] = students\n                return render_template('admin_edit_booking.html',\n                                     booking=booking_display,\n                                     users=users,\n                                     free_modules=FREE_MODULES,\n                                     period_times=PERIOD_TIMES)\n            \n            students.append({'name': name, 'klasse': klasse})\n        \n        if period_info['type'] == 'frei':\n            selected_module = request.form.get('module', '')\n            if selected_module not in FREE_MODULES:\n                flash('Bitte wählen Sie ein Modul.', 'error')\n                users = get_all_users()\n                students = json.loads(booking['students_json']) if booking.get('students_json') else []\n                booking_display = dict(booking)\n                booking_display['students'] = students\n                return render_template('admin_edit_booking.html',\n                                     booking=booking_display,\n                                     users=users,\n                                     free_modules=FREE_MODULES,\n                                     period_times=PERIOD_TIMES)\n            offer_label = selected_module\n        else:\n            offer_label = period_info['label']\n        \n        if update_booking(\n            booking_id=booking_id,\n            date=date_str,\n            weekday=weekday,\n            period=period,\n            teacher_id=teacher_id,\n            students=students,\n            offer_type=period_info['type'],\n            offer_label=offer_label,\n            teacher_name=teacher_name,\n            teacher_class=teacher_class\n        ):\n            flash(f'Buchung erfolgreich aktualisiert!', 'success')\n            return redirect(url_for('admin'))\n        else:\n            flash('Fehler beim Aktualisieren der Buchung.', 'error')\n    \n    users = get_all_users()\n    students = json.loads(booking['students_json']) if booking.get('students_json') else []\n    booking_display = dict(booking)\n    booking_display['students'] = students\n    \n    return render_template('admin_edit_booking.html',\n                         booking=booking_display,\n                         users=users,\n                         free_modules=FREE_MODULES,\n                         period_times=PERIOD_TIMES)\n\n# Route: Buchung löschen (nur Admin)\n@app.route('/admin/delete_booking/<int:booking_id>', methods=['POST'])\n@admin_required\ndef delete_booking_route(booking_id):\n    \"\"\"Löscht eine Buchung\"\"\"\n    from models import delete_booking\n    \n    if delete_booking(booking_id):\n        flash('Buchung erfolgreich gelöscht.', 'success')\n    else:\n        flash('Buchung konnte nicht gelöscht werden.', 'error')\n    \n    return redirect(url_for('admin'))\n\n# Route: Slots verwalten (nur Admin)\n@app.route('/admin/manage_slots', methods=['GET', 'POST'])\n@admin_required\ndef manage_slots():\n    \"\"\"Admin kann feste Slot-Namen umbenennen\"\"\"\n    from models import update_slot_name\n    \n    if request.method == 'POST':\n        weekday = request.form.get('weekday')\n        period_str = request.form.get('period')\n        period = int(period_str) if period_str else 0\n        label = request.form.get('label', '').strip()\n        \n        if weekday and period and label:\n            if update_slot_name(weekday, period, label):\n                flash(f'Slot-Name erfolgreich aktualisiert!', 'success')\n            else:\n                flash('Fehler beim Aktualisieren des Slot-Namens.', 'error')\n        else:\n            flash('Bitte füllen Sie alle Felder aus.', 'error')\n        \n        return redirect(url_for('manage_slots'))\n    \n    fixed_slots = []\n    weekdays = {\n        'Mon': 'Montag',\n        'Tue': 'Dienstag', \n        'Wed': 'Mittwoch',\n        'Thu': 'Donnerstag',\n        'Fri': 'Freitag'\n    }\n    \n    for weekday_code, weekday_name in weekdays.items():\n        if weekday_code in FIXED_OFFERS:\n            for period, default_label in FIXED_OFFERS[weekday_code].items():\n                period_info = get_period_info(weekday_code, period)\n                fixed_slots.append({\n                    'weekday_code': weekday_code,\n                    'weekday_name': weekday_name,\n                    'period': period,\n                    'period_time': f\"{PERIOD_TIMES[period]['start']} - {PERIOD_TIMES[period]['end']}\",\n                    'default_label': default_label,\n                    'current_label': period_info['label']\n                })\n    \n    return render_template('admin_manage_slots.html', \n                         fixed_slots=fixed_slots)\n\n@app.route('/admin/block_slot', methods=['POST'])\n@admin_required\ndef admin_block_slot():\n    \"\"\"Admin blockiert einen Slot für Beratungsgespräche\"\"\"\n    from models import block_slot, is_slot_blocked\n    \n    # CSRF-Token Validierung\n    csrf_token = request.form.get('csrf_token', '')\n    if not validate_csrf_token(csrf_token):\n        flash('Ungültiges Sicherheits-Token. Bitte versuchen Sie es erneut.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    date_str = request.form.get('date', '').strip()\n    period = request.form.get('period', type=int)\n    reason = request.form.get('reason', 'Beratung').strip()\n    \n    # Validiere Grund-Länge\n    if reason and len(reason) > 200:\n        reason = reason[:200]\n    \n    if not date_str or not period:\n        flash('Ungültige Slot-Daten.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    try:\n        booking_date = datetime.strptime(date_str, '%Y-%m-%d').date()\n        weekday = booking_date.strftime('%a')\n    except:\n        flash('Ungültiges Datum.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    if is_slot_blocked(date_str, period):\n        flash('Dieser Slot ist bereits blockiert.', 'warning')\n    else:\n        admin_id = session.get('user_id')\n        if block_slot(date_str, weekday, period, admin_id, reason):\n            flash(f'Slot erfolgreich für {reason} blockiert.', 'success')\n        else:\n            flash('Fehler beim Blockieren des Slots.', 'error')\n    \n    return redirect(request.referrer or url_for('dashboard'))\n\n@app.route('/admin/unblock_slot', methods=['POST'])\n@admin_required\ndef admin_unblock_slot():\n    \"\"\"Admin gibt einen blockierten Slot wieder frei\"\"\"\n    from models import unblock_slot\n    \n    # CSRF-Token Validierung\n    csrf_token = request.form.get('csrf_token', '')\n    if not validate_csrf_token(csrf_token):\n        flash('Ungültiges Sicherheits-Token. Bitte versuchen Sie es erneut.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    date_str = request.form.get('date', '').strip()\n    period = request.form.get('period', type=int)\n    \n    if not date_str or not period:\n        flash('Ungültige Slot-Daten.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    if unblock_slot(date_str, period):\n        flash('Slot erfolgreich freigegeben.', 'success')\n    else:\n        flash('Fehler beim Freigeben des Slots.', 'error')\n    \n    return redirect(request.referrer or url_for('dashboard'))\n\n# ============================================================================\n# Notifications & Server-Sent Events (SSE) Routes\n# ============================================================================\n\n# SSE deaktiviert - verursacht Worker-Timeouts in Produktion mit Gunicorn\n# @app.route('/notifications/stream')\n# @admin_required\n# def notifications_stream():\n#     \"\"\"SSE-Endpunkt für Echtzeit-Benachrichtigungen (nur für Admins)\"\"\"\n#     def event_stream():\n#         \"\"\"Generator für Server-Sent Events\"\"\"\n#         q = queue.Queue(maxsize=50)\n#         \n#         with subscribers_lock:\n#             notification_subscribers.append(q)\n#         \n#         try:\n#             while True:\n#                 try:\n#                     message = q.get(timeout=30)\n#                     yield f\"data: {json.dumps(message)}\\n\\n\"\n#                 except queue.Empty:\n#                     yield f\"data: {json.dumps({'type': 'ping'})}\\n\\n\"\n#         finally:\n#             with subscribers_lock:\n#                 if q in notification_subscribers:\n#                     notification_subscribers.remove(q)\n#     \n#     return Response(event_stream(), mimetype='text/event-stream')\n\n@app.route('/api/notifications/recent', methods=['GET'])\n@admin_required\ndef api_get_recent_notifications():\n    \"\"\"Holt die neuesten Benachrichtigungen\"\"\"\n    limit = request.args.get('limit', 10, type=int)\n    limit = min(limit, 50)\n    \n    notifications = get_recent_notifications(recipient_role='admin', limit=limit)\n    return jsonify({\n        'success': True,\n        'notifications': notifications\n    })\n\n@app.route('/api/notifications/unread_count', methods=['GET'])\n@admin_required\ndef api_get_unread_count():\n    \"\"\"Holt die Anzahl der ungelesenen Benachrichtigungen\"\"\"\n    count = get_unread_notification_count(recipient_role='admin')\n    return jsonify({\n        'success': True,\n        'count': count\n    })\n\n@app.route('/api/notifications/<int:notification_id>/mark_read', methods=['POST'])\n@admin_required\ndef api_mark_notification_read(notification_id):\n    \"\"\"Markiert eine Benachrichtigung als gelesen\"\"\"\n    csrf_token = request.json.get('csrf_token', '') if request.json else ''\n    if not validate_csrf_token(csrf_token):\n        return jsonify({\n            'success': False,\n            'error': 'Invalid CSRF token'\n        }), 403\n    \n    success = mark_notification_as_read(notification_id)\n    return jsonify({\n        'success': success\n    })\n\n@app.route('/api/notifications/mark_all_read', methods=['POST'])\n@admin_required\ndef api_mark_all_notifications_read():\n    \"\"\"Markiert alle Benachrichtigungen als gelesen\"\"\"\n    csrf_token = request.json.get('csrf_token', '') if request.json else ''\n    if not validate_csrf_token(csrf_token):\n        return jsonify({\n            'success': False,\n            'error': 'Invalid CSRF token'\n        }), 403\n    \n    success = mark_all_notifications_as_read(recipient_role='admin')\n    return jsonify({\n        'success': success\n    })\n\nif __name__ == '__main__':\n    # Starte die Anwendung\n    app.run(host='0.0.0.0', port=5000, debug=True)\n","size_bytes":47970},"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"email-validator>=2.3.0\",\n    \"flask>=3.1.2\",\n    \"flask-sqlalchemy>=3.1.1\",\n    \"gunicorn>=23.0.0\",\n    \"psycopg2-binary>=2.9.11\",\n    \"pytz>=2025.2\",\n    \"werkzeug>=3.1.3\",\n]\n","size_bytes":323},"email_service.py":{"content":"import os\nimport smtplib\nimport json\nfrom email.mime.text import MIMEText\nfrom email.mime.multipart import MIMEMultipart\nfrom datetime import datetime\nfrom config import SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_FROM, ADMIN_EMAIL\n\n\ndef send_email_smtp(to_email, subject, body_html, body_text=None):\n    \"\"\"Sendet E-Mail über SMTP\"\"\"\n    try:\n        if not SMTP_USER or not SMTP_PASS:\n            print(f\"WARNUNG: SMTP nicht konfiguriert - E-Mail an {to_email} wird nicht gesendet\")\n            print(f\"Betreff: {subject}\")\n            print(f\"Body: {body_text or body_html[:200]}\")\n            return False\n        \n        message = MIMEMultipart('alternative')\n        message['From'] = SMTP_FROM\n        message['To'] = to_email\n        message['Subject'] = subject\n        \n        if body_text:\n            part1 = MIMEText(body_text, 'plain', 'utf-8')\n            message.attach(part1)\n        \n        part2 = MIMEText(body_html, 'html', 'utf-8')\n        message.attach(part2)\n        \n        server = smtplib.SMTP(SMTP_HOST, SMTP_PORT, timeout=10)\n        server.starttls()\n        server.login(SMTP_USER, SMTP_PASS)\n        server.send_message(message)\n        server.quit()\n        \n        print(f\"E-Mail erfolgreich gesendet an {to_email}\")\n        return True\n        \n    except Exception as e:\n        print(f\"FEHLER beim E-Mail-Versand an {to_email}: {e}\")\n        return False\n\n\ndef create_booking_notification_email(booking_data):\n    \"\"\"Erstellt eine formatierte E-Mail für Buchungsbenachrichtigungen\"\"\"\n    teacher_name = booking_data.get('teacher_name', 'Unbekannt')\n    teacher_class = booking_data.get('teacher_class', '')\n    date = booking_data.get('date', '')\n    weekday = booking_data.get('weekday', '')\n    period = booking_data.get('period', '')\n    offer_label = booking_data.get('offer_label', '')\n    offer_type = booking_data.get('offer_type', '')\n    \n    students = []\n    try:\n        students_json = booking_data.get('students_json', '[]')\n        if isinstance(students_json, str):\n            students = json.loads(students_json)\n        else:\n            students = students_json\n    except:\n        students = []\n    \n    students_count = len(students)\n    \n    if students:\n        students_names = ', '.join([f\"{s['name']} ({s['klasse']})\" for s in students])\n        students_list_html = '<br>'.join([f\"• {s['name']} (Klasse {s['klasse']})\" for s in students])\n    else:\n        students_names = 'Keine Schüler angegeben'\n        students_list_html = 'Keine Schüler angegeben'\n    \n    subject = f\"📅 SportOase Buchung: {offer_label} am {date}\"\n    \n    body_html = f\"\"\"\n    <html>\n    <head>\n        <style>\n            body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }}\n            .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}\n            .header {{ background: linear-gradient(135deg, #38bdf8 0%, #3b82f6 100%); \n                       color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }}\n            .header h2 {{ margin: 0; }}\n            .content {{ background: #f8f9fa; padding: 20px; border-radius: 8px; }}\n            .info-row {{ margin: 10px 0; padding: 12px; background: white; border-radius: 4px; border-left: 4px solid #38bdf8; }}\n            .label {{ font-weight: bold; color: #38bdf8; }}\n            .students-section {{ margin-top: 15px; padding: 15px; background: white; border-radius: 4px; }}\n            .footer {{ margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; \n                      text-align: center; color: #666; font-size: 12px; }}\n            .badge {{ background: #38bdf8; color: white; padding: 4px 10px; \n                     border-radius: 12px; font-size: 11px; margin-left: 8px; }}\n        </style>\n    </head>\n    <body>\n        <div class=\"container\">\n            <div class=\"header\">\n                <h2>🏫 SportOase - Neue Buchung</h2>\n            </div>\n            <div class=\"content\">\n                <div class=\"info-row\">\n                    <span class=\"label\">👤 Lehrkraft:</span> {teacher_name}\n                    {f' (Klasse {teacher_class})' if teacher_class else ''}\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">📅 Datum:</span> {date} ({weekday})\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">🕐 Stunde:</span> {period}. Stunde\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">📋 Angebot:</span> {offer_label}\n                    <span class=\"badge\">{offer_type.upper()}</span>\n                </div>\n                <div class=\"students-section\">\n                    <div><span class=\"label\">👥 Schüler ({students_count}):</span></div>\n                    <div style=\"margin-top: 10px; margin-left: 10px;\">\n                        {students_list_html}\n                    </div>\n                </div>\n            </div>\n            <div class=\"footer\">\n                <p>Diese Nachricht wurde automatisch vom SportOase Buchungssystem generiert.</p>\n                <p>Zeit: {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}</p>\n            </div>\n        </div>\n    </body>\n    </html>\n    \"\"\"\n    \n    body_text = f\"\"\"\nSportOase - Neue Buchung\n\nLehrkraft: {teacher_name} {f'(Klasse {teacher_class})' if teacher_class else ''}\nDatum: {date} ({weekday})\nStunde: {period}. Stunde\nAngebot: {offer_label} ({offer_type.upper()})\n\nSchüler ({students_count}):\n{students_names}\n\nZeit: {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}\n\n---\nDiese Nachricht wurde automatisch vom SportOase Buchungssystem generiert.\n    \"\"\"\n    \n    return subject, body_html, body_text\n\n\ndef send_booking_notification(booking_data, admin_email=None):\n    \"\"\"Sendet Buchungsbenachrichtigung an Admin\"\"\"\n    try:\n        if not admin_email:\n            admin_email = ADMIN_EMAIL\n        \n        subject, body_html, body_text = create_booking_notification_email(booking_data)\n        return send_email_smtp(admin_email, subject, body_html, body_text)\n        \n    except Exception as e:\n        print(f\"Fehler beim Senden der Buchungsbenachrichtigung: {e}\")\n        return False\n","size_bytes":6252},"static/style.css":{"content":"/* \n   SportOase Buchungssystem - Modern UI Design\n   Modernes, cleanes Design inspiriert von zeitgemäßen Web-Apps\n*/\n\n:root {\n    --primary: #38bdf8;\n    --primary-dark: #0ea5e9;\n    --primary-light: #e0f2fe;\n    --accent: #10B981;\n    --accent-warn: #F59E0B;\n    --text-primary: #0F172A;\n    --text-secondary: #64748B;\n    --text-tertiary: #94A3B8;\n    --bg-primary: #FFFFFF;\n    --bg-secondary: #F8FAFC;\n    --bg-tertiary: #F1F5F9;\n    --border: #E2E8F0;\n    --border-light: #F1F5F9;\n    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);\n    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);\n    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);\n    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);\n    --radius-sm: 6px;\n    --radius: 8px;\n    --radius-lg: 12px;\n    --radius-xl: 16px;\n}\n\n* {\n    margin: 0;\n    padding: 0;\n    box-sizing: border-box;\n}\n\nbody {\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', 'Roboto', 'Helvetica Neue', Arial, sans-serif;\n    line-height: 1.5;\n    color: var(--text-primary);\n    background: var(--bg-secondary);\n    -webkit-font-smoothing: antialiased;\n    -moz-osx-font-smoothing: grayscale;\n}\n\n.container {\n    max-width: 1400px;\n    margin: 0 auto;\n    padding: 0 2rem;\n}\n\n/* Top Navigation - Modern Minimal */\n.top-nav {\n    background: var(--bg-primary);\n    border-bottom: 1px solid var(--border);\n    padding: 0.75rem 0;\n    backdrop-filter: blur(10px);\n    position: sticky;\n    top: 0;\n    z-index: 100;\n}\n\n.top-nav nav {\n    display: flex;\n    gap: 0.5rem;\n    justify-content: flex-end;\n    align-items: center;\n}\n\n.top-nav nav a {\n    color: var(--text-secondary);\n    text-decoration: none;\n    padding: 0.5rem 1rem;\n    border-radius: var(--radius);\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    font-weight: 500;\n    font-size: 0.875rem;\n}\n\n.top-nav nav a:hover {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n}\n\n/* Main Content */\nmain {\n    min-height: 85vh;\n    padding: 2rem 0;\n}\n\nh2 {\n    font-size: 1.875rem;\n    font-weight: 700;\n    margin-bottom: 0.5rem;\n    color: var(--text-primary);\n    letter-spacing: -0.025em;\n}\n\nh3 {\n    font-size: 1.25rem;\n    font-weight: 600;\n    margin: 1rem 0 0.75rem 0;\n    color: var(--text-primary);\n}\n\nh4 {\n    font-size: 1rem;\n    font-weight: 600;\n    margin: 0.75rem 0 0.5rem 0;\n    color: var(--text-primary);\n}\n\n/* Flash Messages - Modern */\n.messages {\n    margin-bottom: 1.5rem;\n}\n\n.message {\n    padding: 0.875rem 1rem;\n    margin-bottom: 0.75rem;\n    border-radius: var(--radius);\n    font-size: 0.875rem;\n    font-weight: 500;\n    border-left: 3px solid;\n    background: var(--bg-primary);\n}\n\n.message-success {\n    border-color: var(--accent);\n    color: var(--accent);\n    background: #F0FDF4;\n}\n\n.message-error {\n    border-color: #EF4444;\n    color: #DC2626;\n    background: #FEF2F2;\n}\n\n/* Login Page - Modern Centered Card */\n.login-container {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    min-height: 100vh;\n    background: linear-gradient(135deg, #7dd3fc 0%, #38bdf8 100%);\n    padding: 1rem;\n}\n\n.login-box {\n    background: var(--bg-primary);\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-lg);\n    padding: 2.5rem;\n    width: 100%;\n    max-width: 420px;\n}\n\n.login-logo {\n    text-align: center;\n    margin-bottom: 2rem;\n}\n\n.login-logo img {\n    width: 200px;\n    height: 200px;\n    border-radius: 50%;\n    box-shadow: var(--shadow-md);\n}\n\n.login-box h2 {\n    text-align: center;\n    font-size: 1.5rem;\n    margin-bottom: 2rem;\n    color: var(--text-primary);\n}\n\n/* Form Inputs - Modern */\n.form-group {\n    margin-bottom: 1.25rem;\n}\n\n.form-group label {\n    display: block;\n    margin-bottom: 0.5rem;\n    font-weight: 500;\n    font-size: 0.875rem;\n    color: var(--text-primary);\n}\n\n.form-group input,\n.form-group select,\n.form-group textarea {\n    width: 100%;\n    padding: 0.75rem;\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    font-size: 0.875rem;\n    transition: all 0.2s;\n    background: var(--bg-primary);\n    color: var(--text-primary);\n}\n\n.form-group input:focus,\n.form-group select:focus,\n.form-group textarea:focus {\n    outline: none;\n    border-color: var(--primary);\n    box-shadow: 0 0 0 3px var(--primary-light);\n}\n\n/* Buttons - Modern Minimal */\n.btn, button[type=\"submit\"] {\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    padding: 0.625rem 1.25rem;\n    font-size: 0.875rem;\n    font-weight: 500;\n    border-radius: var(--radius);\n    border: none;\n    cursor: pointer;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    text-decoration: none;\n    gap: 0.5rem;\n}\n\n.btn-primary {\n    background: var(--primary);\n    color: white;\n}\n\n.btn-primary:hover {\n    background: var(--primary-dark);\n    transform: translateY(-1px);\n    box-shadow: var(--shadow-md);\n}\n\n.btn-secondary {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n}\n\n.btn-secondary:hover {\n    background: var(--border);\n}\n\n.btn-success {\n    background: var(--accent);\n    color: white;\n}\n\n.btn-success:hover {\n    background: #059669;\n}\n\n.btn-block {\n    background: #EF4444;\n    color: white;\n    font-size: 0.75rem;\n    padding: 0.375rem 0.75rem;\n}\n\n.btn-block:hover {\n    background: #DC2626;\n}\n\n.btn-small {\n    font-size: 0.75rem;\n    padding: 0.375rem 0.75rem;\n}\n\n/* Dashboard */\n.dashboard {\n    max-width: 100%;\n}\n\n.dashboard > h2 {\n    margin-bottom: 2rem;\n}\n\n/* Date Selector - Modern */\n.date-selector {\n    background: var(--bg-primary);\n    padding: 1rem;\n    border-radius: var(--radius-lg);\n    margin-bottom: 1.5rem;\n    box-shadow: var(--shadow-sm);\n    border: 1px solid var(--border);\n}\n\n.date-selector form {\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n}\n\n.date-selector label {\n    font-weight: 500;\n    font-size: 0.875rem;\n    color: var(--text-secondary);\n}\n\n.date-selector input {\n    padding: 0.5rem 0.75rem;\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    font-size: 0.875rem;\n    background: var(--bg-primary);\n    cursor: pointer;\n    transition: all 0.2s;\n}\n\n.date-selector input:hover {\n    border-color: var(--primary);\n}\n\n/* Selected Date Info */\n.selected-date-info {\n    margin-bottom: 2rem;\n}\n\n.selected-date-info h3 {\n    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);\n    color: white;\n    padding: 1rem 1.5rem;\n    margin: 0;\n    border-radius: var(--radius-lg);\n    text-align: center;\n    font-size: 1.125rem;\n    font-weight: 600;\n    box-shadow: var(--shadow-md);\n}\n\n/* Week Overview - Modern Card */\n.week-overview {\n    background: var(--bg-primary);\n    padding: 1.5rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-sm);\n    margin-bottom: 2rem;\n    border: 1px solid var(--border);\n}\n\n.week-header-with-nav {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-bottom: 1.5rem;\n    padding-bottom: 1rem;\n    border-bottom: 1px solid var(--border-light);\n    gap: 1rem;\n}\n\n.week-header-with-nav h3 {\n    color: var(--text-primary);\n    font-size: 1rem;\n    font-weight: 600;\n    margin: 0;\n    padding: 0;\n    border: none;\n    flex: 1;\n    text-align: center;\n}\n\n.week-nav-arrow {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 36px;\n    height: 36px;\n    background: var(--bg-tertiary);\n    color: var(--text-secondary);\n    border-radius: var(--radius);\n    text-decoration: none;\n    transition: all 0.2s;\n    flex-shrink: 0;\n    border: 1px solid var(--border);\n}\n\n.week-nav-arrow:hover {\n    background: var(--primary);\n    color: white;\n    border-color: var(--primary);\n}\n\n.week-nav-arrow .arrow-icon {\n    font-size: 1rem;\n}\n\n/* Week Table - Modern Grid */\n.week-table {\n    width: 100%;\n    border-collapse: separate;\n    border-spacing: 0;\n    margin-top: 0;\n}\n\n.week-table th,\n.week-table td {\n    padding: 0.75rem;\n    text-align: center;\n    vertical-align: top;\n    border: 1px solid var(--border-light);\n}\n\n.week-table th {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n    font-weight: 600;\n    font-size: 0.75rem;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    border-bottom: 2px solid var(--border);\n}\n\n.week-table th:first-child {\n    border-top-left-radius: var(--radius);\n}\n\n.week-table th:last-child {\n    border-top-right-radius: var(--radius);\n}\n\n.week-day-header {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n}\n\n.day-name {\n    font-size: 0.875rem;\n    font-weight: 700;\n    letter-spacing: 0.05em;\n}\n\n.day-date {\n    font-size: 0.75rem;\n    opacity: 0.7;\n    font-weight: 500;\n}\n\n.week-table td {\n    font-size: 0.8125rem;\n    background: var(--bg-primary);\n    transition: all 0.2s;\n}\n\n.week-table td:hover {\n    background: var(--bg-secondary);\n}\n\n/* Period Styles */\n.period-header {\n    font-weight: 600;\n    margin-bottom: 0.625rem;\n    padding: 0.5rem;\n    border-radius: var(--radius-sm);\n    font-size: 0.75rem;\n    text-align: center;\n}\n\n.period-fest .period-header {\n    background: #FEF3C7;\n    color: #92400E;\n}\n\n.period-frei .period-header {\n    background: #D1FAE5;\n    color: #065F46;\n}\n\n.period-blocked {\n    background: #FEE2E2 !important;\n}\n\n.period-blocked:hover {\n    background: #FECACA !important;\n}\n\n.blocked-header {\n    background: #FEE2E2;\n    color: #991B1B;\n    border: 1px solid #FCA5A5;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: 0.25rem;\n}\n\n.blocked-icon {\n    font-size: 1.5rem;\n    font-weight: bold;\n    color: #DC2626;\n}\n\n.period-past {\n    opacity: 0.5;\n    background: var(--bg-secondary) !important;\n}\n\n.slot-detail {\n    font-size: 0.6875rem;\n    font-weight: 400;\n    margin-top: 0.25rem;\n    opacity: 0.8;\n}\n\n/* Booking Info - Optimized */\n.booking-info {\n    margin-top: 0.5rem;\n    padding: 0.5rem;\n    background: var(--bg-secondary);\n    border-radius: var(--radius-sm);\n    font-size: 0.6875rem;\n    text-align: left;\n}\n\n.slot-stat {\n    font-weight: 600;\n    color: var(--text-secondary);\n    margin-bottom: 0.375rem;\n    text-align: center;\n}\n\n.booking-entry {\n    margin-top: 0.375rem;\n    padding-top: 0.375rem;\n    border-top: 1px solid var(--border-light);\n}\n\n.booking-entry:first-child {\n    margin-top: 0;\n    padding-top: 0;\n    border-top: none;\n}\n\n.booking-title {\n    font-weight: 600;\n    color: var(--text-primary);\n    margin-bottom: 0.25rem;\n}\n\n.student-name {\n    font-size: 0.6875rem;\n    color: var(--text-secondary);\n    margin-left: 0.5rem;\n}\n\n/* Slot Actions - All Buttons Equal Size */\n.slot-actions {\n    margin-top: 0.625rem;\n    display: flex;\n    flex-direction: column;\n    gap: 0.375rem;\n}\n\n.slot-actions form {\n    margin: 0;\n}\n\n.slot-btn {\n    display: block;\n    width: 100%;\n    padding: 0.5rem 0.75rem;\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-align: center;\n    border-radius: var(--radius-sm);\n    border: none;\n    cursor: pointer;\n    transition: all 0.2s;\n    text-decoration: none;\n}\n\n.slot-btn-primary {\n    background: var(--primary);\n    color: white;\n}\n\n.slot-btn-primary:hover {\n    background: var(--primary-dark);\n}\n\n.slot-btn-success {\n    background: var(--accent);\n    color: white;\n}\n\n.slot-btn-success:hover {\n    background: #059669;\n}\n\n.slot-btn-block {\n    background: #DC2626;\n    color: white;\n}\n\n.slot-btn-block:hover {\n    background: #B91C1C;\n}\n\n.slot-btn-disabled {\n    background: var(--bg-tertiary);\n    color: var(--text-tertiary);\n    cursor: not-allowed;\n}\n\n/* Day Schedule - Modern Table */\n.day-schedule {\n    background: var(--bg-primary);\n    padding: 1.5rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-sm);\n    border: 1px solid var(--border);\n}\n\n.day-schedule h3 {\n    margin-bottom: 1.25rem;\n    font-size: 1.125rem;\n}\n\n.schedule-table {\n    width: 100%;\n    border-collapse: separate;\n    border-spacing: 0;\n}\n\n.schedule-table th,\n.schedule-table td {\n    padding: 0.875rem;\n    text-align: left;\n    border-bottom: 1px solid var(--border-light);\n}\n\n.schedule-table th {\n    background: var(--bg-tertiary);\n    color: var(--text-secondary);\n    font-weight: 600;\n    font-size: 0.75rem;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n}\n\n.schedule-table tbody tr:hover {\n    background: var(--bg-secondary);\n}\n\n.schedule-table tbody tr:last-child td {\n    border-bottom: none;\n}\n\n.blocked-row {\n    background: #FEF2F2 !important;\n}\n\n.past-row {\n    opacity: 0.5;\n}\n\n.unbookable-row {\n    opacity: 0.6;\n    background: var(--bg-tertiary) !important;\n    pointer-events: none;\n}\n\n.unbookable-row td {\n    color: var(--text-tertiary);\n}\n\n.weekend-row {\n    opacity: 0.5;\n    background: #FEF3C7 !important;\n}\n\n.time-restricted-row {\n    opacity: 0.65;\n    background: #FEF3C7 !important;\n}\n\n.capacity {\n    display: inline-block;\n    padding: 0.25rem 0.625rem;\n    background: var(--bg-tertiary);\n    border-radius: var(--radius-sm);\n    font-size: 0.8125rem;\n    font-weight: 500;\n}\n\n.capacity.full {\n    background: #FEE2E2;\n    color: #991B1B;\n}\n\n.blocked-text {\n    color: #DC2626;\n    font-weight: 600;\n}\n\n.time-message {\n    color: var(--text-tertiary);\n    font-size: 0.75rem;\n    font-style: italic;\n    margin-top: 0.25rem;\n}\n\n/* Booking Form - Modern */\n.booking-form {\n    background: var(--bg-primary);\n    padding: 2rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-sm);\n    border: 1px solid var(--border);\n    max-width: 600px;\n    margin: 0 auto;\n}\n\n.booking-info-box {\n    background: var(--bg-secondary);\n    padding: 1rem;\n    border-radius: var(--radius);\n    margin-bottom: 1.5rem;\n    border-left: 3px solid var(--primary);\n}\n\n.student-list {\n    list-style: none;\n    margin-bottom: 1.5rem;\n}\n\n.student-item {\n    display: flex;\n    gap: 0.75rem;\n    margin-bottom: 0.75rem;\n}\n\n.student-item input {\n    flex: 1;\n}\n\n.btn-remove {\n    padding: 0.5rem 0.75rem;\n    background: #FEE2E2;\n    color: #DC2626;\n    border: none;\n    border-radius: var(--radius);\n    cursor: pointer;\n    font-size: 0.875rem;\n    transition: all 0.2s;\n}\n\n.btn-remove:hover {\n    background: #FEF2F2;\n}\n\n.btn-add {\n    padding: 0.5rem 1rem;\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n    border: 1px dashed var(--border);\n    border-radius: var(--radius);\n    cursor: pointer;\n    font-size: 0.875rem;\n    font-weight: 500;\n    transition: all 0.2s;\n}\n\n.btn-add:hover {\n    border-color: var(--primary);\n    background: var(--primary-light);\n    color: var(--primary);\n}\n\n/* Admin Panel - Modern Layout */\n.admin-panel {\n    display: grid;\n    gap: 1.5rem;\n}\n\n.admin-section {\n    background: var(--bg-primary);\n    padding: 1.5rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-sm);\n    border: 1px solid var(--border);\n}\n\n.admin-section h3 {\n    margin-bottom: 1.25rem;\n    padding-bottom: 0.75rem;\n    border-bottom: 1px solid var(--border-light);\n}\n\n.user-list,\n.booking-list {\n    list-style: none;\n}\n\n.user-item,\n.booking-item {\n    padding: 0.875rem;\n    border-bottom: 1px solid var(--border-light);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.user-item:last-child,\n.booking-item:last-child {\n    border-bottom: none;\n}\n\n.user-item:hover,\n.booking-item:hover {\n    background: var(--bg-secondary);\n}\n\n.badge {\n    display: inline-block;\n    padding: 0.25rem 0.625rem;\n    border-radius: var(--radius-sm);\n    font-size: 0.75rem;\n    font-weight: 600;\n}\n\n.badge-admin {\n    background: #DBEAFE;\n    color: #1E40AF;\n}\n\n.badge-teacher {\n    background: #D1FAE5;\n    color: #065F46;\n}\n\n/* Filter Form */\n.filter-form {\n    display: flex;\n    gap: 0.75rem;\n    margin-bottom: 1.5rem;\n    align-items: flex-end;\n}\n\n/* Responsive - Mobile Optimierung */\n@media (max-width: 768px) {\n    /* Container & Spacing */\n    .container {\n        padding: 0 0.75rem;\n    }\n    \n    main {\n        padding: 1rem 0;\n    }\n    \n    /* Typography */\n    h2 {\n        font-size: 1.5rem;\n    }\n    \n    h3 {\n        font-size: 1.125rem;\n    }\n    \n    /* Login Page */\n    .login-container {\n        padding: 0.5rem;\n    }\n    \n    .login-box {\n        padding: 1.5rem 1rem;\n        max-width: 100%;\n    }\n    \n    .login-logo img {\n        width: 120px;\n        height: 120px;\n    }\n    \n    /* Navigation */\n    .top-nav {\n        padding: 0.5rem 0;\n    }\n    \n    .top-nav nav {\n        flex-wrap: wrap;\n        gap: 0.25rem;\n    }\n    \n    .top-nav nav a {\n        font-size: 0.8125rem;\n        padding: 0.4rem 0.75rem;\n    }\n    \n    /* Buttons - Größer für Touch */\n    .btn, button[type=\"submit\"] {\n        padding: 0.75rem 1rem;\n        font-size: 0.9375rem;\n        min-height: 44px;\n    }\n    \n    .btn-small {\n        padding: 0.5rem 0.75rem;\n        font-size: 0.8125rem;\n    }\n    \n    /* Form Inputs - Größer für Touch */\n    .form-group input,\n    .form-group select,\n    .form-group textarea {\n        padding: 0.875rem;\n        font-size: 1rem;\n        min-height: 44px;\n    }\n    \n    /* Date Selector */\n    .date-selector {\n        padding: 0.75rem;\n    }\n    \n    .date-selector form {\n        flex-direction: column;\n        gap: 0.5rem;\n    }\n    \n    .date-selector input {\n        width: 100%;\n    }\n    \n    /* Week Overview */\n    .week-overview {\n        padding: 0.75rem;\n        overflow-x: auto;\n        -webkit-overflow-scrolling: touch;\n    }\n    \n    .week-header-with-nav {\n        flex-wrap: nowrap;\n        gap: 0.5rem;\n        margin-bottom: 1rem;\n    }\n    \n    .week-header-with-nav h3 {\n        font-size: 0.75rem;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n    }\n    \n    .week-nav-arrow {\n        width: 32px;\n        height: 32px;\n        min-width: 32px;\n    }\n    \n    /* Week Table - Horizontal Scroll */\n    .week-table {\n        min-width: 600px;\n        font-size: 0.6875rem;\n    }\n    \n    .week-table th,\n    .week-table td {\n        padding: 0.375rem 0.25rem;\n        font-size: 0.6875rem;\n    }\n    \n    .day-name {\n        font-size: 0.75rem;\n    }\n    \n    .day-date {\n        font-size: 0.6875rem;\n    }\n    \n    .period-header {\n        font-size: 0.6875rem;\n        padding: 0.375rem;\n        margin-bottom: 0.5rem;\n    }\n    \n    .booking-info {\n        font-size: 0.625rem;\n        padding: 0.375rem;\n        margin-top: 0.375rem;\n    }\n    \n    .slot-stat {\n        font-size: 0.625rem;\n        margin-bottom: 0.25rem;\n    }\n    \n    .booking-entry {\n        margin-top: 0.25rem;\n        padding-top: 0.25rem;\n    }\n    \n    .booking-title {\n        font-size: 0.625rem;\n    }\n    \n    .student-name {\n        font-size: 0.5625rem;\n    }\n    \n    .slot-actions {\n        gap: 0.25rem;\n        margin-top: 0.5rem;\n    }\n    \n    .slot-btn {\n        padding: 0.375rem 0.5rem;\n        font-size: 0.625rem;\n        min-height: 28px;\n    }\n    \n    /* Day Schedule */\n    .day-schedule {\n        padding: 1rem;\n        overflow-x: auto;\n        -webkit-overflow-scrolling: touch;\n    }\n    \n    .schedule-table {\n        min-width: 600px;\n        font-size: 0.8125rem;\n    }\n    \n    .schedule-table th,\n    .schedule-table td {\n        padding: 0.625rem 0.5rem;\n        font-size: 0.8125rem;\n    }\n    \n    /* Booking Form */\n    .booking-form {\n        padding: 1rem;\n    }\n    \n    .booking-info-box {\n        padding: 0.75rem;\n        margin-bottom: 1rem;\n    }\n    \n    .booking-info-box h3 {\n        font-size: 1rem;\n        margin-bottom: 0.75rem;\n    }\n    \n    .booking-info-box p {\n        font-size: 0.875rem;\n        margin-bottom: 0.5rem;\n    }\n    \n    .student-list {\n        margin-bottom: 1rem;\n    }\n    \n    .student-item {\n        margin-bottom: 0.75rem;\n    }\n    \n    /* Admin Panel */\n    .admin-section {\n        padding: 1rem;\n    }\n    \n    .user-item,\n    .booking-item {\n        padding: 0.75rem;\n        flex-direction: column;\n        align-items: flex-start;\n        gap: 0.5rem;\n    }\n    \n    /* Filter Form */\n    .filter-form {\n        flex-direction: column;\n        align-items: stretch;\n    }\n    \n    /* Selected Date Info */\n    .selected-date-info h3 {\n        font-size: 1rem;\n        padding: 0.75rem 1rem;\n    }\n    \n    /* Credits Button - Kleiner auf Mobile */\n    .credits-button {\n        width: 44px;\n        height: 44px;\n        bottom: 15px;\n        right: 15px;\n        font-size: 1.25rem;\n    }\n    \n    .credits-content {\n        width: 95%;\n        margin: 15% auto;\n        padding: 1.5rem;\n    }\n    \n    .credits-content h3 {\n        font-size: 1.25rem;\n        margin-bottom: 1rem;\n    }\n    \n    .credits-content p {\n        font-size: 0.875rem;\n    }\n    \n    .credits-close {\n        font-size: 1.75rem;\n        right: 1rem;\n        top: 1rem;\n    }\n    \n    /* Messages */\n    .messages {\n        margin-bottom: 1rem;\n    }\n    \n    .message {\n        padding: 0.75rem;\n        font-size: 0.8125rem;\n    }\n}\n\n/* Extra Small Devices */\n@media (max-width: 480px) {\n    .container {\n        padding: 0 0.5rem;\n    }\n    \n    h2 {\n        font-size: 1.25rem;\n    }\n    \n    .login-logo img {\n        width: 100px;\n        height: 100px;\n    }\n    \n    .week-header-with-nav h3 {\n        font-size: 0.6875rem;\n    }\n    \n    .week-nav-arrow {\n        width: 28px;\n        height: 28px;\n        min-width: 28px;\n    }\n    \n    .credits-button {\n        width: 40px;\n        height: 40px;\n        bottom: 10px;\n        right: 10px;\n        font-size: 1.125rem;\n    }\n}\n\n/* Credits Button */\n.credits-button {\n    position: fixed;\n    bottom: 20px;\n    right: 20px;\n    width: 50px;\n    height: 50px;\n    background: var(--primary);\n    color: white;\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1.5rem;\n    font-weight: bold;\n    cursor: pointer;\n    box-shadow: var(--shadow-lg);\n    transition: all 0.3s ease;\n    z-index: 1000;\n}\n\n.credits-button:hover {\n    background: var(--primary-dark);\n    transform: scale(1.1);\n}\n\n/* Credits Modal */\n.credits-modal {\n    display: none;\n    position: fixed;\n    z-index: 1001;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0, 0, 0, 0.5);\n    backdrop-filter: blur(4px);\n}\n\n.credits-content {\n    background-color: var(--bg-primary);\n    margin: 10% auto;\n    padding: 2rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-lg);\n    width: 90%;\n    max-width: 500px;\n    position: relative;\n}\n\n.credits-content h3 {\n    margin-top: 0;\n    margin-bottom: 1.5rem;\n    color: var(--text-primary);\n    font-size: 1.5rem;\n}\n\n.credits-content p {\n    margin-bottom: 1rem;\n    color: var(--text-secondary);\n    line-height: 1.6;\n}\n\n.credits-close {\n    position: absolute;\n    right: 1.5rem;\n    top: 1.5rem;\n    color: var(--text-tertiary);\n    font-size: 2rem;\n    font-weight: bold;\n    cursor: pointer;\n    transition: color 0.2s;\n}\n\n.credits-close:hover {\n    color: var(--text-primary);\n}\n\n/* Footer */\nfooter {\n    background: var(--bg-primary);\n    border-top: 1px solid var(--border);\n    padding: 2rem 0;\n    margin-top: 4rem;\n    text-align: center;\n    color: var(--text-tertiary);\n    font-size: 0.875rem;\n}\n\n/* Notification System Styles */\n.notification-container {\n    position: relative;\n    display: inline-block;\n    margin: 0 10px;\n}\n\n.notification-bell {\n    background: none;\n    border: none;\n    font-size: 1.5rem;\n    cursor: pointer;\n    position: relative;\n    padding: 5px;\n    transition: transform 0.2s ease;\n}\n\n.notification-bell:hover {\n    transform: scale(1.1);\n}\n\n.notification-badge {\n    position: absolute;\n    top: -5px;\n    right: -5px;\n    background: var(--danger);\n    color: white;\n    border-radius: 12px;\n    padding: 2px 6px;\n    font-size: 0.75rem;\n    font-weight: bold;\n    min-width: 18px;\n    text-align: center;\n}\n\n.notification-dropdown {\n    display: none;\n    position: absolute;\n    top: 100%;\n    right: 0;\n    background: var(--bg-primary);\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    box-shadow: var(--shadow-lg);\n    min-width: 350px;\n    max-width: 400px;\n    max-height: 500px;\n    overflow: hidden;\n    z-index: 1000;\n    margin-top: 10px;\n}\n\n.notification-header {\n    padding: 1rem;\n    border-bottom: 1px solid var(--border);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.notification-header h4 {\n    margin: 0;\n    font-size: 1rem;\n    color: var(--text-primary);\n}\n\n.mark-all-read {\n    background: none;\n    border: none;\n    color: var(--primary);\n    cursor: pointer;\n    font-size: 0.875rem;\n    padding: 4px 8px;\n    border-radius: var(--radius-sm);\n    transition: background 0.2s;\n}\n\n.mark-all-read:hover {\n    background: var(--bg-secondary);\n}\n\n.notification-list {\n    max-height: 400px;\n    overflow-y: auto;\n}\n\n.notification-item {\n    padding: 1rem;\n    border-bottom: 1px solid var(--border);\n    display: flex;\n    justify-content: space-between;\n    align-items: flex-start;\n    transition: background 0.2s;\n}\n\n.notification-item:hover {\n    background: var(--bg-secondary);\n}\n\n.notification-item.read {\n    opacity: 0.6;\n}\n\n.notification-content {\n    flex: 1;\n}\n\n.notification-message {\n    margin: 0 0 0.5rem 0;\n    color: var(--text-primary);\n    font-size: 0.875rem;\n    line-height: 1.5;\n}\n\n.notification-time {\n    color: var(--text-tertiary);\n    font-size: 0.75rem;\n}\n\n.mark-read-btn {\n    background: var(--primary);\n    color: white;\n    border: none;\n    border-radius: 50%;\n    width: 24px;\n    height: 24px;\n    cursor: pointer;\n    font-size: 0.875rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: all 0.2s;\n    margin-left: 10px;\n    flex-shrink: 0;\n}\n\n.mark-read-btn:hover {\n    background: var(--primary-dark);\n    transform: scale(1.1);\n}\n\n.no-notifications {\n    padding: 2rem;\n    text-align: center;\n    color: var(--text-tertiary);\n    font-size: 0.875rem;\n}\n","size_bytes":26003},"replit.md":{"content":"# SportOase - IServ Module\n\n## Overview\n\nSportOase is a **PHP/Symfony-based IServ module** for booking school sports facilities. It's designed to integrate directly into IServ 3.0+ servers and provides comprehensive booking management for teachers and administrators. The module features a weekly schedule view, capacity controls, email notifications, and full admin controls for managing bookings and users.\n\n**Important**: This is now an IServ module, not a standalone Replit application. It must be deployed to an IServ server.\n\n## Recent Changes\n\n**November 22, 2025**: Complete conversion from Flask/Python to PHP/Symfony IServ module structure.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## Project Architecture\n\n### Technology Stack\n\n- **Framework**: Symfony 6.4+ (PHP 8.0+)\n- **Database**: PostgreSQL with Doctrine ORM\n- **Templates**: Twig (replacing Jinja2)\n- **IServ Integration**: Manifest-based module with SSO support\n- **Timezone**: Europe/Berlin\n\n### Module Structure\n\n```\nsportoase/\n├── src/\n│   ├── SportOaseBundle.php        # Main Symfony bundle\n│   ├── Controller/                 # Request handlers\n│   │   ├── DashboardController.php\n│   │   ├── BookingController.php\n│   │   └── AdminController.php\n│   ├── Entity/                     # Doctrine entities (database models)\n│   │   ├── User.php\n│   │   ├── Booking.php\n│   │   ├── SlotName.php\n│   │   ├── BlockedSlot.php\n│   │   └── Notification.php\n│   └── Service/                    # Business logic\n│       ├── BookingService.php\n│       └── EmailService.php\n├── templates/                      # Twig templates\n│   └── sportoase/\n│       ├── base.html.twig\n│       ├── dashboard.html.twig\n│       ├── booking/\n│       └── admin/\n├── migrations/                     # Database schema migrations\n├── config/                         # Symfony configuration\n│   ├── routes.yaml\n│   └── services.yaml\n├── composer.json                   # PHP dependencies\n└── manifest.xml                    # IServ module manifest\n```\n\n### Database Schema\n\nUsing Doctrine ORM with PostgreSQL:\n\n- **sportoase_users** - User accounts linked to IServ accounts (username, email, role)\n- **sportoase_bookings** - Booking records (date, period, teacher, students as JSON, offer details)\n- **sportoase_slot_names** - Custom labels for fixed time slots\n- **sportoase_blocked_slots** - Admin-managed blocked time slots with reasons\n- **sportoase_notifications** - Notification history for admins\n\n### Authentication & Authorization\n\n- **IServ SSO Integration**: Automatic user sync with IServ accounts\n- **Role-based Access**: Two roles defined in User entity:\n  - `teacher` - Can create and manage their own bookings\n  - `admin` - Full access to all bookings, users, and system settings\n- **Session Management**: Symfony security component handles sessions\n\n### Controllers & Routes\n\n1. **DashboardController** (`/sportoase`) - Weekly schedule view\n2. **BookingController** (`/sportoase/booking/*`) - Create, view, delete bookings\n3. **AdminController** (`/admin/sportoase/*`) - Admin panel, user management, slot management\n\nAll routes defined in `config/routes.yaml` and registered via `manifest.xml`.\n\n### Services\n\n- **BookingService** - Core booking logic (validation, capacity checks, double-booking prevention)\n- **EmailService** - SMTP-based notifications for new bookings\n\n### Key Features\n\n- **IServ SSO Integration** - Seamless login through IServ accounts\n- **Weekly Schedule Management** - View and book time slots across the week\n- **Capacity Management** - Automatic enforcement of student limits (default: 5 per slot)\n- **Double-booking Prevention** - Checks for student conflicts across bookings\n- **Admin Panel** - Comprehensive booking and user management\n- **Email Notifications** - SMTP-based alerts for new bookings\n- **Slot Blocking** - Admins can block specific slots for special purposes\n- **Custom Slot Names** - Customizable labels for recurring activities\n\n### Known Issues & Future Improvements\n\n- **Booking Form Usability**: Current booking form uses JSON textarea for student data. Should be refactored to use structured form fields (repeated name/class inputs) for better user experience and validation.\n- **Form Validation**: Needs server-side validation with clear error messages for student data\n- **Twig Namespace Registration**: Bundle must properly register template paths for `@SportOase` namespace\n\n### Configuration\n\nModule settings managed via IServ admin panel or environment variables:\n\n- `MAX_STUDENTS_PER_PERIOD` - Maximum students per slot (default: 5)\n- `BOOKING_ADVANCE_MINUTES` - Minimum advance time for bookings (default: 60)\n- `ENABLE_NOTIFICATIONS` - Email notification toggle\n- `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS` - Email configuration\n- `ADMIN_EMAIL` - Notification recipient (sportoase.kg@gmail.com)\n\n### Time Periods\n\nFixed 6-period school day (customizable in `BookingService.php`):\n\n1. 07:50 - 08:35\n2. 08:35 - 09:20\n3. 09:40 - 10:25\n4. 10:30 - 11:15\n5. 11:20 - 12:05\n6. 12:10 - 12:55\n\n## Deployment\n\n### To IServ Server\n\n1. **Package as Debian Package**: `dpkg-buildpackage -us -uc`\n2. **Install on IServ**: `aptitude install iserv3-sportoase`\n3. **Run Migrations**: `php bin/console doctrine:migrations:migrate`\n4. **Enable Module**: Via IServ admin panel\n\n### Local Development\n\n```bash\ncomposer install\nphp bin/console doctrine:migrations:migrate\nsymfony serve\n```\n\n## External Dependencies\n\n- **Symfony** 6.4+ - Web framework\n- **Doctrine ORM** - Database abstraction\n- **Twig** - Template engine\n- **Symfony Mailer** - Email sending\n- **PostgreSQL** - Database server\n- **IServ API** - Authentication and user management\n\n## Migration from Flask\n\n**Completed November 22, 2025**: All Flask/Python code removed. Project now uses PHP/Symfony architecture exclusively.\n","size_bytes":6056},"db_setup.py":{"content":"# Skript zur Initialisierung der PostgreSQL-Datenbank\n# Dieses Skript erstellt die Datenbank und legt einen Admin-Benutzer an\n\nimport os\nfrom app import app\nfrom models import create_user, get_user_by_username\nfrom database import db\n\ndef setup_database():\n    \"\"\"Initialisiert die Datenbank und erstellt einen Standard-Admin-Account\"\"\"\n    with app.app_context():\n        print(\"Erstelle Datenbank-Tabellen...\")\n        db.create_all()\n        print(\"Datenbank-Tabellen erfolgreich erstellt!\")\n        \n        # Prüfe, ob bereits ein Admin existiert\n        admin = get_user_by_username('sportoase')\n        if not admin:\n            # Erstelle Standard-Admin mit korrekter E-Mail\n            admin_id = create_user('sportoase', 'mauro123', 'admin', 'sportoase.kg@gmail.com')\n            if admin_id:\n                print(f\"\\nAdmin-Account erstellt:\")\n                print(f\"  Benutzername: sportoase\")\n                print(f\"  Passwort: mauro123\")\n                print(f\"  E-Mail: sportoase.kg@gmail.com\")\n            else:\n                print(\"\\nFehler: Admin-Account konnte nicht erstellt werden.\")\n        else:\n            print(\"\\nAdmin-Account existiert bereits.\")\n        \n        print(\"\\nDatenbank-Setup abgeschlossen!\")\n        print(\"Sie können sich jetzt mit den Admin-Zugangsdaten anmelden.\")\n\nif __name__ == '__main__':\n    setup_database()\n","size_bytes":1366},"config.py":{"content":"# Konfigurationsdatei für die SportOase-Anwendung\n# Diese Datei enthält alle wichtigen Einstellungen wie Stundenpläne und Zeitangaben\n\nimport os\n\n# Zeitplan der Schulstunden (Beginn und Ende jeder Stunde)\n# Format: \"HH:MM\" für Start und Ende\nPERIOD_TIMES = {\n    1: {\"start\": \"07:50\", \"end\": \"08:35\"},\n    2: {\"start\": \"08:35\", \"end\": \"09:20\"},\n    3: {\"start\": \"09:40\", \"end\": \"10:25\"},\n    4: {\"start\": \"10:25\", \"end\": \"11:20\"},\n    5: {\"start\": \"11:40\", \"end\": \"12:25\"},\n    6: {\"start\": \"12:25\", \"end\": \"13:10\"}\n}\n\n# Feste Angebote pro Wochentag und Stunde\n# \"Mon\" = Montag, \"Tue\" = Dienstag, etc.\n# Wenn eine Stunde hier nicht aufgeführt ist, ist sie FREI (Lehrkraft wählt Modul)\nFIXED_OFFERS = {\n    \"Mon\": {  # Montag\n        1: \"Wochenstart-Aktivierung\",\n        3: \"Konflikt-Reset & Deeskalation\",\n        5: \"Koordinationszirkel\"\n    },\n    \"Tue\": {  # Dienstag - alle Stunden frei\n    },\n    \"Wed\": {  # Mittwoch\n        1: \"Sozialtraining / Gruppenreset\",\n        3: \"Aktivierung Mini-Fitness\",\n        5: \"Motorik-Parcours\"\n    },\n    \"Thu\": {  # Donnerstag\n        2: \"Konflikt-Reset\",\n        5: \"Turnen + Balance\"\n    },\n    \"Fri\": {  # Freitag\n        2: \"Atem & Reflexion\",\n        4: \"Bodyscan Light\",\n        5: \"Ruhezone / Entspannung\"\n    }\n}\n\n# Module, die bei freien Stunden wählbar sind\nFREE_MODULES = [\n    \"Aktivierung\",\n    \"Regulation / Entspannung\",\n    \"Konflikt-Reset\",\n    \"Egal / flexibel\"\n]\n\n# Maximale Anzahl Schüler pro Stunde\nMAX_STUDENTS_PER_PERIOD = 5\n\n# Vorlaufzeit für Buchungen in Minuten\nBOOKING_ADVANCE_MINUTES = 60\n\n# SMTP-Konfiguration (aus Umgebungsvariablen)\nSMTP_HOST = os.environ.get('SMTP_HOST', 'smtp.gmail.com')\nSMTP_PORT = int(os.environ.get('SMTP_PORT', '587'))\nSMTP_USER = os.environ.get('SMTP_USER', '')\nSMTP_PASS = os.environ.get('SMTP_PASS', '')\nSMTP_FROM = os.environ.get('SMTP_FROM', 'sportoase.kg@gmail.com')\nADMIN_EMAIL = os.environ.get('ADMIN_EMAIL', 'sportoase.kg@gmail.com')\n\n# Flask Session Secret (aus Umgebungsvariable)\nSECRET_KEY = os.environ.get('SESSION_SECRET', 'dev-secret-key-change-in-production')\n\n# Datenbank-Konfiguration (PostgreSQL)\nDATABASE_URL = os.environ.get('DATABASE_URL', 'postgresql://localhost/sportoase')\n","size_bytes":2206},"main.py":{"content":"def main():\n    print(\"Hello from repl-nix-workspace!\")\n\n\nif __name__ == \"__main__\":\n    main()\n","size_bytes":96},"database.py":{"content":"# Zentrale Datenbank-Konfiguration\n# Diese Datei stellt die gemeinsame SQLAlchemy-Instanz bereit\n\nfrom flask_sqlalchemy import SQLAlchemy\n\ndb = SQLAlchemy()\n","size_bytes":157},"DEPLOYMENT.md":{"content":"# Deployment Guide für Render\n\nDiese Anleitung beschreibt, wie Sie die SportOase-App auf Render deployen.\n\n## Voraussetzungen\n\n- GitHub Repository mit dem Code\n- Render Account (kostenlos verfügbar)\n\n## Schritt 1: PostgreSQL-Datenbank erstellen\n\n1. Gehen Sie zu [Render Dashboard](https://dashboard.render.com/)\n2. Klicken Sie auf **New +** → **PostgreSQL**\n3. Konfiguration:\n   - **Name**: `sportoase-db` (oder ein anderer Name)\n   - **Database**: Leer lassen (wird automatisch generiert)\n   - **User**: Leer lassen (wird automatisch generiert)\n   - **Region**: Wählen Sie die nächstgelegene Region\n   - **PostgreSQL Version**: 15 oder 16\n   - **Plan**: Free (läuft nach 90 Tagen ab, erfordert Backup/Neuaufbau)\n\n4. Klicken Sie auf **Create Database**\n5. Notieren Sie sich die **Internal Database URL** (wird später benötigt)\n6. **WICHTIG**: Ändern Sie `postgres://` zu `postgresql://` in der URL\n\n## Schritt 2: Web Service erstellen\n\n1. Klicken Sie auf **New +** → **Web Service**\n2. Verbinden Sie Ihr GitHub Repository\n3. Konfiguration:\n\n| Einstellung | Wert |\n|-------------|------|\n| **Name** | `sportoase-app` |\n| **Region** | Gleiche wie Datenbank |\n| **Branch** | `main` |\n| **Build Command** | `pip install -r requirements.txt` |\n| **Start Command** | `gunicorn app:app` |\n| **Plan** | Free |\n\n## Schritt 3: Umgebungsvariablen konfigurieren\n\nFügen Sie diese Umgebungsvariablen hinzu (unter **Environment**):\n\n| Variable | Wert | Beschreibung |\n|----------|------|--------------|\n| `DATABASE_URL` | Internal Database URL von PostgreSQL | **Wichtig**: `postgres://` zu `postgresql://` ändern! |\n| `SESSION_SECRET` | Ein zufälliger String | Für Flask Sessions (z.B. 32+ Zeichen) |\n| `PYTHON_VERSION` | `3.11` | Python-Version |\n| `SMTP_HOST` | SMTP-Server | Optional: Für E-Mail-Benachrichtigungen |\n| `SMTP_PORT` | `587` | Optional: SMTP Port |\n| `SMTP_USER` | Ihr SMTP Benutzername | Optional |\n| `SMTP_PASS` | Ihr SMTP Passwort | Optional |\n| `SMTP_FROM` | sportoase@sportoase.de | Optional: Absender-E-Mail |\n| `ADMIN_EMAIL` | sportoase.kg@gmail.com | Admin E-Mail für Benachrichtigungen |\n\n### Beispiel für SESSION_SECRET generieren:\n\n```python\nimport os\nprint(os.urandom(32).hex())\n```\n\n## Schritt 4: Datenbank initialisieren\n\n**WICHTIG**: Nach dem ersten Deployment MUSS die Datenbank initialisiert werden!\n\n1. Verbinden Sie sich mit der Render Shell (im Dashboard unter \"Shell\")\n2. Führen Sie aus:\n\n```bash\npython db_setup.py\n```\n\nDies erstellt:\n- Alle Datenbank-Tabellen\n- Den Admin-Account mit:\n  - **Benutzername**: sportoase\n  - **Passwort**: mauro123\n  - **E-Mail**: sportoase.kg@gmail.com\n\n**WICHTIG**: Ändern Sie das Passwort nach dem ersten Login!\n\n## Schritt 5: Deployment überprüfen\n\n1. Öffnen Sie die URL Ihrer App (z.B. `https://sportoase-app.onrender.com`)\n2. Melden Sie sich mit den Admin-Zugangsdaten an\n3. Prüfen Sie, ob alles funktioniert\n\n## E-Mail-Konfiguration (optional)\n\nFür E-Mail-Benachrichtigungen bei Buchungen können Sie einen SMTP-Service verwenden:\n\n### Gmail SMTP (für Tests):\n- Host: `smtp.gmail.com`\n- Port: `587`\n- User: Ihre Gmail-Adresse\n- Pass: App-spezifisches Passwort (nicht Ihr normales Passwort!)\n\n[Anleitung für Gmail App-Passwort](https://support.google.com/accounts/answer/185833)\n\n### Professionelle Services:\n- SendGrid (kostenlos bis 100 E-Mails/Tag)\n- Mailgun\n- Amazon SES\n\n## Wichtige Hinweise\n\n1. **Free Tier**: \n   - Web Service schläft nach 15 Min Inaktivität\n   - Erste Anfrage dauert 30-60s zum Aufwachen\n   - PostgreSQL läuft nach 90 Tagen ab (Backup erforderlich!)\n\n2. **Datenbank-Backup**:\n   ```bash\n   pg_dump DATABASE_URL > backup.sql\n   ```\n\n3. **Logs überwachen**:\n   - Render Dashboard → Ihre App → Logs\n   - Hilft bei der Fehlersuche\n\n4. **Updates deployen**:\n   - Pushen Sie zu GitHub\n   - Render deployt automatisch\n   - **Nach größeren Datenbank-Änderungen**: Führen Sie `python db_setup.py` erneut aus\n\n## Troubleshooting\n\n### App startet nicht:\n- Prüfen Sie die Logs in Render Dashboard\n- Stellen Sie sicher, dass `DATABASE_URL` mit `postgresql://` beginnt\n- Überprüfen Sie, ob alle Pakete in `requirements.txt` sind\n\n### Datenbank-Verbindungsfehler:\n- Verwenden Sie die **Internal Database URL** (nicht External)\n- Bestätigen Sie, dass die Datenbank \"Available\" ist\n- Prüfen Sie, ob Region von App und DB übereinstimmt\n- **Wichtig**: Haben Sie `python db_setup.py` ausgeführt?\n\n### \"Tabelle existiert nicht\" Fehler:\n- Sie haben vergessen, `python db_setup.py` auszuführen!\n- Verbinden Sie sich mit der Shell und führen Sie das Skript aus\n\n### E-Mails werden nicht gesendet:\n- Überprüfen Sie SMTP-Einstellungen in den Umgebungsvariablen\n- Testen Sie SMTP-Zugangsdaten lokal\n- Prüfen Sie, ob Port 587 erlaubt ist\n- Für Gmail: Verwenden Sie ein App-spezifisches Passwort\n\n## Lokale Entwicklung\n\nFür die lokale Entwicklung:\n\n1. Installieren Sie PostgreSQL lokal\n2. Erstellen Sie eine `.env` Datei:\n   ```\n   DATABASE_URL=postgresql://localhost:5432/sportoase_dev\n   SESSION_SECRET=dev-secret-key\n   ADMIN_EMAIL=sportoase.kg@gmail.com\n   ```\n3. Führen Sie aus:\n   ```bash\n   python db_setup.py\n   uv run python app.py\n   ```\n\n## Support\n\nBei Fragen zu Render: https://render.com/docs\n","size_bytes":5219},"FIXES_NOVEMBER_2025.md":{"content":"# Performance-Fixes November 2025\n\n## Problem\nDie SportOase-App hatte zwei kritische Probleme in der Produktionsumgebung (sportoase.app):\n\n1. **Worker Timeouts**: Die Seite war extrem langsam, und es gab regelmäßig Gunicorn Worker-Timeouts\n2. **E-Mails kamen nicht an**: Buchungsbenachrichtigungen wurden nicht versendet\n\n## Ursachen\n\n### 1. Server-Sent Events (SSE) mit Gunicorn\nDas Problem lag am SSE-Endpoint `/notifications/stream`, der für Echtzeit-Benachrichtigungen verwendet wurde. Gunicorn ist nicht für Long-Polling und Server-Sent Events optimiert und verursachte:\n- Worker-Timeouts nach 30 Sekunden\n- Blockierte Worker-Threads\n- Extrem langsame Seitenlade-Zeiten\n\n### 2. Gmail-Integration funktioniert nur in Replit\nDie Replit Gmail-Integration ist nur in der Replit-Entwicklungsumgebung verfügbar, nicht aber auf externen Deployments wie Render (sportoase.app).\n\n## Lösungen\n\n### 1. SSE deaktiviert → Polling-System implementiert\n- ✅ SSE-Endpoint (`/notifications/stream`) wurde deaktiviert\n- ✅ Frontend nutzt jetzt Polling (alle 30 Sekunden) statt SSE\n- ✅ Benachrichtigungen werden weiterhin angezeigt, nur ohne Echtzeit-Updates\n- ✅ Keine Worker-Timeouts mehr\n\n### 2. SMTP E-Mail-Service eingerichtet\n- ✅ Umstellung von Gmail-Integration auf Standard-SMTP\n- ✅ `SMTP_USER` und `SMTP_PASS` als Replit Secrets konfiguriert\n- ✅ E-Mails werden jetzt über Gmail SMTP verschickt\n- ✅ Funktioniert sowohl in Replit als auch in Produktion (Render)\n\n### 3. Deployment-Optimierung\n- ✅ Gunicorn Timeout auf 120 Sekunden erhöht\n- ✅ 2 Worker-Prozesse konfiguriert\n- ✅ `--reuse-port` für bessere Performance\n\n## Technische Details\n\n### Geänderte Dateien:\n1. **app.py**: SSE-Endpoint auskommentiert\n2. **email_service.py**: Neu geschrieben mit SMTP-only Logik\n3. **templates/base.html**: SSE durch Polling ersetzt\n4. **config.py**: SMTP-Credentials aus Secrets laden\n5. **.replit**: Deployment-Konfiguration optimiert\n\n### Neue Secrets (bereits konfiguriert):\n- `SMTP_USER`: Gmail-Adresse für E-Mail-Versand\n- `SMTP_PASS`: Gmail App-Passwort (16-stellig)\n\n## Ergebnis\n✅ **App läuft jetzt stabil und schnell**\n✅ **Keine Worker-Timeouts mehr**\n✅ **E-Mails werden zuverlässig versendet**\n✅ **Funktioniert sowohl in Replit als auch auf sportoase.app**\n\n## Hinweis für zukünftige Updates\nWenn Sie Echtzeit-Benachrichtigungen zurück möchten, sollten Sie:\n- Einen WebSocket-Server verwenden (statt SSE)\n- Oder einen separaten Event-Service (Redis + Socket.io)\n- Gunicorn ist nicht für Long-Polling geeignet\n\n---\nDatum: 15. November 2025\nStatus: ✅ Alle Probleme behoben\n","size_bytes":2611},"notification_service.py":{"content":"import os\nimport json\nimport base64\nfrom email.mime.text import MIMEText\nfrom email.mime.multipart import MIMEMultipart\nimport subprocess\nfrom datetime import datetime\n\ndef get_gmail_access_token():\n    \"\"\"Holt das Access Token von der Replit Gmail Integration\"\"\"\n    try:\n        hostname = os.environ.get('REPLIT_CONNECTORS_HOSTNAME')\n        x_replit_token = None\n        \n        if os.environ.get('REPL_IDENTITY'):\n            x_replit_token = 'repl ' + os.environ['REPL_IDENTITY']\n        elif os.environ.get('WEB_REPL_RENEWAL'):\n            x_replit_token = 'depl ' + os.environ['WEB_REPL_RENEWAL']\n        \n        if not x_replit_token or not hostname:\n            print(\"Gmail Integration nicht verfügbar - verwende Fallback SMTP\")\n            return None\n        \n        import requests\n        response = requests.get(\n            f'https://{hostname}/api/v2/connection?include_secrets=true&connector_names=google-mail',\n            headers={\n                'Accept': 'application/json',\n                'X_REPLIT_TOKEN': x_replit_token\n            }\n        )\n        \n        if response.status_code == 200:\n            data = response.json()\n            if data.get('items') and len(data['items']) > 0:\n                connection = data['items'][0]\n                access_token = connection.get('settings', {}).get('access_token') or \\\n                             connection.get('settings', {}).get('oauth', {}).get('credentials', {}).get('access_token')\n                return access_token\n        \n        return None\n    except Exception as e:\n        print(f\"Fehler beim Abrufen des Gmail Access Tokens: {e}\")\n        return None\n\ndef send_gmail_notification(to_email, subject, body_html, body_text=None):\n    \"\"\"Sendet eine Email-Benachrichtigung über Gmail API\"\"\"\n    try:\n        access_token = get_gmail_access_token()\n        \n        if not access_token:\n            print(\"WARNUNG: Kein Gmail Access Token verfügbar - Email wird nicht gesendet\")\n            print(\"Stellen Sie sicher, dass die Gmail-Integration eingerichtet ist\")\n            return False\n        \n        from google.auth.transport.requests import Request\n        from google.oauth2.credentials import Credentials\n        from googleapiclient.discovery import build\n        \n        creds = Credentials(token=access_token)\n        \n        service = build('gmail', 'v1', credentials=creds)\n        \n        message = MIMEMultipart('alternative')\n        message['To'] = to_email\n        message['From'] = 'me'\n        message['Subject'] = subject\n        \n        if body_text:\n            part1 = MIMEText(body_text, 'plain')\n            message.attach(part1)\n        \n        part2 = MIMEText(body_html, 'html')\n        message.attach(part2)\n        \n        raw_message = base64.urlsafe_b64encode(message.as_bytes()).decode('utf-8')\n        \n        send_message = service.users().messages().send(\n            userId='me',\n            body={'raw': raw_message}\n        ).execute()\n        \n        print(f\"Email erfolgreich gesendet an {to_email}: {send_message['id']}\")\n        return True\n        \n    except Exception as e:\n        print(f\"Fehler beim Senden der Gmail-Nachricht: {e}\")\n        return False\n\ndef create_booking_notification_email(booking_data):\n    \"\"\"Erstellt eine formatierte Email-Benachrichtigung für eine neue Buchung\"\"\"\n    teacher_name = booking_data.get('teacher_name', 'Unbekannt')\n    teacher_class = booking_data.get('teacher_class', '')\n    date = booking_data.get('date', '')\n    period = booking_data.get('period', '')\n    offer_label = booking_data.get('offer_label', '')\n    offer_type = booking_data.get('offer_type', '')\n    \n    students = []\n    try:\n        students_json = booking_data.get('students_json', '[]')\n        students = json.loads(students_json) if isinstance(students_json, str) else students_json\n    except:\n        students = []\n    \n    students_count = len(students)\n    \n    if students:\n        students_names = ', '.join([f\"{s['name']} ({s['klasse']})\" for s in students])\n    else:\n        students_names = 'Keine Schüler angegeben'\n    \n    subject = f\"📅 Neue Buchung: {offer_label} am {date}\"\n    \n    body_html = f\"\"\"\n    <html>\n    <head>\n        <style>\n            body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }}\n            .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}\n            .header {{ background: linear-gradient(135deg, #38bdf8 0%, #3b82f6 100%); \n                       color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }}\n            .header h2 {{ margin: 0; }}\n            .content {{ background: #f8f9fa; padding: 20px; border-radius: 8px; }}\n            .info-row {{ margin: 10px 0; padding: 10px; background: white; border-radius: 4px; }}\n            .label {{ font-weight: bold; color: #38bdf8; }}\n            .students-list {{ margin-top: 10px; padding-left: 20px; }}\n            .footer {{ margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; \n                      text-align: center; color: #666; font-size: 12px; }}\n        </style>\n    </head>\n    <body>\n        <div class=\"container\">\n            <div class=\"header\">\n                <h2>🏫 SportOase - Neue Buchung</h2>\n            </div>\n            <div class=\"content\">\n                <div class=\"info-row\">\n                    <span class=\"label\">👤 Lehrkraft:</span> {teacher_name}\n                    {f' ({teacher_class})' if teacher_class else ''}\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">📅 Datum:</span> {date}\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">🕐 Stunde:</span> Stunde {period}\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">📋 Angebot:</span> {offer_label}\n                    <span style=\"background: {'#4ade80' if offer_type == 'fest' else '#60a5fa'}; \n                                 color: white; padding: 2px 8px; border-radius: 12px; \n                                 font-size: 11px; margin-left: 8px;\">\n                        {offer_type.upper()}\n                    </span>\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">👥 Anzahl Schüler:</span> {students_count}\n                    <div class=\"students-list\">\n                        {students_names}\n                    </div>\n                </div>\n            </div>\n            <div class=\"footer\">\n                <p>Diese Nachricht wurde automatisch vom SportOase Buchungssystem generiert.</p>\n                <p>Zeit: {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}</p>\n            </div>\n        </div>\n    </body>\n    </html>\n    \"\"\"\n    \n    body_text = f\"\"\"\nSportOase - Neue Buchung\n\nLehrkraft: {teacher_name} {f'({teacher_class})' if teacher_class else ''}\nDatum: {date}\nStunde: Stunde {period}\nAngebot: {offer_label} ({offer_type.upper()})\nAnzahl Schüler: {students_count}\nSchüler: {students_names}\n\nZeit: {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}\n    \"\"\"\n    \n    return subject, body_html, body_text\n\ndef send_booking_notification(booking_data, admin_email):\n    \"\"\"Sendet eine Buchungsbenachrichtigung an den Admin\"\"\"\n    try:\n        subject, body_html, body_text = create_booking_notification_email(booking_data)\n        return send_gmail_notification(admin_email, subject, body_html, body_text)\n    except Exception as e:\n        print(f\"Fehler beim Senden der Buchungsbenachrichtigung: {e}\")\n        return False\n","size_bytes":7606},"test_gmail.py":{"content":"#!/usr/bin/env python3\n\"\"\"Test-Skript für Gmail-Integration und Benachrichtigungen\"\"\"\n\nimport os\nfrom notification_service import send_gmail_notification, send_booking_notification\nfrom datetime import datetime\n\ndef test_simple_email():\n    \"\"\"Sendet eine einfache Test-Email\"\"\"\n    print(\"=\" * 50)\n    print(\"TEST 1: Einfache Test-Email\")\n    print(\"=\" * 50)\n    \n    admin_email = os.environ.get('ADMIN_EMAIL', 'sportoase.kg@gmail.com')\n    subject = \"✅ SportOase Gmail-Integration Test\"\n    \n    body_html = \"\"\"\n    <html>\n    <head>\n        <style>\n            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n            .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n            .header { background: linear-gradient(135deg, #38bdf8 0%, #3b82f6 100%); \n                     color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }\n            .content { background: #f8f9fa; padding: 20px; border-radius: 8px; }\n        </style>\n    </head>\n    <body>\n        <div class=\"container\">\n            <div class=\"header\">\n                <h2>🎉 Gmail-Integration erfolgreich!</h2>\n            </div>\n            <div class=\"content\">\n                <p>Die Gmail-Integration für das SportOase Buchungssystem wurde erfolgreich eingerichtet.</p>\n                <p><strong>Testzeit:</strong> \"\"\" + datetime.now().strftime('%d.%m.%Y um %H:%M Uhr') + \"\"\"</p>\n                <p>E-Mail-Benachrichtigungen funktionieren jetzt einwandfrei! ✅</p>\n            </div>\n        </div>\n    </body>\n    </html>\n    \"\"\"\n    \n    body_text = f\"\"\"\nSportOase - Gmail-Integration Test\n\nDie Gmail-Integration wurde erfolgreich eingerichtet.\nTestzeit: {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}\n\nE-Mail-Benachrichtigungen funktionieren jetzt einwandfrei!\n    \"\"\"\n    \n    success = send_gmail_notification(admin_email, subject, body_html, body_text)\n    \n    if success:\n        print(f\"✅ Test-Email erfolgreich gesendet an {admin_email}\")\n    else:\n        print(f\"❌ Fehler beim Senden der Test-Email\")\n    \n    return success\n\ndef test_booking_notification():\n    \"\"\"Testet eine Buchungsbenachrichtigung\"\"\"\n    print(\"\\n\" + \"=\" * 50)\n    print(\"TEST 2: Buchungsbenachrichtigung\")\n    print(\"=\" * 50)\n    \n    admin_email = os.environ.get('ADMIN_EMAIL', 'sportoase.kg@gmail.com')\n    \n    # Simuliere Buchungsdaten\n    booking_data = {\n        'teacher_name': 'Max Mustermann',\n        'teacher_class': '5a',\n        'date': '2025-11-20',\n        'period': 3,\n        'offer_label': 'Basketball',\n        'offer_type': 'fest',\n        'students_json': '[{\"name\": \"Anna Schmidt\", \"klasse\": \"5a\"}, {\"name\": \"Tom Müller\", \"klasse\": \"5b\"}]'\n    }\n    \n    success = send_booking_notification(booking_data, admin_email)\n    \n    if success:\n        print(f\"✅ Buchungsbenachrichtigung erfolgreich gesendet an {admin_email}\")\n    else:\n        print(f\"❌ Fehler beim Senden der Buchungsbenachrichtigung\")\n    \n    return success\n\nif __name__ == '__main__':\n    print(\"\\n🔍 Starte Gmail-Integration Tests...\\n\")\n    \n    # Test 1: Einfache Email\n    test1_result = test_simple_email()\n    \n    # Test 2: Buchungsbenachrichtigung\n    test2_result = test_booking_notification()\n    \n    # Zusammenfassung\n    print(\"\\n\" + \"=\" * 50)\n    print(\"ZUSAMMENFASSUNG\")\n    print(\"=\" * 50)\n    print(f\"Test 1 (Einfache Email): {'✅ BESTANDEN' if test1_result else '❌ FEHLGESCHLAGEN'}\")\n    print(f\"Test 2 (Buchungsbenachrichtigung): {'✅ BESTANDEN' if test2_result else '❌ FEHLGESCHLAGEN'}\")\n    \n    if test1_result and test2_result:\n        print(\"\\n🎉 Alle Tests erfolgreich! Gmail-Integration funktioniert perfekt.\")\n    else:\n        print(\"\\n⚠️ Einige Tests sind fehlgeschlagen. Bitte Logs prüfen.\")\n","size_bytes":3762},"src/SportOaseBundle.php":{"content":"<?php\n\nnamespace SportOase;\n\nuse Symfony\\Component\\HttpKernel\\Bundle\\Bundle;\n\nclass SportOaseBundle extends Bundle\n{\n    public function getPath(): string\n    {\n        return \\dirname(__DIR__);\n    }\n}\n","size_bytes":203},"src/Controller/DashboardController.php":{"content":"<?php\n\nnamespace SportOase\\Controller;\n\nuse SportOase\\Entity\\Booking;\nuse SportOase\\Entity\\BlockedSlot;\nuse SportOase\\Entity\\SlotName;\nuse SportOase\\Service\\BookingService;\nuse Doctrine\\ORM\\EntityManagerInterface;\nuse Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController;\nuse Symfony\\Component\\HttpFoundation\\Request;\nuse Symfony\\Component\\HttpFoundation\\Response;\nuse Symfony\\Component\\Routing\\Annotation\\Route;\n\n#[Route('/sportoase')]\nclass DashboardController extends AbstractController\n{\n    public function __construct(\n        private EntityManagerInterface $entityManager,\n        private BookingService $bookingService\n    ) {\n    }\n\n    #[Route('/', name: 'sportoase_dashboard', methods: ['GET'])]\n    public function dashboard(Request $request): Response\n    {\n        $user = $this->getUser();\n        \n        $weekOffset = (int) $request->query->get('week', 0);\n        $weekData = $this->bookingService->getWeekData($weekOffset);\n        \n        $userBookings = $this->entityManager\n            ->getRepository(Booking::class)\n            ->findBy(['teacher' => $user], ['date' => 'DESC']);\n        \n        $slotNames = $this->entityManager\n            ->getRepository(SlotName::class)\n            ->findAll();\n        \n        $blockedSlots = $this->entityManager\n            ->getRepository(BlockedSlot::class)\n            ->findAll();\n        \n        return $this->render('@SportOase/dashboard.html.twig', [\n            'user' => $user,\n            'week_data' => $weekData,\n            'user_bookings' => $userBookings,\n            'slot_names' => $slotNames,\n            'blocked_slots' => $blockedSlots,\n            'week_offset' => $weekOffset,\n        ]);\n    }\n}\n","size_bytes":1697},"src/Entity/BlockedSlot.php":{"content":"<?php\n\nnamespace SportOase\\Entity;\n\nuse Doctrine\\ORM\\Mapping as ORM;\n\n#[ORM\\Entity]\n#[ORM\\Table(name: 'sportoase_blocked_slots')]\n#[ORM\\UniqueConstraint(name: 'unique_blocked_date_period', columns: ['date', 'period'])]\n#[ORM\\Index(columns: ['date'], name: 'idx_blocked_date')]\nclass BlockedSlot\n{\n    #[ORM\\Id]\n    #[ORM\\GeneratedValue]\n    #[ORM\\Column(type: 'integer')]\n    private ?int $id = null;\n\n    #[ORM\\Column(type: 'date')]\n    private \\DateTime $date;\n\n    #[ORM\\Column(type: 'integer')]\n    private int $period;\n\n    #[ORM\\Column(type: 'string', length: 20)]\n    private string $weekday;\n\n    #[ORM\\Column(type: 'string', length: 255)]\n    private string $reason = 'Beratung';\n\n    #[ORM\\ManyToOne(targetEntity: User::class, inversedBy: 'blockedSlots')]\n    #[ORM\\JoinColumn(nullable: false, onDelete: 'CASCADE')]\n    private User $blockedBy;\n\n    #[ORM\\Column(type: 'datetime')]\n    private \\DateTime $createdAt;\n\n    #[ORM\\Column(type: 'datetime')]\n    private \\DateTime $updatedAt;\n\n    public function __construct()\n    {\n        $this->createdAt = new \\DateTime();\n        $this->updatedAt = new \\DateTime();\n    }\n\n    public function getId(): ?int\n    {\n        return $this->id;\n    }\n\n    public function getDate(): \\DateTime\n    {\n        return $this->date;\n    }\n\n    public function setDate(\\DateTime $date): self\n    {\n        $this->date = $date;\n        return $this;\n    }\n\n    public function getPeriod(): int\n    {\n        return $this->period;\n    }\n\n    public function setPeriod(int $period): self\n    {\n        $this->period = $period;\n        return $this;\n    }\n\n    public function getWeekday(): string\n    {\n        return $this->weekday;\n    }\n\n    public function setWeekday(string $weekday): self\n    {\n        $this->weekday = $weekday;\n        return $this;\n    }\n\n    public function getReason(): string\n    {\n        return $this->reason;\n    }\n\n    public function setReason(string $reason): self\n    {\n        $this->reason = $reason;\n        return $this;\n    }\n\n    public function getBlockedBy(): User\n    {\n        return $this->blockedBy;\n    }\n\n    public function setBlockedBy(User $blockedBy): self\n    {\n        $this->blockedBy = $blockedBy;\n        return $this;\n    }\n\n    public function getCreatedAt(): \\DateTime\n    {\n        return $this->createdAt;\n    }\n\n    public function getUpdatedAt(): \\DateTime\n    {\n        return $this->updatedAt;\n    }\n\n    public function setUpdatedAt(\\DateTime $updatedAt): self\n    {\n        $this->updatedAt = $updatedAt;\n        return $this;\n    }\n}\n","size_bytes":2549},"migrations/Version001CreateInitialSchema.php":{"content":"<?php\n\ndeclare(strict_types=1);\n\nnamespace DoctrineMigrations;\n\nuse Doctrine\\DBAL\\Schema\\Schema;\nuse Doctrine\\Migrations\\AbstractMigration;\n\nfinal class Version001CreateInitialSchema extends AbstractMigration\n{\n    public function getDescription(): string\n    {\n        return 'Creates initial SportOase database schema with all tables and indexes';\n    }\n\n    public function up(Schema $schema): void\n    {\n        $this->addSql('CREATE TABLE sportoase_users (\n            id SERIAL PRIMARY KEY,\n            username VARCHAR(255) UNIQUE NOT NULL,\n            email VARCHAR(255) UNIQUE,\n            full_name VARCHAR(255),\n            role VARCHAR(50) NOT NULL DEFAULT \\'teacher\\',\n            is_active BOOLEAN DEFAULT true,\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n        )');\n\n        $this->addSql('CREATE TABLE sportoase_bookings (\n            id SERIAL PRIMARY KEY,\n            date DATE NOT NULL,\n            period INTEGER NOT NULL,\n            weekday VARCHAR(20) NOT NULL,\n            teacher_id INTEGER NOT NULL REFERENCES sportoase_users(id) ON DELETE CASCADE,\n            teacher_name VARCHAR(255) NOT NULL,\n            teacher_class VARCHAR(255) NOT NULL,\n            students_json JSONB NOT NULL DEFAULT \\'[]\\',\n            offer_type VARCHAR(100) NOT NULL,\n            offer_label VARCHAR(255) NOT NULL,\n            calendar_event_id VARCHAR(255),\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n            UNIQUE(date, period)\n        )');\n\n        $this->addSql('CREATE TABLE sportoase_slot_names (\n            id SERIAL PRIMARY KEY,\n            weekday VARCHAR(20) NOT NULL,\n            period INTEGER NOT NULL,\n            label VARCHAR(255) NOT NULL,\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n            UNIQUE(weekday, period)\n        )');\n\n        $this->addSql('CREATE TABLE sportoase_blocked_slots (\n            id SERIAL PRIMARY KEY,\n            date DATE NOT NULL,\n            period INTEGER NOT NULL,\n            weekday VARCHAR(20) NOT NULL,\n            reason VARCHAR(255) DEFAULT \\'Beratung\\',\n            blocked_by_id INTEGER NOT NULL REFERENCES sportoase_users(id) ON DELETE CASCADE,\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n            UNIQUE(date, period)\n        )');\n\n        $this->addSql('CREATE TABLE sportoase_notifications (\n            id SERIAL PRIMARY KEY,\n            booking_id INTEGER NOT NULL REFERENCES sportoase_bookings(id) ON DELETE CASCADE,\n            recipient_role VARCHAR(50) NOT NULL DEFAULT \\'admin\\',\n            notification_type VARCHAR(100) NOT NULL,\n            message TEXT NOT NULL,\n            metadata_json JSONB,\n            is_read BOOLEAN DEFAULT false,\n            read_at TIMESTAMP,\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n        )');\n\n        $this->addSql('CREATE INDEX idx_sportoase_bookings_date_period ON sportoase_bookings(date, period)');\n        $this->addSql('CREATE INDEX idx_sportoase_bookings_date ON sportoase_bookings(date)');\n        $this->addSql('CREATE INDEX idx_sportoase_blocked_slots_date ON sportoase_blocked_slots(date)');\n        $this->addSql('CREATE INDEX idx_sportoase_notifications_created_at ON sportoase_notifications(created_at DESC)');\n        $this->addSql('CREATE INDEX idx_sportoase_notifications_is_read ON sportoase_notifications(is_read)');\n    }\n\n    public function down(Schema $schema): void\n    {\n        $this->addSql('DROP TABLE IF EXISTS sportoase_notifications CASCADE');\n        $this->addSql('DROP TABLE IF EXISTS sportoase_blocked_slots CASCADE');\n        $this->addSql('DROP TABLE IF EXISTS sportoase_slot_names CASCADE');\n        $this->addSql('DROP TABLE IF EXISTS sportoase_bookings CASCADE');\n        $this->addSql('DROP TABLE IF EXISTS sportoase_users CASCADE');\n    }\n}\n","size_bytes":4031},"src/Entity/SlotName.php":{"content":"<?php\n\nnamespace SportOase\\Entity;\n\nuse Doctrine\\ORM\\Mapping as ORM;\n\n#[ORM\\Entity]\n#[ORM\\Table(name: 'sportoase_slot_names')]\n#[ORM\\UniqueConstraint(name: 'unique_weekday_period', columns: ['weekday', 'period'])]\nclass SlotName\n{\n    #[ORM\\Id]\n    #[ORM\\GeneratedValue]\n    #[ORM\\Column(type: 'integer')]\n    private ?int $id = null;\n\n    #[ORM\\Column(type: 'string', length: 20)]\n    private string $weekday;\n\n    #[ORM\\Column(type: 'integer')]\n    private int $period;\n\n    #[ORM\\Column(type: 'string', length: 255)]\n    private string $label;\n\n    #[ORM\\Column(type: 'datetime')]\n    private \\DateTime $createdAt;\n\n    #[ORM\\Column(type: 'datetime')]\n    private \\DateTime $updatedAt;\n\n    public function __construct()\n    {\n        $this->createdAt = new \\DateTime();\n        $this->updatedAt = new \\DateTime();\n    }\n\n    public function getId(): ?int\n    {\n        return $this->id;\n    }\n\n    public function getWeekday(): string\n    {\n        return $this->weekday;\n    }\n\n    public function setWeekday(string $weekday): self\n    {\n        $this->weekday = $weekday;\n        return $this;\n    }\n\n    public function getPeriod(): int\n    {\n        return $this->period;\n    }\n\n    public function setPeriod(int $period): self\n    {\n        $this->period = $period;\n        return $this;\n    }\n\n    public function getLabel(): string\n    {\n        return $this->label;\n    }\n\n    public function setLabel(string $label): self\n    {\n        $this->label = $label;\n        return $this;\n    }\n\n    public function getCreatedAt(): \\DateTime\n    {\n        return $this->createdAt;\n    }\n\n    public function getUpdatedAt(): \\DateTime\n    {\n        return $this->updatedAt;\n    }\n\n    public function setUpdatedAt(\\DateTime $updatedAt): self\n    {\n        $this->updatedAt = $updatedAt;\n        return $this;\n    }\n}\n","size_bytes":1821},"src/Controller/BookingController.php":{"content":"<?php\n\nnamespace SportOase\\Controller;\n\nuse SportOase\\Entity\\Booking;\nuse SportOase\\Service\\BookingService;\nuse SportOase\\Service\\EmailService;\nuse Doctrine\\ORM\\EntityManagerInterface;\nuse Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController;\nuse Symfony\\Component\\HttpFoundation\\Request;\nuse Symfony\\Component\\HttpFoundation\\Response;\nuse Symfony\\Component\\Routing\\Annotation\\Route;\n\n#[Route('/sportoase/booking')]\nclass BookingController extends AbstractController\n{\n    public function __construct(\n        private EntityManagerInterface $entityManager,\n        private BookingService $bookingService,\n        private EmailService $emailService\n    ) {\n    }\n\n    #[Route('/create', name: 'sportoase_booking_create', methods: ['GET', 'POST'])]\n    public function create(Request $request): Response\n    {\n        $user = $this->getUser();\n        \n        if ($request->isMethod('POST')) {\n            try {\n                $booking = $this->bookingService->createBooking(\n                    $user,\n                    $request->request->all()\n                );\n                \n                $this->emailService->sendBookingNotification($booking);\n                \n                $this->addFlash('success', 'Buchung erfolgreich erstellt!');\n                return $this->redirectToRoute('sportoase_dashboard');\n            } catch (\\Exception $e) {\n                $this->addFlash('error', $e->getMessage());\n            }\n        }\n        \n        $date = $request->query->get('date');\n        $period = $request->query->get('period');\n        \n        return $this->render('@SportOase/booking/create.html.twig', [\n            'date' => $date,\n            'period' => $period,\n        ]);\n    }\n\n    #[Route('/{id}/delete', name: 'sportoase_booking_delete', methods: ['POST'])]\n    public function delete(Request $request, Booking $booking): Response\n    {\n        $user = $this->getUser();\n        \n        if ($booking->getTeacher() !== $user && !$user->isAdmin()) {\n            throw $this->createAccessDeniedException('Sie haben keine Berechtigung, diese Buchung zu löschen.');\n        }\n        \n        if ($this->isCsrfTokenValid('delete-booking-' . $booking->getId(), $request->request->get('_token'))) {\n            $this->entityManager->remove($booking);\n            $this->entityManager->flush();\n            \n            $this->addFlash('success', 'Buchung erfolgreich gelöscht!');\n        }\n        \n        return $this->redirectToRoute('sportoase_dashboard');\n    }\n}\n","size_bytes":2504},"src/BookingService.php":{"content":"<?php\n\nnamespace App;\n\nuse Supabase\\Client as SupabaseClient;\n\nclass BookingService\n{\n    private SupabaseClient $supabase;\n    private array $config;\n\n    public function __construct(SupabaseClient $supabase, array $config = [])\n    {\n        $this->supabase = $supabase;\n        $this->config = array_merge([\n            'max_students_per_period' => 5,\n            'booking_advance_minutes' => 60,\n            'period_times' => [\n                1 => ['start' => '07:50', 'end' => '08:35'],\n                2 => ['start' => '08:35', 'end' => '09:20'],\n                3 => ['start' => '09:40', 'end' => '10:25'],\n                4 => ['start' => '10:25', 'end' => '11:20'],\n                5 => ['start' => '11:40', 'end' => '12:25'],\n                6 => ['start' => '12:25', 'end' => '13:10'],\n            ],\n            'fixed_offers' => [\n                'Mon' => [1 => 'Sport I', 3 => 'Sport II', 5 => 'Sport III'],\n                'Tue' => [],\n                'Wed' => [1 => 'Sport I', 3 => 'Sport II', 5 => 'Sport III'],\n                'Thu' => [2 => 'Sport I', 5 => 'Sport II'],\n                'Fri' => [2 => 'Sport I', 4 => 'Sport II', 5 => 'Sport III'],\n            ],\n        ], $config);\n    }\n\n    public function getWeeklySchedule(): array\n    {\n        $today = new \\DateTime('now', new \\DateTimeZone('Europe/Berlin'));\n        $dayOfWeek = $today->format('N');\n        $monday = (clone $today)->modify(\"-\" . ($dayOfWeek - 1) . \" days\");\n        $friday = (clone $monday)->modify(\"+4 days\");\n\n        $bookings = $this->supabase\n            ->from('sportoase_bookings')\n            ->select('*')\n            ->gte('date', $monday->format('Y-m-d'))\n            ->lte('date', $friday->format('Y-m-d'))\n            ->order('date', 'asc')\n            ->order('period', 'asc')\n            ->execute()\n            ->data ?? [];\n\n        $blockedSlots = $this->supabase\n            ->from('sportoase_blocked_slots')\n            ->select('*')\n            ->gte('date', $monday->format('Y-m-d'))\n            ->lte('date', $friday->format('Y-m-d'))\n            ->execute()\n            ->data ?? [];\n\n        return [\n            'week_start' => $monday->format('Y-m-d'),\n            'week_end' => $friday->format('Y-m-d'),\n            'bookings' => $bookings,\n            'blocked_slots' => $blockedSlots,\n            'periods' => $this->config['period_times'],\n        ];\n    }\n\n    public function createBooking(\n        string $teacherId,\n        string $date,\n        int $period,\n        string $teacherName,\n        string $teacherClass,\n        array $students,\n        string $offerLabel\n    ): ?array {\n        $this->validateBookingRequest($date, $period, $teacherName, $teacherClass, $students);\n\n        $bookingDate = new \\DateTime($date, new \\DateTimeZone('Europe/Berlin'));\n        $weekday = $bookingDate->format('a');\n\n        $studentCount = count($students);\n        $currentCount = $this->countStudentsForPeriod($date, $period);\n\n        if (($currentCount + $studentCount) > $this->config['max_students_per_period']) {\n            throw new \\Exception('Insufficient capacity for this time slot');\n        }\n\n        $offerType = $this->determineOfferType($weekday, $period);\n\n        try {\n            $result = $this->supabase\n                ->from('sportoase_bookings')\n                ->insert([\n                    'date' => $date,\n                    'period' => $period,\n                    'weekday' => $weekday,\n                    'teacher_id' => $teacherId,\n                    'teacher_name' => $teacherName,\n                    'teacher_class' => $teacherClass,\n                    'students_json' => json_encode($students),\n                    'offer_type' => $offerType,\n                    'offer_label' => $offerLabel,\n                    'created_at' => date('c'),\n                ])\n                ->execute();\n\n            $booking = $result->data[0] ?? null;\n\n            if ($booking) {\n                $this->createNotification($booking['id'], $teacherName, $offerLabel, count($students), $date, $period);\n            }\n\n            return $booking;\n        } catch (\\Exception $e) {\n            error_log(\"Error creating booking: {$e->getMessage()}\");\n            throw $e;\n        }\n    }\n\n    public function deleteBooking(string $bookingId, string $teacherId): bool\n    {\n        try {\n            $booking = $this->supabase\n                ->from('sportoase_bookings')\n                ->select('*')\n                ->eq('id', $bookingId)\n                ->maybeSingle()\n                ->execute();\n\n            if (!$booking->data || $booking->data['teacher_id'] !== $teacherId) {\n                throw new \\Exception('Booking not found or access denied');\n            }\n\n            $this->supabase\n                ->from('sportoase_bookings')\n                ->delete()\n                ->eq('id', $bookingId)\n                ->execute();\n\n            return true;\n        } catch (\\Exception $e) {\n            error_log(\"Error deleting booking: {$e->getMessage()}\");\n            throw $e;\n        }\n    }\n\n    public function countStudentsForPeriod(string $date, int $period): int\n    {\n        $bookings = $this->supabase\n            ->from('sportoase_bookings')\n            ->select('students_json')\n            ->eq('date', $date)\n            ->eq('period', $period)\n            ->execute()\n            ->data ?? [];\n\n        $total = 0;\n        foreach ($bookings as $booking) {\n            $students = json_decode($booking['students_json'], true) ?? [];\n            $total += count($students);\n        }\n\n        return $total;\n    }\n\n    public function validateBookingRequest(\n        string $date,\n        int $period,\n        string $teacherName,\n        string $teacherClass,\n        array $students\n    ): void {\n        if (!$teacherName || !$teacherClass) {\n            throw new \\InvalidArgumentException('Teacher name and class required');\n        }\n\n        if (empty($students) || count($students) > 5) {\n            throw new \\InvalidArgumentException('Must provide 1-5 students');\n        }\n\n        $bookingDate = new \\DateTime($date, new \\DateTimeZone('Europe/Berlin'));\n        $now = new \\DateTime('now', new \\DateTimeZone('Europe/Berlin'));\n\n        if ($bookingDate < $now) {\n            throw new \\Exception('Cannot book past dates');\n        }\n\n        if ($bookingDate->format('w') == 0 || $bookingDate->format('w') == 6) {\n            throw new \\Exception('Bookings not available on weekends');\n        }\n\n        if ($period < 1 || $period > 6) {\n            throw new \\InvalidArgumentException('Invalid period');\n        }\n    }\n\n    private function determineOfferType(string $weekday, int $period): string\n    {\n        $fixedOffers = $this->config['fixed_offers'][$weekday] ?? [];\n        return isset($fixedOffers[$period]) ? 'fest' : 'frei';\n    }\n\n    private function createNotification(\n        string $bookingId,\n        string $teacherName,\n        string $offerLabel,\n        int $studentCount,\n        string $date,\n        int $period\n    ): void {\n        try {\n            $message = \"New booking: $teacherName registered $studentCount students for $offerLabel on $date (Period $period)\";\n\n            $this->supabase\n                ->from('sportoase_notifications')\n                ->insert([\n                    'booking_id' => $bookingId,\n                    'recipient_role' => 'admin',\n                    'notification_type' => 'new_booking',\n                    'message' => $message,\n                    'metadata_json' => json_encode([\n                        'teacher_name' => $teacherName,\n                        'offer_label' => $offerLabel,\n                        'students_count' => $studentCount,\n                        'date' => $date,\n                        'period' => $period,\n                    ]),\n                    'is_read' => false,\n                    'created_at' => date('c'),\n                ])\n                ->execute();\n        } catch (\\Exception $e) {\n            error_log(\"Error creating notification: {$e->getMessage()}\");\n        }\n    }\n}\n","size_bytes":8094},"ISERV_SSO_SETUP.md":{"content":"# IServ SSO Integration Setup Guide\n\nThis document provides detailed instructions for integrating SportOase with IServ's Single Sign-On (SSO) system using OAuth 2.0 / OpenID Connect (OIDC).\n\n## Prerequisites\n\n- IServ 3.0 or higher installed and running\n- Admin access to the IServ server\n- Symfony 6.4+ project (SportOase)\n- PHP 8.0 or higher\n\n## Step 1: Register Application in IServ\n\n### 1.1 Access IServ Admin Panel\n\n1. Log into your IServ instance as administrator\n2. Navigate to: **Verwaltung → System → Single-Sign-On**\n\n### 1.2 Create OAuth2 Client\n\n1. Click **Hinzufügen** (Add) to create a new OpenID Connect client\n2. Configure the following settings:\n\n   - **Name**: `SportOase`\n   - **Client-ID**: (Auto-generated - copy this value)\n   - **Client-Geheimnis** (Client Secret): (Auto-generated - copy this value)\n   - **Redirect URI**: `https://your-iserv-domain.de/sportoase/oidc/callback`\n   - **Vertrauenswürdig** (Trusted): **Ja** (Yes)\n   - **Scopes**: Select `openid`, `profile`, `email`, `roles`\n\n3. Save the configuration\n4. **Important**: Copy and securely store the `Client-ID` and `Client-Geheimnis`\n\n## Step 2: Install Required Symfony Packages\n\nRun the following commands in your Symfony project:\n\n```bash\ncomposer require knpuniversity/oauth2-client-bundle\ncomposer require league/oauth2-client\n```\n\n## Step 3: Configure OAuth2 Client\n\n### 3.1 Update Environment Variables\n\nAdd the following to your `.env` file:\n\n```env\n###> IServ OAuth2 Configuration ###\nISERV_BASE_URL=https://your-school.iserv.de\nISERV_CLIENT_ID=your-client-id-from-step-1\nISERV_CLIENT_SECRET=your-client-secret-from-step-1\n###< IServ OAuth2 Configuration ###\n```\n\n### 3.2 Configure KnpU OAuth2 Client\n\nCreate or update `config/packages/knpu_oauth2_client.yaml`:\n\n```yaml\nknpu_oauth2_client:\n    clients:\n        iserv:\n            type: generic\n            provider_class: League\\OAuth2\\Client\\Provider\\GenericProvider\n            client_id: '%env(ISERV_CLIENT_ID)%'\n            client_secret: '%env(ISERV_CLIENT_SECRET)%'\n            redirect_route: oidc_callback\n            redirect_params: {}\n            provider_options:\n                urlAuthorize: '%env(ISERV_BASE_URL)%/iserv/oauth/v2/authorize'\n                urlAccessToken: '%env(ISERV_BASE_URL)%/iserv/oauth/v2/token'\n                urlResourceOwnerDetails: '%env(ISERV_BASE_URL)%/iserv/oauth/v2/userinfo'\n                scopes: 'openid profile email'\n```\n\n## Step 4: Create IServ Authenticator\n\nReplace the current `src/IServAuthenticator.php` with the real implementation:\n\n```php\n<?php\n\nnamespace SportOase\\Security;\n\nuse KnpU\\OAuth2ClientBundle\\Client\\ClientRegistry;\nuse KnpU\\OAuth2ClientBundle\\Security\\Authenticator\\OAuth2Authenticator;\nuse Symfony\\Component\\HttpFoundation\\RedirectResponse;\nuse Symfony\\Component\\HttpFoundation\\Request;\nuse Symfony\\Component\\HttpFoundation\\Response;\nuse Symfony\\Component\\Routing\\RouterInterface;\nuse Symfony\\Component\\Security\\Core\\Authentication\\Token\\TokenInterface;\nuse Symfony\\Component\\Security\\Core\\Exception\\AuthenticationException;\nuse Symfony\\Component\\Security\\Http\\Authenticator\\Passport\\Badge\\UserBadge;\nuse Symfony\\Component\\Security\\Http\\Authenticator\\Passport\\Passport;\nuse Symfony\\Component\\Security\\Http\\Authenticator\\Passport\\SelfValidatingPassport;\nuse Doctrine\\ORM\\EntityManagerInterface;\nuse SportOase\\Entity\\User;\n\nclass IServAuthenticator extends OAuth2Authenticator\n{\n    public function __construct(\n        private ClientRegistry $clientRegistry,\n        private RouterInterface $router,\n        private EntityManagerInterface $entityManager\n    ) {}\n\n    public function supports(Request $request): ?bool\n    {\n        return $request->attributes->get('_route') === 'oidc_callback';\n    }\n\n    public function authenticate(Request $request): Passport\n    {\n        $client = $this->clientRegistry->getClient('iserv');\n        $accessToken = $this->fetchAccessToken($client);\n        \n        return new SelfValidatingPassport(\n            new UserBadge($accessToken->getToken(), function() use ($accessToken, $client) {\n                $userData = $client->fetchUserFromToken($accessToken);\n                return $this->loadOrCreateUser($userData->toArray());\n            })\n        );\n    }\n\n    public function onAuthenticationSuccess(Request $request, TokenInterface $token, string $firewallName): ?Response\n    {\n        return new RedirectResponse($this->router->generate('sportoase_dashboard'));\n    }\n\n    public function onAuthenticationFailure(Request $request, AuthenticationException $exception): ?Response\n    {\n        return new RedirectResponse($this->router->generate('app_login'));\n    }\n\n    private function loadOrCreateUser(array $userData): User\n    {\n        $username = $userData['preferred_username'] ?? $userData['sub'];\n        $email = $userData['email'] ?? null;\n        $fullName = $userData['name'] ?? $username;\n        $iservRoles = $userData['roles'] ?? [];\n\n        $user = $this->entityManager\n            ->getRepository(User::class)\n            ->findOneBy(['username' => $username]);\n\n        if (!$user) {\n            $user = new User();\n            $user->setUsername($username);\n            $user->setIservId($userData['sub']);\n        }\n\n        $user->setEmail($email);\n        $user->setFullName($fullName);\n        $user->setRoles($this->mapIServRoles($iservRoles));\n        $user->setIsActive(true);\n        $user->setUpdatedAt(new \\DateTime());\n\n        $this->entityManager->persist($user);\n        $this->entityManager->flush();\n\n        return $user;\n    }\n\n    private function mapIServRoles(array $iservRoles): array\n    {\n        $roleMap = [\n            'role_admin' => 'ROLE_ADMIN',\n            'role_teacher' => 'ROLE_TEACHER',\n            'role_student' => 'ROLE_USER',\n        ];\n\n        $symfonyRoles = ['ROLE_USER'];\n        foreach ($iservRoles as $role) {\n            $roleLower = strtolower($role);\n            if (isset($roleMap[$roleLower])) {\n                $symfonyRoles[] = $roleMap[$roleLower];\n            }\n        }\n\n        return array_unique($symfonyRoles);\n    }\n}\n```\n\n## Step 5: Configure Security\n\nUpdate `config/packages/security.yaml`:\n\n```yaml\nsecurity:\n    firewalls:\n        main:\n            custom_authenticators:\n                - SportOase\\Security\\IServAuthenticator\n            entry_point: SportOase\\Security\\IServAuthenticator\n            logout:\n                path: app_logout\n                target: /\n```\n\n## Step 6: Add Routes\n\nAdd these routes to `config/routes.yaml`:\n\n```yaml\niserv_login:\n    path: /login/iserv\n    controller: SportOase\\Controller\\SecurityController::connectIServ\n\noidc_callback:\n    path: /oidc/callback\n    controller: SportOase\\Controller\\SecurityController::callback\n\napp_logout:\n    path: /logout\n```\n\n## Step 7: Create Security Controller\n\nCreate `src/Controller/SecurityController.php`:\n\n```php\n<?php\n\nnamespace SportOase\\Controller;\n\nuse KnpU\\OAuth2ClientBundle\\Client\\ClientRegistry;\nuse Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController;\nuse Symfony\\Component\\HttpFoundation\\RedirectResponse;\nuse Symfony\\Component\\Routing\\Annotation\\Route;\n\nclass SecurityController extends AbstractController\n{\n    #[Route('/login/iserv', name: 'iserv_login')]\n    public function connectIServ(ClientRegistry $clientRegistry): RedirectResponse\n    {\n        return $clientRegistry\n            ->getClient('iserv')\n            ->redirect(['openid', 'profile', 'email'], []);\n    }\n\n    #[Route('/oidc/callback', name: 'oidc_callback')]\n    public function callback(): never\n    {\n        throw new \\Exception('This should be handled by IServAuthenticator');\n    }\n\n    #[Route('/logout', name: 'app_logout')]\n    public function logout(): void\n    {\n        throw new \\LogicException('This method can be blank - it will be intercepted by the logout key on your firewall.');\n    }\n}\n```\n\n## Step 8: Update User Entity\n\nEnsure your `User` entity has these fields:\n\n```php\n#[ORM\\Column(type: 'string', length: 255, unique: true)]\nprivate string $username;\n\n#[ORM\\Column(type: 'string', length: 255, nullable: true)]\nprivate ?string $iservId = null;\n\n#[ORM\\Column(type: 'string', length: 255, nullable: true)]\nprivate ?string $email = null;\n\n#[ORM\\Column(type: 'string', length: 255, nullable: true)]\nprivate ?string $fullName = null;\n\n#[ORM\\Column(type: 'json')]\nprivate array $roles = [];\n\n#[ORM\\Column(type: 'boolean')]\nprivate bool $isActive = true;\n\n#[ORM\\Column(type: 'datetime')]\nprivate \\DateTime $updatedAt;\n```\n\n## Step 9: Create Database Migration\n\nGenerate and run the migration for the new User fields:\n\n```bash\nphp bin/console doctrine:migrations:diff\nphp bin/console doctrine:migrations:migrate\n```\n\n## Step 10: Test the Integration\n\n1. Clear Symfony cache:\n   ```bash\n   php bin/console cache:clear\n   ```\n\n2. Visit `/login/iserv` in your browser\n\n3. You should be redirected to your IServ login page\n\n4. After successful authentication, you'll be redirected back to your application's dashboard\n\n## Troubleshooting\n\n### Error: \"Invalid redirect URI\"\n- Ensure the redirect URI in IServ matches exactly: `https://your-domain/sportoase/oidc/callback`\n- Check for trailing slashes\n\n### Error: \"Invalid client credentials\"\n- Verify `ISERV_CLIENT_ID` and `ISERV_CLIENT_SECRET` in `.env`\n- Ensure environment variables are loaded\n\n### User not created after login\n- Check logs: `var/log/dev.log` or `var/log/prod.log`\n- Verify User entity has all required fields\n- Ensure database is accessible\n\n### Cannot access OpenID endpoints\n- Verify IServ base URL is correct\n- Check network connectivity between servers\n- Ensure IServ server allows connections from your application server\n\n## Production Checklist\n\n- [ ] Use HTTPS for all connections\n- [ ] Set `ISERV_CLIENT_SECRET` as environment variable (not in `.env.local`)\n- [ ] Configure proper CORS headers if needed\n- [ ] Test logout functionality (clears Symfony session + redirects to IServ logout)\n- [ ] Test with different user roles (admin, teacher, student)\n- [ ] Implement CSRF protection for OAuth state parameter\n- [ ] Set up monitoring for failed authentication attempts\n- [ ] Configure session timeout appropriately\n\n## IServ User Data Format\n\nIServ returns user data in this format:\n\n```json\n{\n  \"sub\": \"user.name\",\n  \"email\": \"user@school.de\",\n  \"name\": \"John Doe\",\n  \"preferred_username\": \"user.name\",\n  \"roles\": [\"role_teacher\", \"role_class_10a\"]\n}\n```\n\n## Support\n\nFor IServ-specific SSO questions:\n- Documentation: https://doku.iserv.de/manage/system/sso/\n- IServ Support: Contact your IServ administrator\n\nFor SportOase integration issues:\n- Email: sportoase.kg@gmail.com\n\n## Version History\n\n- **1.0.0** (2025-11-22): Initial IServ SSO integration guide\n","size_bytes":10696},"src/Service/BookingService.php":{"content":"<?php\n\nnamespace SportOase\\Service;\n\nuse SportOase\\Entity\\Booking;\nuse SportOase\\Entity\\User;\nuse Doctrine\\ORM\\EntityManagerInterface;\n\nclass BookingService\n{\n    private const PERIODS = [\n        1 => ['start' => '07:50', 'end' => '08:35'],\n        2 => ['start' => '08:35', 'end' => '09:20'],\n        3 => ['start' => '09:40', 'end' => '10:25'],\n        4 => ['start' => '10:30', 'end' => '11:15'],\n        5 => ['start' => '11:20', 'end' => '12:05'],\n        6 => ['start' => '12:10', 'end' => '12:55'],\n    ];\n\n    private const MAX_STUDENTS_PER_PERIOD = 5;\n    private const BOOKING_ADVANCE_MINUTES = 60;\n\n    public function __construct(\n        private EntityManagerInterface $entityManager\n    ) {\n    }\n\n    public function getWeekData(int $weekOffset = 0): array\n    {\n        $monday = new \\DateTime('monday this week');\n        $monday->modify('+' . $weekOffset . ' weeks');\n        \n        $weekDays = [];\n        for ($i = 0; $i < 5; $i++) {\n            $date = clone $monday;\n            $date->modify('+' . $i . ' days');\n            $weekDays[] = [\n                'date' => $date,\n                'weekday' => $date->format('l'),\n                'formatted' => $date->format('d.m.Y'),\n            ];\n        }\n        \n        return [\n            'days' => $weekDays,\n            'periods' => self::PERIODS,\n            'start_date' => $monday,\n        ];\n    }\n\n    public function createBooking(User $user, array $data): Booking\n    {\n        $date = new \\DateTime($data['date']);\n        $period = (int) $data['period'];\n        \n        $this->validateBooking($date, $period, $data);\n        \n        $booking = new Booking();\n        $booking->setDate($date);\n        $booking->setPeriod($period);\n        $booking->setWeekday($date->format('l'));\n        $booking->setTeacher($user);\n        $booking->setTeacherName($data['teacher_name']);\n        $booking->setTeacherClass($data['teacher_class']);\n        $booking->setStudentsJson(json_decode($data['students_json'], true) ?? []);\n        $booking->setOfferType($data['offer_type']);\n        $booking->setOfferLabel($data['offer_label']);\n        \n        $this->entityManager->persist($booking);\n        $this->entityManager->flush();\n        \n        return $booking;\n    }\n\n    public function updateBooking(Booking $booking, array $data): Booking\n    {\n        if (isset($data['teacher_name'])) {\n            $booking->setTeacherName($data['teacher_name']);\n        }\n        if (isset($data['teacher_class'])) {\n            $booking->setTeacherClass($data['teacher_class']);\n        }\n        if (isset($data['students_json'])) {\n            $booking->setStudentsJson(json_decode($data['students_json'], true) ?? []);\n        }\n        if (isset($data['offer_label'])) {\n            $booking->setOfferLabel($data['offer_label']);\n        }\n        \n        $booking->setUpdatedAt(new \\DateTime());\n        $this->entityManager->flush();\n        \n        return $booking;\n    }\n\n    private function validateBooking(\\DateTime $date, int $period, array $data): void\n    {\n        if ($date->format('N') >= 6) {\n            throw new \\Exception('Wochenenden können nicht gebucht werden.');\n        }\n        \n        $now = new \\DateTime();\n        $periodStart = clone $date;\n        $periodStartTime = self::PERIODS[$period]['start'];\n        $periodStart->setTime(...explode(':', $periodStartTime));\n        \n        $diffMinutes = ($periodStart->getTimestamp() - $now->getTimestamp()) / 60;\n        if ($diffMinutes < self::BOOKING_ADVANCE_MINUTES) {\n            throw new \\Exception('Buchungen müssen mindestens ' . self::BOOKING_ADVANCE_MINUTES . ' Minuten im Voraus erfolgen.');\n        }\n        \n        $existing = $this->entityManager\n            ->getRepository(Booking::class)\n            ->findOneBy(['date' => $date, 'period' => $period]);\n        \n        if ($existing) {\n            throw new \\Exception('Dieser Zeitslot ist bereits gebucht.');\n        }\n        \n        $students = json_decode($data['students_json'], true) ?? [];\n        if (count($students) > self::MAX_STUDENTS_PER_PERIOD) {\n            throw new \\Exception('Maximale Anzahl von Schülern überschritten (' . self::MAX_STUDENTS_PER_PERIOD . ').');\n        }\n        \n        $studentNames = array_column($students, 'name');\n        $this->checkDoubleBooking($studentNames, $date, $period);\n    }\n\n    private function checkDoubleBooking(array $studentNames, \\DateTime $date, int $period): void\n    {\n        $bookings = $this->entityManager\n            ->getRepository(Booking::class)\n            ->findBy(['date' => $date, 'period' => $period]);\n        \n        foreach ($bookings as $booking) {\n            $bookedStudents = array_column($booking->getStudentsJson(), 'name');\n            $duplicates = array_intersect($studentNames, $bookedStudents);\n            \n            if (!empty($duplicates)) {\n                throw new \\Exception('Schüler bereits gebucht: ' . implode(', ', $duplicates));\n            }\n        }\n    }\n}\n","size_bytes":5008},"config/routes.yaml":{"content":"sportoase:\n    resource: '../src/Controller/'\n    type: attribute\n","size_bytes":66},"src/Service/EmailService.php":{"content":"<?php\n\nnamespace SportOase\\Service;\n\nuse SportOase\\Entity\\Booking;\nuse Symfony\\Component\\Mailer\\MailerInterface;\nuse Symfony\\Component\\Mime\\Email;\n\nclass EmailService\n{\n    private const ADMIN_EMAIL = 'sportoase.kg@gmail.com';\n\n    public function __construct(\n        private MailerInterface $mailer\n    ) {\n    }\n\n    public function sendBookingNotification(Booking $booking): void\n    {\n        $email = (new Email())\n            ->from('noreply@sportoase.local')\n            ->to(self::ADMIN_EMAIL)\n            ->subject('Neue SportOase Buchung')\n            ->html($this->renderBookingEmail($booking));\n\n        try {\n            $this->mailer->send($email);\n        } catch (\\Exception $e) {\n        }\n    }\n\n    private function renderBookingEmail(Booking $booking): string\n    {\n        $students = $booking->getStudentsJson();\n        $studentList = '';\n        foreach ($students as $student) {\n            $studentList .= '<li>' . htmlspecialchars($student['name']) . ' (' . htmlspecialchars($student['class']) . ')</li>';\n        }\n\n        return <<<HTML\n        <h2>Neue SportOase Buchung</h2>\n        <p><strong>Datum:</strong> {$booking->getDate()->format('d.m.Y')}</p>\n        <p><strong>Stunde:</strong> {$booking->getPeriod()}</p>\n        <p><strong>Lehrer:</strong> {$booking->getTeacherName()} ({$booking->getTeacherClass()})</p>\n        <p><strong>Angebot:</strong> {$booking->getOfferLabel()}</p>\n        <p><strong>Schüler:</strong></p>\n        <ul>{$studentList}</ul>\n        HTML;\n    }\n}\n","size_bytes":1516},"src/Entity/Booking.php":{"content":"<?php\n\nnamespace SportOase\\Entity;\n\nuse Doctrine\\ORM\\Mapping as ORM;\nuse Doctrine\\Common\\Collections\\ArrayCollection;\nuse Doctrine\\Common\\Collections\\Collection;\n\n#[ORM\\Entity]\n#[ORM\\Table(name: 'sportoase_bookings')]\n#[ORM\\UniqueConstraint(name: 'unique_date_period', columns: ['date', 'period'])]\n#[ORM\\Index(columns: ['date', 'period'], name: 'idx_date_period')]\n#[ORM\\Index(columns: ['date'], name: 'idx_date')]\nclass Booking\n{\n    #[ORM\\Id]\n    #[ORM\\GeneratedValue]\n    #[ORM\\Column(type: 'integer')]\n    private ?int $id = null;\n\n    #[ORM\\Column(type: 'date')]\n    private \\DateTime $date;\n\n    #[ORM\\Column(type: 'integer')]\n    private int $period;\n\n    #[ORM\\Column(type: 'string', length: 20)]\n    private string $weekday;\n\n    #[ORM\\ManyToOne(targetEntity: User::class, inversedBy: 'bookings')]\n    #[ORM\\JoinColumn(nullable: false, onDelete: 'CASCADE')]\n    private User $teacher;\n\n    #[ORM\\Column(type: 'string', length: 255)]\n    private string $teacherName;\n\n    #[ORM\\Column(type: 'string', length: 255)]\n    private string $teacherClass;\n\n    #[ORM\\Column(type: 'json')]\n    private array $studentsJson = [];\n\n    #[ORM\\Column(type: 'string', length: 100)]\n    private string $offerType;\n\n    #[ORM\\Column(type: 'string', length: 255)]\n    private string $offerLabel;\n\n    #[ORM\\Column(type: 'string', length: 255, nullable: true)]\n    private ?string $calendarEventId = null;\n\n    #[ORM\\Column(type: 'datetime')]\n    private \\DateTime $createdAt;\n\n    #[ORM\\Column(type: 'datetime')]\n    private \\DateTime $updatedAt;\n\n    #[ORM\\OneToMany(targetEntity: Notification::class, mappedBy: 'booking', cascade: ['remove'], orphanRemoval: true)]\n    private Collection $notifications;\n\n    public function __construct()\n    {\n        $this->notifications = new ArrayCollection();\n        $this->createdAt = new \\DateTime();\n        $this->updatedAt = new \\DateTime();\n    }\n\n    public function getId(): ?int\n    {\n        return $this->id;\n    }\n\n    public function getDate(): \\DateTime\n    {\n        return $this->date;\n    }\n\n    public function setDate(\\DateTime $date): self\n    {\n        $this->date = $date;\n        return $this;\n    }\n\n    public function getPeriod(): int\n    {\n        return $this->period;\n    }\n\n    public function setPeriod(int $period): self\n    {\n        $this->period = $period;\n        return $this;\n    }\n\n    public function getWeekday(): string\n    {\n        return $this->weekday;\n    }\n\n    public function setWeekday(string $weekday): self\n    {\n        $this->weekday = $weekday;\n        return $this;\n    }\n\n    public function getTeacher(): User\n    {\n        return $this->teacher;\n    }\n\n    public function setTeacher(User $teacher): self\n    {\n        $this->teacher = $teacher;\n        return $this;\n    }\n\n    public function getTeacherName(): string\n    {\n        return $this->teacherName;\n    }\n\n    public function setTeacherName(string $teacherName): self\n    {\n        $this->teacherName = $teacherName;\n        return $this;\n    }\n\n    public function getTeacherClass(): string\n    {\n        return $this->teacherClass;\n    }\n\n    public function setTeacherClass(string $teacherClass): self\n    {\n        $this->teacherClass = $teacherClass;\n        return $this;\n    }\n\n    public function getStudentsJson(): array\n    {\n        return $this->studentsJson;\n    }\n\n    public function setStudentsJson(array $studentsJson): self\n    {\n        $this->studentsJson = $studentsJson;\n        return $this;\n    }\n\n    public function getOfferType(): string\n    {\n        return $this->offerType;\n    }\n\n    public function setOfferType(string $offerType): self\n    {\n        $this->offerType = $offerType;\n        return $this;\n    }\n\n    public function getOfferLabel(): string\n    {\n        return $this->offerLabel;\n    }\n\n    public function setOfferLabel(string $offerLabel): self\n    {\n        $this->offerLabel = $offerLabel;\n        return $this;\n    }\n\n    public function getCalendarEventId(): ?string\n    {\n        return $this->calendarEventId;\n    }\n\n    public function setCalendarEventId(?string $calendarEventId): self\n    {\n        $this->calendarEventId = $calendarEventId;\n        return $this;\n    }\n\n    public function getCreatedAt(): \\DateTime\n    {\n        return $this->createdAt;\n    }\n\n    public function getUpdatedAt(): \\DateTime\n    {\n        return $this->updatedAt;\n    }\n\n    public function setUpdatedAt(\\DateTime $updatedAt): self\n    {\n        $this->updatedAt = $updatedAt;\n        return $this;\n    }\n\n    public function getNotifications(): Collection\n    {\n        return $this->notifications;\n    }\n}\n","size_bytes":4606},"src/Entity/Notification.php":{"content":"<?php\n\nnamespace SportOase\\Entity;\n\nuse Doctrine\\ORM\\Mapping as ORM;\n\n#[ORM\\Entity]\n#[ORM\\Table(name: 'sportoase_notifications')]\n#[ORM\\Index(columns: ['created_at'], name: 'idx_created_at')]\n#[ORM\\Index(columns: ['is_read'], name: 'idx_is_read')]\nclass Notification\n{\n    #[ORM\\Id]\n    #[ORM\\GeneratedValue]\n    #[ORM\\Column(type: 'integer')]\n    private ?int $id = null;\n\n    #[ORM\\ManyToOne(targetEntity: Booking::class, inversedBy: 'notifications')]\n    #[ORM\\JoinColumn(nullable: false, onDelete: 'CASCADE')]\n    private Booking $booking;\n\n    #[ORM\\Column(type: 'string', length: 50)]\n    private string $recipientRole = 'admin';\n\n    #[ORM\\Column(type: 'string', length: 100)]\n    private string $notificationType;\n\n    #[ORM\\Column(type: 'text')]\n    private string $message;\n\n    #[ORM\\Column(type: 'json', nullable: true)]\n    private ?array $metadataJson = null;\n\n    #[ORM\\Column(type: 'boolean')]\n    private bool $isRead = false;\n\n    #[ORM\\Column(type: 'datetime', nullable: true)]\n    private ?\\DateTime $readAt = null;\n\n    #[ORM\\Column(type: 'datetime')]\n    private \\DateTime $createdAt;\n\n    public function __construct()\n    {\n        $this->createdAt = new \\DateTime();\n    }\n\n    public function getId(): ?int\n    {\n        return $this->id;\n    }\n\n    public function getBooking(): Booking\n    {\n        return $this->booking;\n    }\n\n    public function setBooking(Booking $booking): self\n    {\n        $this->booking = $booking;\n        return $this;\n    }\n\n    public function getRecipientRole(): string\n    {\n        return $this->recipientRole;\n    }\n\n    public function setRecipientRole(string $recipientRole): self\n    {\n        $this->recipientRole = $recipientRole;\n        return $this;\n    }\n\n    public function getNotificationType(): string\n    {\n        return $this->notificationType;\n    }\n\n    public function setNotificationType(string $notificationType): self\n    {\n        $this->notificationType = $notificationType;\n        return $this;\n    }\n\n    public function getMessage(): string\n    {\n        return $this->message;\n    }\n\n    public function setMessage(string $message): self\n    {\n        $this->message = $message;\n        return $this;\n    }\n\n    public function getMetadataJson(): ?array\n    {\n        return $this->metadataJson;\n    }\n\n    public function setMetadataJson(?array $metadataJson): self\n    {\n        $this->metadataJson = $metadataJson;\n        return $this;\n    }\n\n    public function isRead(): bool\n    {\n        return $this->isRead;\n    }\n\n    public function setIsRead(bool $isRead): self\n    {\n        $this->isRead = $isRead;\n        return $this;\n    }\n\n    public function getReadAt(): ?\\DateTime\n    {\n        return $this->readAt;\n    }\n\n    public function setReadAt(?\\DateTime $readAt): self\n    {\n        $this->readAt = $readAt;\n        return $this;\n    }\n\n    public function getCreatedAt(): \\DateTime\n    {\n        return $this->createdAt;\n    }\n}\n","size_bytes":2939},"index.php":{"content":"<?php\nheader('Content-Type: text/html; charset=utf-8');\n?>\n<!DOCTYPE html>\n<html lang=\"de\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>SportOase - IServ Module</title>\n    <style>\n        body { font-family: Arial, sans-serif; max-width: 900px; margin: 50px auto; padding: 20px; background: #f5f5f5; }\n        .container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }\n        h1 { color: #333; border-bottom: 3px solid #007bff; padding-bottom: 10px; }\n        h2 { color: #666; margin-top: 30px; }\n        .info-box { background: #e7f3ff; padding: 15px; border-left: 4px solid #007bff; margin: 20px 0; }\n        .warning-box { background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0; }\n        pre { background: #f4f4f4; padding: 15px; border-radius: 4px; overflow-x: auto; }\n        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }\n        ul { line-height: 1.8; }\n        .file-structure { font-family: monospace; font-size: 14px; }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1>🏫 SportOase - IServ Module</h1>\n        \n        <div class=\"warning-box\">\n            <strong>⚠️ Important:</strong> This is an IServ module built with PHP/Symfony, not a standalone Replit application. \n            It must be packaged as a Debian package and deployed to an IServ server.\n        </div>\n        \n        <div class=\"info-box\">\n            <strong>ℹ️ Module Information:</strong>\n            <ul>\n                <li><strong>Version:</strong> 1.0.0</li>\n                <li><strong>Framework:</strong> Symfony 6.4+</li>\n                <li><strong>Database:</strong> PostgreSQL (Doctrine ORM)</li>\n                <li><strong>IServ Compatibility:</strong> 3.0+</li>\n            </ul>\n        </div>\n        \n        <h2>📦 Module Structure</h2>\n        <div class=\"file-structure\">\n            <pre>sportoase/\n├── composer.json              # PHP dependencies\n├── manifest.xml               # IServ module manifest\n├── src/\n│   ├── SportOaseBundle.php    # Main bundle class\n│   ├── Controller/            # Symfony controllers\n│   │   ├── DashboardController.php\n│   │   ├── BookingController.php\n│   │   └── AdminController.php\n│   ├── Entity/                # Doctrine entities\n│   │   ├── User.php\n│   │   ├── Booking.php\n│   │   ├── SlotName.php\n│   │   ├── BlockedSlot.php\n│   │   └── Notification.php\n│   └── Service/               # Business logic\n│       ├── BookingService.php\n│       └── EmailService.php\n├── migrations/                # Doctrine migrations\n├── templates/                 # Twig templates\n├── config/                    # Symfony configuration\n└── README.md</pre>\n        </div>\n        \n        <h2>🚀 Deployment to IServ</h2>\n        <ol>\n            <li>\n                <strong>Package as Debian Package:</strong>\n                <pre>dpkg-buildpackage -us -uc</pre>\n            </li>\n            <li>\n                <strong>Install on IServ Server:</strong>\n                <pre>aptitude install iserv3-sportoase</pre>\n            </li>\n            <li>\n                <strong>Run Database Migrations:</strong>\n                <pre>php bin/console doctrine:migrations:migrate</pre>\n            </li>\n            <li>\n                <strong>Enable Module:</strong> Via IServ Admin Panel → System → Modules\n            </li>\n        </ol>\n        \n        <h2>✨ Features</h2>\n        <ul>\n            <li>IServ SSO Integration</li>\n            <li>Role-based Access Control (Teachers & Admins)</li>\n            <li>Weekly Schedule Management</li>\n            <li>Capacity Management (max 5 students per slot)</li>\n            <li>Double-booking Prevention</li>\n            <li>Email Notifications</li>\n            <li>Admin Panel for Booking Management</li>\n        </ul>\n        \n        <h2>📚 Documentation</h2>\n        <p>See <code>README.md</code> for complete documentation.</p>\n        \n        <h2>🔧 Development</h2>\n        <p>For local development outside IServ:</p>\n        <pre>composer install\nphp bin/console doctrine:migrations:migrate\nsymfony serve</pre>\n        \n        <div class=\"info-box\">\n            <strong>📧 Support:</strong> sportoase.kg@gmail.com\n        </div>\n    </div>\n</body>\n</html>\n","size_bytes":4541},"src/IServAuthenticator.php":{"content":"<?php\n\nnamespace App;\n\nuse Supabase\\Client as SupabaseClient;\n\nclass IServAuthenticator\n{\n    private SupabaseClient $supabase;\n    private string $apiKey;\n\n    public function __construct(SupabaseClient $supabase, string $apiKey)\n    {\n        $this->supabase = $supabase;\n        $this->apiKey = $apiKey;\n    }\n\n    public function authenticateFromIServ(array $iservUser): array\n    {\n        $username = $iservUser['username'] ?? null;\n        $iservId = $iservUser['id'] ?? null;\n        $email = $iservUser['email'] ?? null;\n        $role = $iservUser['role'] ?? 'teacher';\n        $fullName = $iservUser['full_name'] ?? $username;\n\n        if (!$username || !$iservId) {\n            throw new \\InvalidArgumentException('Missing IServ username or ID');\n        }\n\n        $userData = $this->syncUserWithSupabase($username, $iservId, $email, $role, $fullName);\n\n        return [\n            'success' => true,\n            'user' => $userData,\n            'token' => $this->generateSessionToken($userData['id']),\n        ];\n    }\n\n    private function syncUserWithSupabase(\n        string $username,\n        int $iservId,\n        ?string $email,\n        string $role,\n        string $fullName\n    ): array {\n        try {\n            $existingUser = $this->supabase\n                ->from('sportoase_users')\n                ->select('*')\n                ->eq('iserv_username', $username)\n                ->maybeSingle()\n                ->execute();\n\n            if ($existingUser->data) {\n                $this->supabase\n                    ->from('sportoase_users')\n                    ->update([\n                        'iserv_id' => $iservId,\n                        'email' => $email,\n                        'role' => $role,\n                        'full_name' => $fullName,\n                        'is_active' => true,\n                        'updated_at' => date('c'),\n                    ])\n                    ->eq('id', $existingUser->data['id'])\n                    ->execute();\n\n                return $existingUser->data;\n            } else {\n                $newUser = $this->supabase\n                    ->from('sportoase_users')\n                    ->insert([\n                        'iserv_username' => $username,\n                        'iserv_id' => $iservId,\n                        'email' => $email,\n                        'role' => $role,\n                        'full_name' => $fullName,\n                        'is_active' => true,\n                        'created_at' => date('c'),\n                    ])\n                    ->execute();\n\n                return $newUser->data[0] ?? null;\n            }\n        } catch (\\Exception $e) {\n            error_log(\"Error syncing user with Supabase: {$e->getMessage()}\");\n            throw $e;\n        }\n    }\n\n    private function generateSessionToken(string $userId): string\n    {\n        return bin2hex(random_bytes(32));\n    }\n\n    public function validateRequest(string $token, array &$user): bool\n    {\n        $iservAuth = $_SERVER['HTTP_X_ISERV_AUTH'] ?? null;\n\n        if (!$iservAuth) {\n            return false;\n        }\n\n        try {\n            $userInfo = $this->parseIServAuth($iservAuth);\n            $user = $userInfo;\n            return true;\n        } catch (\\Exception $e) {\n            error_log(\"Invalid IServ auth: {$e->getMessage()}\");\n            return false;\n        }\n    }\n\n    private function parseIServAuth(string $auth): array\n    {\n        $parts = explode('|', $auth);\n        if (count($parts) < 3) {\n            throw new \\InvalidArgumentException('Invalid IServ auth format');\n        }\n\n        return [\n            'id' => (int) $parts[0],\n            'username' => $parts[1],\n            'role' => $parts[2] ?? 'teacher',\n        ];\n    }\n}\n","size_bytes":3758},"src/Controller/AdminController.php":{"content":"<?php\n\nnamespace SportOase\\Controller;\n\nuse SportOase\\Entity\\Booking;\nuse SportOase\\Entity\\BlockedSlot;\nuse SportOase\\Entity\\SlotName;\nuse SportOase\\Entity\\User;\nuse SportOase\\Service\\BookingService;\nuse Doctrine\\ORM\\EntityManagerInterface;\nuse Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController;\nuse Symfony\\Component\\HttpFoundation\\Request;\nuse Symfony\\Component\\HttpFoundation\\Response;\nuse Symfony\\Component\\Routing\\Annotation\\Route;\nuse Symfony\\Component\\Security\\Http\\Attribute\\IsGranted;\n\n#[Route('/sportoase/admin')]\n#[IsGranted('ROLE_ADMIN')]\nclass AdminController extends AbstractController\n{\n    public function __construct(\n        private EntityManagerInterface $entityManager,\n        private BookingService $bookingService\n    ) {\n    }\n\n    #[Route('/', name: 'sportoase_admin_dashboard', methods: ['GET'])]\n    public function dashboard(): Response\n    {\n        $users = $this->entityManager\n            ->getRepository(User::class)\n            ->findAll();\n        \n        $bookings = $this->entityManager\n            ->getRepository(Booking::class)\n            ->findBy([], ['date' => 'DESC', 'period' => 'ASC']);\n        \n        return $this->render('@SportOase/admin/dashboard.html.twig', [\n            'users' => $users,\n            'bookings' => $bookings,\n        ]);\n    }\n\n    #[Route('/booking/{id}/edit', name: 'sportoase_admin_booking_edit', methods: ['GET', 'POST'])]\n    public function editBooking(Request $request, Booking $booking): Response\n    {\n        if ($request->isMethod('POST')) {\n            try {\n                $this->bookingService->updateBooking($booking, $request->request->all());\n                \n                $this->addFlash('success', 'Buchung erfolgreich aktualisiert!');\n                return $this->redirectToRoute('sportoase_admin_dashboard');\n            } catch (\\Exception $e) {\n                $this->addFlash('error', $e->getMessage());\n            }\n        }\n        \n        return $this->render('@SportOase/admin/edit_booking.html.twig', [\n            'booking' => $booking,\n        ]);\n    }\n\n    #[Route('/slots/manage', name: 'sportoase_admin_manage_slots', methods: ['GET', 'POST'])]\n    public function manageSlots(Request $request): Response\n    {\n        if ($request->isMethod('POST')) {\n            $action = $request->request->get('action');\n            \n            if ($action === 'add_slot_name') {\n                $slotName = new SlotName();\n                $slotName->setWeekday($request->request->get('weekday'));\n                $slotName->setPeriod((int) $request->request->get('period'));\n                $slotName->setLabel($request->request->get('label'));\n                \n                $this->entityManager->persist($slotName);\n                $this->entityManager->flush();\n                \n                $this->addFlash('success', 'Slot-Name erfolgreich hinzugefügt!');\n            } elseif ($action === 'block_slot') {\n                $blockedSlot = new BlockedSlot();\n                $blockedSlot->setDate(new \\DateTime($request->request->get('date')));\n                $blockedSlot->setPeriod((int) $request->request->get('period'));\n                $blockedSlot->setWeekday($request->request->get('weekday'));\n                $blockedSlot->setReason($request->request->get('reason', 'Beratung'));\n                $blockedSlot->setBlockedBy($this->getUser());\n                \n                $this->entityManager->persist($blockedSlot);\n                $this->entityManager->flush();\n                \n                $this->addFlash('success', 'Slot erfolgreich blockiert!');\n            }\n            \n            return $this->redirectToRoute('sportoase_admin_manage_slots');\n        }\n        \n        $slotNames = $this->entityManager\n            ->getRepository(SlotName::class)\n            ->findAll();\n        \n        $blockedSlots = $this->entityManager\n            ->getRepository(BlockedSlot::class)\n            ->findAll();\n        \n        return $this->render('@SportOase/admin/manage_slots.html.twig', [\n            'slot_names' => $slotNames,\n            'blocked_slots' => $blockedSlots,\n        ]);\n    }\n}\n","size_bytes":4143},"src/ApiController.php":{"content":"<?php\n\nnamespace App;\n\nclass ApiController\n{\n    private BookingService $bookingService;\n    private IServAuthenticator $authenticator;\n    private array $user;\n\n    public function __construct(BookingService $bookingService, IServAuthenticator $authenticator)\n    {\n        $this->bookingService = $bookingService;\n        $this->authenticator = $authenticator;\n    }\n\n    private function requireAuth(): void\n    {\n        if (!$this->authenticator->validateRequest('', $this->user)) {\n            http_response_code(401);\n            echo json_encode(['error' => 'Unauthorized']);\n            exit;\n        }\n    }\n\n    private function requireAdmin(): void\n    {\n        $this->requireAuth();\n        if ($this->user['role'] !== 'admin') {\n            http_response_code(403);\n            echo json_encode(['error' => 'Forbidden']);\n            exit;\n        }\n    }\n\n    private function json(array $data, int $statusCode = 200): void\n    {\n        http_response_code($statusCode);\n        header('Content-Type: application/json');\n        echo json_encode($data);\n        exit;\n    }\n\n    public function getSchedule(): void\n    {\n        $this->requireAuth();\n\n        try {\n            $schedule = $this->bookingService->getWeeklySchedule();\n            $this->json($schedule);\n        } catch (\\Exception $e) {\n            $this->json(['error' => $e->getMessage()], 400);\n        }\n    }\n\n    public function listBookings(): void\n    {\n        $this->requireAuth();\n\n        try {\n            $supabase = $GLOBALS['supabase'];\n            $bookings = $supabase\n                ->from('sportoase_bookings')\n                ->select('*')\n                ->eq('teacher_id', $this->user['id'])\n                ->order('date', 'desc')\n                ->execute()\n                ->data ?? [];\n\n            $this->json(['bookings' => $bookings]);\n        } catch (\\Exception $e) {\n            $this->json(['error' => $e->getMessage()], 400);\n        }\n    }\n\n    public function createBooking(): void\n    {\n        $this->requireAuth();\n\n        try {\n            $data = json_decode(file_get_contents('php://input'), true);\n\n            $booking = $this->bookingService->createBooking(\n                $this->user['id'],\n                $data['date'],\n                $data['period'],\n                $data['teacher_name'],\n                $data['teacher_class'],\n                $data['students'],\n                $data['offer_label']\n            );\n\n            $this->json(['booking' => $booking], 201);\n        } catch (\\Exception $e) {\n            $this->json(['error' => $e->getMessage()], 400);\n        }\n    }\n\n    public function deleteBooking(): void\n    {\n        $this->requireAuth();\n\n        try {\n            $bookingId = $_GET['id'] ?? null;\n            if (!$bookingId) {\n                throw new \\Exception('Booking ID required');\n            }\n\n            $this->bookingService->deleteBooking($bookingId, $this->user['id']);\n            $this->json(['success' => true]);\n        } catch (\\Exception $e) {\n            $this->json(['error' => $e->getMessage()], 400);\n        }\n    }\n\n    public function blockSlot(): void\n    {\n        $this->requireAdmin();\n\n        try {\n            $data = json_decode(file_get_contents('php://input'), true);\n            $supabase = $GLOBALS['supabase'];\n\n            $blockDate = new \\DateTime($data['date'], new \\DateTimeZone('Europe/Berlin'));\n            $weekday = $blockDate->format('a');\n\n            $supabase\n                ->from('sportoase_blocked_slots')\n                ->insert([\n                    'date' => $data['date'],\n                    'period' => $data['period'],\n                    'weekday' => $weekday,\n                    'reason' => $data['reason'] ?? 'Beratung',\n                    'blocked_by_id' => $this->user['id'],\n                    'created_at' => date('c'),\n                ])\n                ->execute();\n\n            $this->json(['success' => true], 201);\n        } catch (\\Exception $e) {\n            $this->json(['error' => $e->getMessage()], 400);\n        }\n    }\n\n    public function unblockSlot(): void\n    {\n        $this->requireAdmin();\n\n        try {\n            $date = $_GET['date'] ?? null;\n            $period = $_GET['period'] ?? null;\n\n            if (!$date || !$period) {\n                throw new \\Exception('Date and period required');\n            }\n\n            $supabase = $GLOBALS['supabase'];\n            $supabase\n                ->from('sportoase_blocked_slots')\n                ->delete()\n                ->eq('date', $date)\n                ->eq('period', $period)\n                ->execute();\n\n            $this->json(['success' => true]);\n        } catch (\\Exception $e) {\n            $this->json(['error' => $e->getMessage()], 400);\n        }\n    }\n}\n","size_bytes":4786},"src/Entity/User.php":{"content":"<?php\n\nnamespace SportOase\\Entity;\n\nuse Doctrine\\ORM\\Mapping as ORM;\nuse Doctrine\\Common\\Collections\\ArrayCollection;\nuse Doctrine\\Common\\Collections\\Collection;\n\n#[ORM\\Entity]\n#[ORM\\Table(name: 'sportoase_users')]\nclass User\n{\n    #[ORM\\Id]\n    #[ORM\\GeneratedValue]\n    #[ORM\\Column(type: 'integer')]\n    private ?int $id = null;\n\n    #[ORM\\Column(type: 'string', length: 255, unique: true)]\n    private string $username;\n\n    #[ORM\\Column(type: 'string', length: 255, unique: true, nullable: true)]\n    private ?string $email = null;\n\n    #[ORM\\Column(type: 'string', length: 255, nullable: true)]\n    private ?string $fullName = null;\n\n    #[ORM\\Column(type: 'string', length: 50)]\n    private string $role = 'teacher';\n\n    #[ORM\\Column(type: 'boolean')]\n    private bool $isActive = true;\n\n    #[ORM\\Column(type: 'datetime')]\n    private \\DateTime $createdAt;\n\n    #[ORM\\Column(type: 'datetime')]\n    private \\DateTime $updatedAt;\n\n    #[ORM\\OneToMany(targetEntity: Booking::class, mappedBy: 'teacher', cascade: ['remove'])]\n    private Collection $bookings;\n\n    #[ORM\\OneToMany(targetEntity: BlockedSlot::class, mappedBy: 'blockedBy', cascade: ['remove'])]\n    private Collection $blockedSlots;\n\n    public function __construct()\n    {\n        $this->bookings = new ArrayCollection();\n        $this->blockedSlots = new ArrayCollection();\n        $this->createdAt = new \\DateTime();\n        $this->updatedAt = new \\DateTime();\n    }\n\n    public function getId(): ?int\n    {\n        return $this->id;\n    }\n\n    public function getUsername(): string\n    {\n        return $this->username;\n    }\n\n    public function setUsername(string $username): self\n    {\n        $this->username = $username;\n        return $this;\n    }\n\n    public function getEmail(): ?string\n    {\n        return $this->email;\n    }\n\n    public function setEmail(?string $email): self\n    {\n        $this->email = $email;\n        return $this;\n    }\n\n    public function getFullName(): ?string\n    {\n        return $this->fullName;\n    }\n\n    public function setFullName(?string $fullName): self\n    {\n        $this->fullName = $fullName;\n        return $this;\n    }\n\n    public function getRole(): string\n    {\n        return $this->role;\n    }\n\n    public function setRole(string $role): self\n    {\n        $this->role = $role;\n        return $this;\n    }\n\n    public function isActive(): bool\n    {\n        return $this->isActive;\n    }\n\n    public function setIsActive(bool $isActive): self\n    {\n        $this->isActive = $isActive;\n        return $this;\n    }\n\n    public function getCreatedAt(): \\DateTime\n    {\n        return $this->createdAt;\n    }\n\n    public function getUpdatedAt(): \\DateTime\n    {\n        return $this->updatedAt;\n    }\n\n    public function setUpdatedAt(\\DateTime $updatedAt): self\n    {\n        $this->updatedAt = $updatedAt;\n        return $this;\n    }\n\n    public function getBookings(): Collection\n    {\n        return $this->bookings;\n    }\n\n    public function getBlockedSlots(): Collection\n    {\n        return $this->blockedSlots;\n    }\n\n    public function isAdmin(): bool\n    {\n        return $this->role === 'admin';\n    }\n\n    public function hasRole(string $role): bool\n    {\n        return $this->role === $role;\n    }\n}\n\n","size_bytes":3243},"config/services.yaml":{"content":"services:\n    _defaults:\n        autowire: true\n        autoconfigure: true\n        public: false\n\n    SportOase\\:\n        resource: '../src/*'\n        exclude:\n            - '../src/Entity/'\n            - '../src/SportOaseBundle.php'\n\n    SportOase\\Controller\\:\n        resource: '../src/Controller/'\n        tags: ['controller.service_arguments']\n\n    SportOase\\Service\\:\n        resource: '../src/Service/'\n","size_bytes":410}},"version":2}